{"version":3,"sources":["meteor://💻app/packages/rocketchat_ui-message/client/popup/messagePopup.coffee","meteor://💻app/client/popup/messagePopup.coffee.js","meteor://💻app/packages/rocketchat:ui-message/client/popup/messagePopupChannel.js","meteor://💻app/packages/rocketchat_ui-message/client/popup/messagePopupConfig.coffee","meteor://💻app/client/popup/messagePopupConfig.coffee.js","meteor://💻app/packages/rocketchat_ui-message/client/popup/messagePopupEmoji.coffee","meteor://💻app/packages/rocketchat_ui-message/client/message.coffee","meteor://💻app/client/message.coffee.js","meteor://💻app/packages/rocketchat_ui-message/client/messageBox.coffee","meteor://💻app/client/messageBox.coffee.js","meteor://💻app/packages/rocketchat:ui-message/client/renderMessageBody.js"],"names":["getCursorPosition","keys","setCursorPosition","val","TAB","ENTER","ESC","ARROW_LEFT","ARROW_UP","ARROW_RIGHT","ARROW_DOWN","input","sel","selLen","selectionStart","document","selection","focus","createRange","text","length","moveStart","value","caretPos","range","setSelectionRange","createTextRange","move","select","v","d","Template","messagePopup","onCreated","template","textFilter","ReactiveVar","textFilterDelay","data","open","hasData","trigger","triggerAnywhere","closeOnEsc","blurOnSelectItem","prefix","suffix","matchSelectorRegex","RegExp","selectorRegex","replaceRegex","getValue","_id","up","_this","current","previous","find","$","prev","className","replace","set","getAttribute","down","next","classList","contains","verifySelection","first","onInputKeydown","event","ref","curValue","which","blur","enterValue","cleanOnEnter","preventDefault","stopPropagation","setTextFilter","_","debounce","onInputKeyup","substr","test","match","Meteor","defer","onFocus","clickingItem","onBlur","caret","firstPartValue","lastPartValue","collection","records","get","Tracker","autorun","filter","filterCallback","result","findOne","count","getFilter","onRendered","base","getInput","parentTemplate","console","error","on","bind","onDestroyed","off","events","e","currentTarget","indexOf","instance","toolbarSearch","clear","helpers","isOpen","emptyTemplate","subscriptionsReady","messagePopupChannel","icon","RocketChat","roomTypes","getIcon","t","getRoomsFromServer","getRoomsFromServerDelayed","getUsersFromServer","getUsersFromServerDelayed","filteredUsersMemory","Mongo","Collection","startup","messageUsers","uniqueMessageUsersControl","user","Session","remove","models","Messages","rid","$ne","username","fields","ts","sort","fetch","forEach","messageUser","u","upsert","name","status","cb","pluck","call","users","err","results","i","len","push","sortBy","rooms","room","throttle","messagePopupConfig","popupUserConfig","config","self","title","all","exp","here","items","escape","$exists","$or","limit","trim","$and","$nin","concat","item","system","compatibility","popupChannelConfig","Subscriptions","$in","ls","findWhere","popupSlashCommandsConfig","slashCommands","commands","command","params","TAPi18n","__","description","a","b","slice","emojiEnabled","emoji","popupEmojiConfig","list","key","regExp","packages","emojione","asciiList","messagePopupEmoji","moment","module","import","l","message","encodeURI","isBot","bot","roleTags","ref1","ref2","ref3","ref4","ref5","ref6","roles","settings","preferences","hideRoles","union","UserRoles","RoomRoles","Roles","isGroupable","groupable","isSequential","avatarFromUsername","avatar","getEmoji","renderEmoji","getName","alias","showUsername","own","userId","timestamp","chatops","time","format","date","isTemp","temp","body","returnClass","MessageTypes","isSystemMessage","showTranslated","language","subscription","autoTranslate","autoTranslateLanguage","AutoTranslate","getLanguage","autoTranslateFetching","autoTranslateShowInverse","translations","edited","wasEdited","editTime","editedAt","editedBy","canEdit","blockEditInMinutes","currentTsDiff","editOwn","hasPermission","isEditAllowed","msgTs","authz","hasAtLeastOnePermission","diff","canDelete","blockDeleteInMinutes","deleteOwn","isDeleteAllowed","showEditedStatus","label","i18nLabel","hasOembed","urls","oembedBaseWidget","split","map","reactions","msgReactions","reaction","total","userUsername","usernames","join","toLowerCase","toUpperCase","userReacted","markUserReaction","hideReactions","isEmpty","actionLinks","actionLink","extend","id","omit","hideActionLinks","injectIndex","index","hideCog","hideUsernames","prefs","msgType","chartData","msg","currentData","JSON","stringify","getType","messageType","render","html","callbacks","run","renderMessageBody","Markdown","parse","onViewRendered","context","view","_domrange","onAttached","domRange","$currentNode","$nextNode","currentDataset","currentMessageDate","currentNode","newMessage","nextDataset","nextNode","previousDataset","previousMessageDate","previousNode","templateInstance","lastNode","dataset","previousElementSibling","nextElementSibling","addClass","removeClass","Date","parseInt","toDateString","hasClass","Blaze","getView","atBottom","firstNode","toastr","mime","VRecDialog","ChartDialog","firefoxPasteUpload","katexSyntax","katex","katex_enabled","dollar_syntax_enabled","parenthesis_syntax_enabled","messageBox","roomName","roomData","ChatSubscription","showMarkdown","showMarkdownCode","MarkdownCode","showKatex","showFormattingTips","canJoin","verifyShowJoinLink","joinCodeRequired","subscribed","verifyCanSendMessage","allowedToSend","readOnly","archived","blocked","blocker","isBlockedOrBlocker","getPopupConfig","usersTyping","last","MsgTyping","multi","selfTyping","pop","groupAttachHidden","fileUploadEnabled","fileUploadAllowedMediaTypes","showFileUpload","showMic","showMicButton","showVRec","showVideoRec","showChart","showChartButton","showSend","isMessageFieldEmpty","showLocation","Geolocation","notSubscribedTpl","getNotSubscribedTpl","showSandstorm","sandstorm","isCordova","anonymousRead","anonymousWrite","fn","navigator","userAgent","contentEditableDiv","selectionEnd","textarea","originalEvent","ctrlKey","metaKey","keyCode","setTimeout","endContent","imageSrc","pastedImg","restoreSelection","startContent","textareaContent","querySelector","substring","pastedText","innerHTML","querySelectorAll","el","replaceChild","Text","innerText","then","img","blob","fileUpload","file","apply","arguments","reason","hasAllPermission","RoomHistoryManager","getRoom","loaded","RoomManager","getOpenedRoomByRid","streamActive","ready","computation","invalidate","loginData","token","loginWithToken","KonchatNotification","removeRoomNotification","chatMessages","send","updateAutogrow","keyup","files","clipboardData","kind","type","getAsFile","keydown","valueChanged","propertyName","clearEditing","filesToUpload","target","dataTransfer","Object","defineProperty","lookup","log","toggleClass","latitude","longitude","position","roomId","coords","swal","showCancelButton","closeOnConfirm","closeOnCancel","isConfirm","Random","location","coordinates","AudioRecorder","start","opened","close","stop","Sandstorm","request","descriptor","viewInfo","url","sandstormViewInfo","videoEnabled","videoRegex","wavEnabled","wavRegex","getUserMedia","webkitGetUserMedia","options","success","geolocation","getCurrentPosition","enableHighAccuracy","maximumAge","timeout","watchPosition","escapeHTML","tokens"],"mappings":"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","file":"/packages/rocketchat_ui-message.js","sourcesContent":["# This is not supposed to be a complete list\n# it is just to improve readability in this file\nkeys = {\n\tTAB: 9\n\tENTER: 13\n\tESC: 27\n\tARROW_LEFT: 37\n\tARROW_UP: 38\n\tARROW_RIGHT: 39\n\tARROW_DOWN: 40\n}\n\ngetCursorPosition = (input) ->\n\tif not input? then return\n\tif input.selectionStart?\n\t\treturn input.selectionStart\n\telse if document.selection?\n\t\tinput.focus()\n\t\tsel = document.selection.createRange()\n\t\tselLen = document.selection.createRange().text.length\n\t\tsel.moveStart('character', - input.value.length)\n\t\treturn sel.text.length - selLen\n\nsetCursorPosition = (input, caretPos) ->\n\tif not input? then return\n\tif input.selectionStart?\n\t\tinput.focus()\n\t\treturn input.setSelectionRange(caretPos, caretPos)\n\telse if document.selection?\n\t\trange = input.createTextRange()\n\t\trange.move('character', caretPos)\n\t\trange.select()\n\nval = (v, d) ->\n\treturn if v? then v else d\n\nTemplate.messagePopup.onCreated ->\n\ttemplate = this\n\n\ttemplate.textFilter = new ReactiveVar ''\n\n\ttemplate.textFilterDelay = val(template.data.textFilterDelay, 0)\n\n\ttemplate.open = val(template.data.open, new ReactiveVar(false))\n\n\ttemplate.hasData = new ReactiveVar false\n\n\ttemplate.value = new ReactiveVar\n\n\ttemplate.trigger = val(template.data.trigger, '')\n\n\ttemplate.triggerAnywhere = val(template.data.triggerAnywhere, true)\n\n\ttemplate.closeOnEsc = val(template.data.closeOnEsc, true)\n\n\ttemplate.blurOnSelectItem = val(template.data.blurOnSelectItem, false)\n\n\ttemplate.prefix = val(template.data.prefix, template.trigger)\n\n\ttemplate.suffix = val(template.data.suffix, '')\n\n\tif template.triggerAnywhere is true\n\t\ttemplate.matchSelectorRegex = val(template.data.matchSelectorRegex, new RegExp \"(?:^| )#{template.trigger}[^\\\\s]*$\")\n\telse\n\t\ttemplate.matchSelectorRegex = val(template.data.matchSelectorRegex, new RegExp \"(?:^)#{template.trigger}[^\\\\s]*$\")\n\n\ttemplate.selectorRegex = val(template.data.selectorRegex, new RegExp \"#{template.trigger}([^\\\\s]*)$\")\n\n\ttemplate.replaceRegex = val(template.data.replaceRegex, new RegExp \"#{template.trigger}[^\\\\s]*$\")\n\n\ttemplate.getValue = val template.data.getValue, (_id) -> return _id\n\n\ttemplate.up = =>\n\t\tcurrent = template.find('.popup-item.selected')\n\t\tprevious = $(current).prev('.popup-item')[0] or template.find('.popup-item:last-child')\n\t\tif previous?\n\t\t\tcurrent.className = current.className.replace /\\sselected/, ''\n\t\t\tprevious.className += ' selected'\n\t\t\ttemplate.value.set previous.getAttribute('data-id')\n\n\ttemplate.down = =>\n\t\tcurrent = template.find('.popup-item.selected')\n\t\tnext = $(current).next('.popup-item')[0] or template.find('.popup-item')\n\t\tif next?.classList.contains('popup-item')\n\t\t\tcurrent.className = current.className.replace /\\sselected/, ''\n\t\t\tnext.className += ' selected'\n\t\t\ttemplate.value.set next.getAttribute('data-id')\n\n\ttemplate.verifySelection = =>\n\t\tcurrent = template.find('.popup-item.selected')\n\t\tif not current?\n\t\t\tfirst = template.find('.popup-item')\n\t\t\tif first?\n\t\t\t\tfirst.className += ' selected'\n\t\t\t\ttemplate.value.set first.getAttribute('data-id')\n\t\t\telse\n\t\t\t\ttemplate.value.set undefined\n\n\ttemplate.onInputKeydown = (event) =>\n\t\tif template.open.curValue isnt true or template.hasData.curValue isnt true\n\t\t\treturn\n\n\t\tif event.which in [keys.ENTER, keys.TAB]\n\t\t\tif template.blurOnSelectItem is true\n\t\t\t\ttemplate.input.blur()\n\t\t\telse\n\t\t\t\ttemplate.open.set false\n\n\t\t\ttemplate.enterValue()\n\n\t\t\tif template.data.cleanOnEnter\n\t\t\t\ttemplate.input.value = ''\n\n\t\t\tevent.preventDefault()\n\t\t\tevent.stopPropagation()\n\t\t\treturn\n\n\t\tif event.which is keys.ARROW_UP\n\t\t\ttemplate.up()\n\n\t\t\tevent.preventDefault()\n\t\t\tevent.stopPropagation()\n\t\t\treturn\n\n\t\tif event.which is keys.ARROW_DOWN\n\t\t\ttemplate.down()\n\n\t\t\tevent.preventDefault()\n\t\t\tevent.stopPropagation()\n\t\t\treturn\n\n\ttemplate.setTextFilter = _.debounce (value) ->\n\t\ttemplate.textFilter.set(value)\n\t, template.textFilterDelay\n\n\ttemplate.onInputKeyup = (event) =>\n\t\tif template.closeOnEsc is true and template.open.curValue is true and event.which is keys.ESC\n\t\t\ttemplate.open.set false\n\t\t\tevent.preventDefault()\n\t\t\tevent.stopPropagation()\n\t\t\treturn\n\n\t\tvalue = template.input.value\n\t\tvalue = value.substr 0, getCursorPosition(template.input)\n\n\t\tif template.matchSelectorRegex.test value\n\t\t\ttemplate.setTextFilter value.match(template.selectorRegex)[1]\n\t\t\ttemplate.open.set true\n\t\telse\n\t\t\ttemplate.open.set false\n\n\t\tif template.open.curValue isnt true\n\t\t\treturn\n\n\t\tif event.which not in [keys.ARROW_UP, keys.ARROW_DOWN]\n\t\t\tMeteor.defer =>\n\t\t\t\ttemplate.verifySelection()\n\n\ttemplate.onFocus = (event) =>\n\t\ttemplate.clickingItem = false;\n\n\t\tif template.open.curValue is true\n\t\t\treturn\n\n\t\tvalue = template.input.value\n\t\tvalue = value.substr 0, getCursorPosition(template.input)\n\n\t\tif template.matchSelectorRegex.test value\n\t\t\ttemplate.setTextFilter value.match(template.selectorRegex)[1]\n\t\t\ttemplate.open.set true\n\t\t\tMeteor.defer =>\n\t\t\t\ttemplate.verifySelection()\n\t\telse\n\t\t\ttemplate.open.set false\n\n\ttemplate.onBlur = (event) =>\n\t\tif template.open.curValue is false\n\t\t\treturn\n\n\t\tif template.clickingItem is true\n\t\t\treturn\n\n\t\ttemplate.open.set false\n\n\ttemplate.enterValue = ->\n\t\tif not template.value.curValue? then return\n\n\t\tvalue = template.input.value\n\t\tcaret = getCursorPosition(template.input)\n\t\tfirstPartValue = value.substr 0, caret\n\t\tlastPartValue = value.substr caret\n\t\tgetValue = this.getValue(template.value.curValue, template.data.collection, template.records.get(), firstPartValue)\n\n\t\tif not getValue\n\t\t\treturn\n\n\t\tfirstPartValue = firstPartValue.replace(template.selectorRegex, template.prefix + getValue + template.suffix)\n\n\t\ttemplate.input.value = firstPartValue + lastPartValue\n\n\t\tsetCursorPosition template.input, firstPartValue.length\n\n\ttemplate.records = new ReactiveVar []\n\tTracker.autorun ->\n\t\tif template.data.collection.findOne?\n\t\t\ttemplate.data.collection.find().count()\n\n\t\tfilter = template.textFilter.get()\n\t\tif filter?\n\t\t\tfilterCallback = (result) =>\n\t\t\t\ttemplate.hasData.set result?.length > 0\n\t\t\t\ttemplate.records.set result\n\n\t\t\t\tMeteor.defer =>\n\t\t\t\t\ttemplate.verifySelection()\n\n\t\t\tresult = template.data.getFilter(template.data.collection, filter, filterCallback)\n\t\t\tif result?\n\t\t\t\tfilterCallback result\n\n\nTemplate.messagePopup.onRendered ->\n\tif this.data.getInput?\n\t\tthis.input = this.data.getInput?()\n\telse if this.data.input\n\t\tthis.input = this.parentTemplate().find(this.data.input)\n\n\tif not this.input?\n\t\tconsole.error 'Input not found for popup'\n\n\t$(this.input).on 'keyup', this.onInputKeyup.bind this\n\t$(this.input).on 'keydown', this.onInputKeydown.bind this\n\t$(this.input).on 'focus', this.onFocus.bind this\n\t$(this.input).on 'blur', this.onBlur.bind this\n\n\nTemplate.messagePopup.onDestroyed ->\n\t$(this.input).off 'keyup', this.onInputKeyup\n\t$(this.input).off 'keydown', this.onInputKeydown\n\t$(this.input).off 'focus', this.onFocus\n\t$(this.input).off 'blur', this.onBlur\n\n\nTemplate.messagePopup.events\n\t'mouseenter .popup-item': (e) ->\n\t\tif e.currentTarget.className.indexOf('selected') > -1\n\t\t\treturn\n\n\t\ttemplate = Template.instance()\n\n\t\tcurrent = template.find('.popup-item.selected')\n\t\tif current?\n\t\t\tcurrent.className = current.className.replace /\\sselected/, ''\n\t\te.currentTarget.className += ' selected'\n\t\ttemplate.value.set this._id\n\n\t'mousedown .popup-item, touchstart .popup-item': (e) ->\n\t\ttemplate = Template.instance()\n\t\ttemplate.clickingItem = true;\n\n\t'mouseup .popup-item, touchend .popup-item': (e) ->\n\t\ttemplate = Template.instance()\n\n\t\ttemplate.clickingItem = false;\n\n\t\ttemplate.value.set this._id\n\n\t\ttemplate.enterValue()\n\n\t\ttemplate.open.set false\n\n\t\ttoolbarSearch.clear();\n\n\nTemplate.messagePopup.helpers\n\tisOpen: ->\n\t\tTemplate.instance().open.get() and ((Template.instance().hasData.get() or Template.instance().data.emptyTemplate?) or not Template.instance().parentTemplate(1).subscriptionsReady())\n\n\tdata: ->\n\t\ttemplate = Template.instance()\n\n\t\treturn template.records.get()\n","var getCursorPosition, keys, setCursorPosition, val;\n\nkeys = {\n  TAB: 9,\n  ENTER: 13,\n  ESC: 27,\n  ARROW_LEFT: 37,\n  ARROW_UP: 38,\n  ARROW_RIGHT: 39,\n  ARROW_DOWN: 40\n};\n\ngetCursorPosition = function(input) {\n  var sel, selLen;\n  if (input == null) {\n    return;\n  }\n  if (input.selectionStart != null) {\n    return input.selectionStart;\n  } else if (document.selection != null) {\n    input.focus();\n    sel = document.selection.createRange();\n    selLen = document.selection.createRange().text.length;\n    sel.moveStart('character', -input.value.length);\n    return sel.text.length - selLen;\n  }\n};\n\nsetCursorPosition = function(input, caretPos) {\n  var range;\n  if (input == null) {\n    return;\n  }\n  if (input.selectionStart != null) {\n    input.focus();\n    return input.setSelectionRange(caretPos, caretPos);\n  } else if (document.selection != null) {\n    range = input.createTextRange();\n    range.move('character', caretPos);\n    return range.select();\n  }\n};\n\nval = function(v, d) {\n  if (v != null) {\n    return v;\n  } else {\n    return d;\n  }\n};\n\nTemplate.messagePopup.onCreated(function() {\n  var template;\n  template = this;\n  template.textFilter = new ReactiveVar('');\n  template.textFilterDelay = val(template.data.textFilterDelay, 0);\n  template.open = val(template.data.open, new ReactiveVar(false));\n  template.hasData = new ReactiveVar(false);\n  template.value = new ReactiveVar;\n  template.trigger = val(template.data.trigger, '');\n  template.triggerAnywhere = val(template.data.triggerAnywhere, true);\n  template.closeOnEsc = val(template.data.closeOnEsc, true);\n  template.blurOnSelectItem = val(template.data.blurOnSelectItem, false);\n  template.prefix = val(template.data.prefix, template.trigger);\n  template.suffix = val(template.data.suffix, '');\n  if (template.triggerAnywhere === true) {\n    template.matchSelectorRegex = val(template.data.matchSelectorRegex, new RegExp(\"(?:^| )\" + template.trigger + \"[^\\\\s]*$\"));\n  } else {\n    template.matchSelectorRegex = val(template.data.matchSelectorRegex, new RegExp(\"(?:^)\" + template.trigger + \"[^\\\\s]*$\"));\n  }\n  template.selectorRegex = val(template.data.selectorRegex, new RegExp(template.trigger + \"([^\\\\s]*)$\"));\n  template.replaceRegex = val(template.data.replaceRegex, new RegExp(template.trigger + \"[^\\\\s]*$\"));\n  template.getValue = val(template.data.getValue, function(_id) {\n    return _id;\n  });\n  template.up = (function(_this) {\n    return function() {\n      var current, previous;\n      current = template.find('.popup-item.selected');\n      previous = $(current).prev('.popup-item')[0] || template.find('.popup-item:last-child');\n      if (previous != null) {\n        current.className = current.className.replace(/\\sselected/, '');\n        previous.className += ' selected';\n        return template.value.set(previous.getAttribute('data-id'));\n      }\n    };\n  })(this);\n  template.down = (function(_this) {\n    return function() {\n      var current, next;\n      current = template.find('.popup-item.selected');\n      next = $(current).next('.popup-item')[0] || template.find('.popup-item');\n      if (next != null ? next.classList.contains('popup-item') : void 0) {\n        current.className = current.className.replace(/\\sselected/, '');\n        next.className += ' selected';\n        return template.value.set(next.getAttribute('data-id'));\n      }\n    };\n  })(this);\n  template.verifySelection = (function(_this) {\n    return function() {\n      var current, first;\n      current = template.find('.popup-item.selected');\n      if (current == null) {\n        first = template.find('.popup-item');\n        if (first != null) {\n          first.className += ' selected';\n          return template.value.set(first.getAttribute('data-id'));\n        } else {\n          return template.value.set(void 0);\n        }\n      }\n    };\n  })(this);\n  template.onInputKeydown = (function(_this) {\n    return function(event) {\n      var ref;\n      if (template.open.curValue !== true || template.hasData.curValue !== true) {\n        return;\n      }\n      if ((ref = event.which) === keys.ENTER || ref === keys.TAB) {\n        if (template.blurOnSelectItem === true) {\n          template.input.blur();\n        } else {\n          template.open.set(false);\n        }\n        template.enterValue();\n        if (template.data.cleanOnEnter) {\n          template.input.value = '';\n        }\n        event.preventDefault();\n        event.stopPropagation();\n        return;\n      }\n      if (event.which === keys.ARROW_UP) {\n        template.up();\n        event.preventDefault();\n        event.stopPropagation();\n        return;\n      }\n      if (event.which === keys.ARROW_DOWN) {\n        template.down();\n        event.preventDefault();\n        event.stopPropagation();\n      }\n    };\n  })(this);\n  template.setTextFilter = _.debounce(function(value) {\n    return template.textFilter.set(value);\n  }, template.textFilterDelay);\n  template.onInputKeyup = (function(_this) {\n    return function(event) {\n      var ref, value;\n      if (template.closeOnEsc === true && template.open.curValue === true && event.which === keys.ESC) {\n        template.open.set(false);\n        event.preventDefault();\n        event.stopPropagation();\n        return;\n      }\n      value = template.input.value;\n      value = value.substr(0, getCursorPosition(template.input));\n      if (template.matchSelectorRegex.test(value)) {\n        template.setTextFilter(value.match(template.selectorRegex)[1]);\n        template.open.set(true);\n      } else {\n        template.open.set(false);\n      }\n      if (template.open.curValue !== true) {\n        return;\n      }\n      if ((ref = event.which) !== keys.ARROW_UP && ref !== keys.ARROW_DOWN) {\n        return Meteor.defer(function() {\n          return template.verifySelection();\n        });\n      }\n    };\n  })(this);\n  template.onFocus = (function(_this) {\n    return function(event) {\n      var value;\n      template.clickingItem = false;\n      if (template.open.curValue === true) {\n        return;\n      }\n      value = template.input.value;\n      value = value.substr(0, getCursorPosition(template.input));\n      if (template.matchSelectorRegex.test(value)) {\n        template.setTextFilter(value.match(template.selectorRegex)[1]);\n        template.open.set(true);\n        return Meteor.defer(function() {\n          return template.verifySelection();\n        });\n      } else {\n        return template.open.set(false);\n      }\n    };\n  })(this);\n  template.onBlur = (function(_this) {\n    return function(event) {\n      if (template.open.curValue === false) {\n        return;\n      }\n      if (template.clickingItem === true) {\n        return;\n      }\n      return template.open.set(false);\n    };\n  })(this);\n  template.enterValue = function() {\n    var caret, firstPartValue, getValue, lastPartValue, value;\n    if (template.value.curValue == null) {\n      return;\n    }\n    value = template.input.value;\n    caret = getCursorPosition(template.input);\n    firstPartValue = value.substr(0, caret);\n    lastPartValue = value.substr(caret);\n    getValue = this.getValue(template.value.curValue, template.data.collection, template.records.get(), firstPartValue);\n    if (!getValue) {\n      return;\n    }\n    firstPartValue = firstPartValue.replace(template.selectorRegex, template.prefix + getValue + template.suffix);\n    template.input.value = firstPartValue + lastPartValue;\n    return setCursorPosition(template.input, firstPartValue.length);\n  };\n  template.records = new ReactiveVar([]);\n  return Tracker.autorun(function() {\n    var filter, filterCallback, result;\n    if (template.data.collection.findOne != null) {\n      template.data.collection.find().count();\n    }\n    filter = template.textFilter.get();\n    if (filter != null) {\n      filterCallback = (function(_this) {\n        return function(result) {\n          template.hasData.set((result != null ? result.length : void 0) > 0);\n          template.records.set(result);\n          return Meteor.defer(function() {\n            return template.verifySelection();\n          });\n        };\n      })(this);\n      result = template.data.getFilter(template.data.collection, filter, filterCallback);\n      if (result != null) {\n        return filterCallback(result);\n      }\n    }\n  });\n});\n\nTemplate.messagePopup.onRendered(function() {\n  var base;\n  if (this.data.getInput != null) {\n    this.input = typeof (base = this.data).getInput === \"function\" ? base.getInput() : void 0;\n  } else if (this.data.input) {\n    this.input = this.parentTemplate().find(this.data.input);\n  }\n  if (this.input == null) {\n    console.error('Input not found for popup');\n  }\n  $(this.input).on('keyup', this.onInputKeyup.bind(this));\n  $(this.input).on('keydown', this.onInputKeydown.bind(this));\n  $(this.input).on('focus', this.onFocus.bind(this));\n  return $(this.input).on('blur', this.onBlur.bind(this));\n});\n\nTemplate.messagePopup.onDestroyed(function() {\n  $(this.input).off('keyup', this.onInputKeyup);\n  $(this.input).off('keydown', this.onInputKeydown);\n  $(this.input).off('focus', this.onFocus);\n  return $(this.input).off('blur', this.onBlur);\n});\n\nTemplate.messagePopup.events({\n  'mouseenter .popup-item': function(e) {\n    var current, template;\n    if (e.currentTarget.className.indexOf('selected') > -1) {\n      return;\n    }\n    template = Template.instance();\n    current = template.find('.popup-item.selected');\n    if (current != null) {\n      current.className = current.className.replace(/\\sselected/, '');\n    }\n    e.currentTarget.className += ' selected';\n    return template.value.set(this._id);\n  },\n  'mousedown .popup-item, touchstart .popup-item': function(e) {\n    var template;\n    template = Template.instance();\n    return template.clickingItem = true;\n  },\n  'mouseup .popup-item, touchend .popup-item': function(e) {\n    var template;\n    template = Template.instance();\n    template.clickingItem = false;\n    template.value.set(this._id);\n    template.enterValue();\n    template.open.set(false);\n    return toolbarSearch.clear();\n  }\n});\n\nTemplate.messagePopup.helpers({\n  isOpen: function() {\n    return Template.instance().open.get() && ((Template.instance().hasData.get() || (Template.instance().data.emptyTemplate != null)) || !Template.instance().parentTemplate(1).subscriptionsReady());\n  },\n  data: function() {\n    var template;\n    template = Template.instance();\n    return template.records.get();\n  }\n});\n","Template.messagePopupChannel.helpers({\n\ticon() {\n\t\treturn RocketChat.roomTypes.getIcon(this.t);\n\t}\n});\n","@filteredUsersMemory = new Mongo.Collection null\n\nMeteor.startup ->\n\tTracker.autorun ->\n\t\tif not Meteor.user()? or not Session.get('openedRoom')?\n\t\t\treturn\n\n\t\tfilteredUsersMemory.remove({})\n\t\tmessageUsers = RocketChat.models.Messages.find({rid: Session.get('openedRoom'), 'u.username': {$ne: Meteor.user().username}}, {fields: {'u.username': 1, 'u.name': 1, ts: 1}, sort: {ts: -1}}).fetch()\n\t\tuniqueMessageUsersControl = {}\n\t\tmessageUsers.forEach (messageUser) ->\n\t\t\tif not uniqueMessageUsersControl[messageUser.u.username]?\n\t\t\t\tuniqueMessageUsersControl[messageUser.u.username] = true\n\t\t\t\tfilteredUsersMemory.upsert messageUser.u.username,\n\t\t\t\t\t_id: messageUser.u.username\n\t\t\t\t\tusername: messageUser.u.username\n\t\t\t\t\tname: messageUser.u.name\n\t\t\t\t\tstatus: Session.get('user_' + messageUser.u.username + '_status') or 'offline'\n\t\t\t\t\tts: messageUser.ts\n\n\ngetUsersFromServer = (filter, records, cb) =>\n\tmessageUsers = _.pluck(records, 'username')\n\tMeteor.call 'spotlight', filter, messageUsers, { users: true }, (err, results) ->\n\t\tif err?\n\t\t\treturn console.error err\n\n\t\tif results.users.length > 0\n\t\t\tfor result in results.users\n\t\t\t\tif records.length < 5\n\t\t\t\t\trecords.push\n\t\t\t\t\t\t_id: result.username\n\t\t\t\t\t\tusername: result.username\n\t\t\t\t\t\tstatus: 'offline'\n\t\t\t\t\t\tsort: 3\n\n\t\t\trecords = _.sortBy(records, 'sort')\n\n\t\t\tcb(records)\n\ngetRoomsFromServer = (filter, records, cb) =>\n\tMeteor.call 'spotlight', filter, null, { rooms: true }, (err, results) ->\n\t\tif err?\n\t\t\treturn console.error err\n\n\t\tif results.rooms.length > 0\n\t\t\tfor room in results.rooms\n\t\t\t\tif records.length < 5\n\t\t\t\t\trecords.push room\n\n\t\t\tcb(records)\n\ngetUsersFromServerDelayed = _.throttle getUsersFromServer, 500\ngetRoomsFromServerDelayed = _.throttle getRoomsFromServer, 500\n\n\nTemplate.messagePopupConfig.helpers\n\tpopupUserConfig: ->\n\t\tself = this\n\t\ttemplate = Template.instance()\n\n\t\tconfig =\n\t\t\ttitle: t('People')\n\t\t\tcollection: filteredUsersMemory\n\t\t\ttemplate: 'messagePopupUser'\n\t\t\tgetInput: self.getInput\n\t\t\ttextFilterDelay: 200\n\t\t\ttrigger: '@'\n\t\t\tsuffix: ' '\n\t\t\tgetFilter: (collection, filter, cb) ->\n\t\t\t\texp = new RegExp(\"#{RegExp.escape filter}\", 'i')\n\n\t\t\t\t# Get users from messages\n\t\t\t\titems = filteredUsersMemory.find({ts: {$exists: true}, $or: [{username: exp}, {name: exp}]}, {limit: 5, sort: {ts: -1}}).fetch()\n\n\t\t\t\t# Get online users\n\t\t\t\tif items.length < 5 and filter?.trim() isnt ''\n\t\t\t\t\tmessageUsers = _.pluck(items, 'username')\n\t\t\t\t\tMeteor.users.find({$and: [{$or:[{username: exp}, {name: exp}]}, {username: {$nin: [Meteor.user()?.username].concat(messageUsers)}}]}, {limit: 5 - messageUsers.length}).fetch().forEach (item) ->\n\t\t\t\t\t\titems.push\n\t\t\t\t\t\t\t_id: item.username\n\t\t\t\t\t\t\tusername: item.username\n\t\t\t\t\t\t\tname: item.name\n\t\t\t\t\t\t\tstatus: item.status\n\t\t\t\t\t\t\tsort: 1\n\n\t\t\t\t# # Get users of room\n\t\t\t\t# if items.length < 5 and filter?.trim() isnt ''\n\t\t\t\t# \tmessageUsers = _.pluck(items, 'username')\n\t\t\t\t# \tTracker.nonreactive ->\n\t\t\t\t# \t\troomUsernames = RocketChat.models.Rooms.findOne(Session.get('openedRoom')).usernames\n\t\t\t\t# \t\tfor roomUsername in roomUsernames\n\t\t\t\t# \t\t\tif messageUsers.indexOf(roomUsername) is -1 and exp.test(roomUsername)\n\t\t\t\t# \t\t\t\titems.push\n\t\t\t\t# \t\t\t\t\t_id: roomUsername\n\t\t\t\t# \t\t\t\t\tusername: roomUsername\n\t\t\t\t# \t\t\t\t\tstatus: Session.get('user_' + roomUsername + '_status') or 'offline'\n\t\t\t\t# \t\t\t\t\tsort: 2\n\n\t\t\t\t# \t\t\t\tif items.length >= 5\n\t\t\t\t# \t\t\t\t\tbreak\n\n\t\t\t\t# Get users from db\n\t\t\t\tif items.length < 5 and filter?.trim() isnt ''\n\t\t\t\t\tgetUsersFromServerDelayed filter, items, cb\n\n\t\t\t\tall =\n\t\t\t\t\t_id: 'all'\n\t\t\t\t\tusername: 'all'\n\t\t\t\t\tsystem: true\n\t\t\t\t\tname: t 'Notify_all_in_this_room'\n\t\t\t\t\tcompatibility: 'channel group'\n\t\t\t\t\tsort: 4\n\n\t\t\t\texp = new RegExp(\"(^|\\\\s)#{RegExp.escape filter}\", 'i')\n\t\t\t\tif exp.test(all.username) or exp.test(all.compatibility)\n\t\t\t\t\titems.push all\n\n\t\t\t\there =\n\t\t\t\t\t_id: 'here'\n\t\t\t\t\tusername: 'here'\n\t\t\t\t\tsystem: true\n\t\t\t\t\tname: t 'Notify_active_in_this_room'\n\t\t\t\t\tcompatibility: 'channel group'\n\t\t\t\t\tsort: 4\n\n\t\t\t\tif exp.test(here.username) or exp.test(here.compatibility)\n\t\t\t\t\titems.push here\n\n\t\t\t\treturn items\n\n\t\t\tgetValue: (_id) ->\n\t\t\t\treturn _id\n\n\t\treturn config\n\n\tpopupChannelConfig: ->\n\t\tself = this\n\t\ttemplate = Template.instance()\n\n\t\tconfig =\n\t\t\ttitle: t('Channels')\n\t\t\tcollection: RocketChat.models.Subscriptions\n\t\t\ttrigger: '#'\n\t\t\tsuffix: ' '\n\t\t\ttemplate: 'messagePopupChannel'\n\t\t\tgetInput: self.getInput\n\t\t\tgetFilter: (collection, filter, cb) ->\n\t\t\t\texp = new RegExp(filter, 'i')\n\n\t\t\t\trecords = collection.find({name: exp, t: {$in: ['c', 'p']}}, {limit: 5, sort: {ls: -1}}).fetch()\n\n\t\t\t\tif records.length < 5 and filter?.trim() isnt ''\n\t\t\t\t\tgetRoomsFromServerDelayed filter, records, cb\n\n\t\t\t\treturn records\n\n\t\t\tgetValue: (_id, collection, records) ->\n\t\t\t\treturn _.findWhere(records, {_id: _id})?.name\n\n\t\treturn config\n\n\tpopupSlashCommandsConfig: ->\n\t\tself = this\n\t\ttemplate = Template.instance()\n\n\t\tconfig =\n\t\t\ttitle: t('Commands')\n\t\t\tcollection: RocketChat.slashCommands.commands\n\t\t\ttrigger: '/'\n\t\t\tsuffix: ' '\n\t\t\ttriggerAnywhere: false\n\t\t\ttemplate: 'messagePopupSlashCommand'\n\t\t\tgetInput: self.getInput\n\t\t\tgetFilter: (collection, filter) ->\n\t\t\t\tcommands = []\n\t\t\t\tfor command, item of collection\n\t\t\t\t\tif command.indexOf(filter) > -1\n\t\t\t\t\t\tcommands.push\n\t\t\t\t\t\t\t_id: command\n\t\t\t\t\t\t\tparams: if item.params then TAPi18n.__ item.params else ''\n\t\t\t\t\t\t\tdescription: TAPi18n.__ item.description\n\n\t\t\t\tcommands = commands.sort (a, b) ->\n\t\t\t\t\treturn a._id > b._id\n\n\t\t\t\tcommands = commands[0..10]\n\n\t\t\t\treturn commands\n\n\t\treturn config\n\n\temojiEnabled: ->\n\t\treturn RocketChat.emoji?\n\n\tpopupEmojiConfig: ->\n\t\tif RocketChat.emoji?\n\t\t\tself = this\n\t\t\ttemplate = Template.instance()\n\t\t\tconfig =\n\t\t\t\ttitle: t('Emoji')\n\t\t\t\tcollection: RocketChat.emoji.list\n\t\t\t\ttemplate: 'messagePopupEmoji'\n\t\t\t\ttrigger: ':'\n\t\t\t\tprefix: ''\n\t\t\t\tsuffix: ' '\n\t\t\t\tgetInput: self.getInput\n\t\t\t\tgetFilter: (collection, filter, cb) ->\n\t\t\t\t\tresults = []\n\t\t\t\t\tkey = ':' + filter\n\n\t\t\t\t\tif RocketChat.emoji.packages.emojione?.asciiList[key] or filter.length < 2\n\t\t\t\t\t\treturn []\n\n\t\t\t\t\tregExp = new RegExp('^' + RegExp.escape(key), 'i')\n\n\t\t\t\t\tfor key, value of collection\n\t\t\t\t\t\tif results.length > 10\n\t\t\t\t\t\t\tbreak\n\n\t\t\t\t\t\tif regExp.test(key)\n\t\t\t\t\t\t\tresults.push\n\t\t\t\t\t\t\t\t_id: key\n\t\t\t\t\t\t\t\tdata: value\n\n\t\t\t\t\tresults.sort (a, b) ->\n\t\t\t\t\t\tif a._id < b._id\n\t\t\t\t\t\t\treturn -1\n\t\t\t\t\t\tif a._id > b._id\n\t\t\t\t\t\t\treturn 1\n\t\t\t\t\t\treturn 0\n\n\t\t\t\t\treturn results\n\n\t\treturn config\n","var getRoomsFromServer, getRoomsFromServerDelayed, getUsersFromServer, getUsersFromServerDelayed;\n\nthis.filteredUsersMemory = new Mongo.Collection(null);\n\nMeteor.startup(function() {\n  return Tracker.autorun(function() {\n    var messageUsers, uniqueMessageUsersControl;\n    if ((Meteor.user() == null) || (Session.get('openedRoom') == null)) {\n      return;\n    }\n    filteredUsersMemory.remove({});\n    messageUsers = RocketChat.models.Messages.find({\n      rid: Session.get('openedRoom'),\n      'u.username': {\n        $ne: Meteor.user().username\n      }\n    }, {\n      fields: {\n        'u.username': 1,\n        'u.name': 1,\n        ts: 1\n      },\n      sort: {\n        ts: -1\n      }\n    }).fetch();\n    uniqueMessageUsersControl = {};\n    return messageUsers.forEach(function(messageUser) {\n      if (uniqueMessageUsersControl[messageUser.u.username] == null) {\n        uniqueMessageUsersControl[messageUser.u.username] = true;\n        return filteredUsersMemory.upsert(messageUser.u.username, {\n          _id: messageUser.u.username,\n          username: messageUser.u.username,\n          name: messageUser.u.name,\n          status: Session.get('user_' + messageUser.u.username + '_status') || 'offline',\n          ts: messageUser.ts\n        });\n      }\n    });\n  });\n});\n\ngetUsersFromServer = (function(_this) {\n  return function(filter, records, cb) {\n    var messageUsers;\n    messageUsers = _.pluck(records, 'username');\n    return Meteor.call('spotlight', filter, messageUsers, {\n      users: true\n    }, function(err, results) {\n      var i, len, ref, result;\n      if (err != null) {\n        return console.error(err);\n      }\n      if (results.users.length > 0) {\n        ref = results.users;\n        for (i = 0, len = ref.length; i < len; i++) {\n          result = ref[i];\n          if (records.length < 5) {\n            records.push({\n              _id: result.username,\n              username: result.username,\n              status: 'offline',\n              sort: 3\n            });\n          }\n        }\n        records = _.sortBy(records, 'sort');\n        return cb(records);\n      }\n    });\n  };\n})(this);\n\ngetRoomsFromServer = (function(_this) {\n  return function(filter, records, cb) {\n    return Meteor.call('spotlight', filter, null, {\n      rooms: true\n    }, function(err, results) {\n      var i, len, ref, room;\n      if (err != null) {\n        return console.error(err);\n      }\n      if (results.rooms.length > 0) {\n        ref = results.rooms;\n        for (i = 0, len = ref.length; i < len; i++) {\n          room = ref[i];\n          if (records.length < 5) {\n            records.push(room);\n          }\n        }\n        return cb(records);\n      }\n    });\n  };\n})(this);\n\ngetUsersFromServerDelayed = _.throttle(getUsersFromServer, 500);\n\ngetRoomsFromServerDelayed = _.throttle(getRoomsFromServer, 500);\n\nTemplate.messagePopupConfig.helpers({\n  popupUserConfig: function() {\n    var config, self, template;\n    self = this;\n    template = Template.instance();\n    config = {\n      title: t('People'),\n      collection: filteredUsersMemory,\n      template: 'messagePopupUser',\n      getInput: self.getInput,\n      textFilterDelay: 200,\n      trigger: '@',\n      suffix: ' ',\n      getFilter: function(collection, filter, cb) {\n        var all, exp, here, items, messageUsers, ref;\n        exp = new RegExp(\"\" + (RegExp.escape(filter)), 'i');\n        items = filteredUsersMemory.find({\n          ts: {\n            $exists: true\n          },\n          $or: [\n            {\n              username: exp\n            }, {\n              name: exp\n            }\n          ]\n        }, {\n          limit: 5,\n          sort: {\n            ts: -1\n          }\n        }).fetch();\n        if (items.length < 5 && (filter != null ? filter.trim() : void 0) !== '') {\n          messageUsers = _.pluck(items, 'username');\n          Meteor.users.find({\n            $and: [\n              {\n                $or: [\n                  {\n                    username: exp\n                  }, {\n                    name: exp\n                  }\n                ]\n              }, {\n                username: {\n                  $nin: [(ref = Meteor.user()) != null ? ref.username : void 0].concat(messageUsers)\n                }\n              }\n            ]\n          }, {\n            limit: 5 - messageUsers.length\n          }).fetch().forEach(function(item) {\n            return items.push({\n              _id: item.username,\n              username: item.username,\n              name: item.name,\n              status: item.status,\n              sort: 1\n            });\n          });\n        }\n        if (items.length < 5 && (filter != null ? filter.trim() : void 0) !== '') {\n          getUsersFromServerDelayed(filter, items, cb);\n        }\n        all = {\n          _id: 'all',\n          username: 'all',\n          system: true,\n          name: t('Notify_all_in_this_room'),\n          compatibility: 'channel group',\n          sort: 4\n        };\n        exp = new RegExp(\"(^|\\\\s)\" + (RegExp.escape(filter)), 'i');\n        if (exp.test(all.username) || exp.test(all.compatibility)) {\n          items.push(all);\n        }\n        here = {\n          _id: 'here',\n          username: 'here',\n          system: true,\n          name: t('Notify_active_in_this_room'),\n          compatibility: 'channel group',\n          sort: 4\n        };\n        if (exp.test(here.username) || exp.test(here.compatibility)) {\n          items.push(here);\n        }\n        return items;\n      },\n      getValue: function(_id) {\n        return _id;\n      }\n    };\n    return config;\n  },\n  popupChannelConfig: function() {\n    var config, self, template;\n    self = this;\n    template = Template.instance();\n    config = {\n      title: t('Channels'),\n      collection: RocketChat.models.Subscriptions,\n      trigger: '#',\n      suffix: ' ',\n      template: 'messagePopupChannel',\n      getInput: self.getInput,\n      getFilter: function(collection, filter, cb) {\n        var exp, records;\n        exp = new RegExp(filter, 'i');\n        records = collection.find({\n          name: exp,\n          t: {\n            $in: ['c', 'p']\n          }\n        }, {\n          limit: 5,\n          sort: {\n            ls: -1\n          }\n        }).fetch();\n        if (records.length < 5 && (filter != null ? filter.trim() : void 0) !== '') {\n          getRoomsFromServerDelayed(filter, records, cb);\n        }\n        return records;\n      },\n      getValue: function(_id, collection, records) {\n        var ref;\n        return (ref = _.findWhere(records, {\n          _id: _id\n        })) != null ? ref.name : void 0;\n      }\n    };\n    return config;\n  },\n  popupSlashCommandsConfig: function() {\n    var config, self, template;\n    self = this;\n    template = Template.instance();\n    config = {\n      title: t('Commands'),\n      collection: RocketChat.slashCommands.commands,\n      trigger: '/',\n      suffix: ' ',\n      triggerAnywhere: false,\n      template: 'messagePopupSlashCommand',\n      getInput: self.getInput,\n      getFilter: function(collection, filter) {\n        var command, commands, item;\n        commands = [];\n        for (command in collection) {\n          item = collection[command];\n          if (command.indexOf(filter) > -1) {\n            commands.push({\n              _id: command,\n              params: item.params ? TAPi18n.__(item.params) : '',\n              description: TAPi18n.__(item.description)\n            });\n          }\n        }\n        commands = commands.sort(function(a, b) {\n          return a._id > b._id;\n        });\n        commands = commands.slice(0, 11);\n        return commands;\n      }\n    };\n    return config;\n  },\n  emojiEnabled: function() {\n    return RocketChat.emoji != null;\n  },\n  popupEmojiConfig: function() {\n    var config, self, template;\n    if (RocketChat.emoji != null) {\n      self = this;\n      template = Template.instance();\n      config = {\n        title: t('Emoji'),\n        collection: RocketChat.emoji.list,\n        template: 'messagePopupEmoji',\n        trigger: ':',\n        prefix: '',\n        suffix: ' ',\n        getInput: self.getInput,\n        getFilter: function(collection, filter, cb) {\n          var key, ref, regExp, results, value;\n          results = [];\n          key = ':' + filter;\n          if (((ref = RocketChat.emoji.packages.emojione) != null ? ref.asciiList[key] : void 0) || filter.length < 2) {\n            return [];\n          }\n          regExp = new RegExp('^' + RegExp.escape(key), 'i');\n          for (key in collection) {\n            value = collection[key];\n            if (results.length > 10) {\n              break;\n            }\n            if (regExp.test(key)) {\n              results.push({\n                _id: key,\n                data: value\n              });\n            }\n          }\n          results.sort(function(a, b) {\n            if (a._id < b._id) {\n              return -1;\n            }\n            if (a._id > b._id) {\n              return 1;\n            }\n            return 0;\n          });\n          return results;\n        }\n      };\n    }\n    return config;\n  }\n});\n","Template.messagePopupEmoji.helpers\n\tvalue: ->\n\t\tlength = this.data.length\n\t\treturn this.data[length - 1]\n","import moment from 'moment'\n\nTemplate.message.helpers\n\tencodeURI: (text) ->\n\t\treturn encodeURI(text)\n\tisBot: ->\n\t\treturn 'bot' if this.bot?\n\troleTags: ->\n\t\tif not RocketChat.settings.get('UI_DisplayRoles') or Meteor.user()?.settings?.preferences?.hideRoles\n\t\t\treturn []\n\t\troles = _.union(UserRoles.findOne(this.u?._id)?.roles, RoomRoles.findOne({'u._id': this.u?._id, rid: this.rid })?.roles)\n\t\treturn RocketChat.models.Roles.find({ _id: { $in: roles }, description: { $exists: 1, $ne: '' } }, { fields: { description: 1 } })\n\tisGroupable: ->\n\t\treturn 'false' if this.groupable is false\n\tisSequential: ->\n\t\treturn 'sequential' if this.groupable isnt false\n\tavatarFromUsername: ->\n\t\tif this.avatar? and this.avatar[0] is '@'\n\t\t\treturn this.avatar.replace(/^@/, '')\n\tgetEmoji: (emoji) ->\n\t\treturn renderEmoji emoji\n\tgetName: ->\n\t\tif this.alias\n\t\t\treturn this.alias\n\t\tif RocketChat.settings.get('UI_Use_Real_Name') and this.u?.name\n\t\t\treturn this.u.name\n\t\treturn this.u?.username\n\tshowUsername: ->\n\t\treturn this.alias or (RocketChat.settings.get('UI_Use_Real_Name') and this.u?.name)\n\town: ->\n\t\treturn 'own' if this.u?._id is Meteor.userId()\n\ttimestamp: ->\n\t\treturn +this.ts\n\tchatops: ->\n\t\treturn 'chatops-message' if this.u?.username is RocketChat.settings.get('Chatops_Username')\n\ttime: ->\n\t\treturn moment(this.ts).format(RocketChat.settings.get('Message_TimeFormat'))\n\tdate: ->\n\t\treturn moment(this.ts).format(RocketChat.settings.get('Message_DateFormat'))\n\tisTemp: ->\n\t\tif @temp is true\n\t\t\treturn 'temp'\n\tbody: ->\n\t\treturn Template.instance().body\n\tsystem: (returnClass) ->\n\t\tif RocketChat.MessageTypes.isSystemMessage(this)\n\t\t\tif returnClass\n\t\t\t\treturn 'color-info-font-color'\n\n\t\t\treturn 'system'\n\n\tshowTranslated: ->\n\t\tif RocketChat.settings.get('AutoTranslate_Enabled') and this.u?._id isnt Meteor.userId() and !RocketChat.MessageTypes.isSystemMessage(this)\n\t\t\tsubscription = RocketChat.models.Subscriptions.findOne({ rid: this.rid, 'u._id': Meteor.userId() }, { fields: { autoTranslate: 1, autoTranslateLanguage: 1 } });\n\t\t\tlanguage = RocketChat.AutoTranslate.getLanguage(this.rid);\n\t\t\treturn this.autoTranslateFetching || (subscription?.autoTranslate isnt this.autoTranslateShowInverse && this.translations && this.translations[language]) # || _.find(this.attachments, (attachment) -> attachment.translations && attachment.translations[language] && attachment.author_name isnt Meteor.user().username )\n\n\tedited: ->\n\t\treturn Template.instance().wasEdited\n\n\teditTime: ->\n\t\tif Template.instance().wasEdited\n\t\t\treturn moment(@editedAt).format(RocketChat.settings.get('Message_DateFormat') + ' ' + RocketChat.settings.get('Message_TimeFormat'))\n\teditedBy: ->\n\t\treturn \"\" unless Template.instance().wasEdited\n\t\t# try to return the username of the editor,\n\t\t# otherwise a special \"?\" character that will be\n\t\t# rendered as a special avatar\n\t\treturn @editedBy?.username or \"?\"\n\tcanEdit: ->\n\t\thasPermission = RocketChat.authz.hasAtLeastOnePermission('edit-message', this.rid)\n\t\tisEditAllowed = RocketChat.settings.get 'Message_AllowEditing'\n\t\teditOwn = this.u?._id is Meteor.userId()\n\n\t\treturn unless hasPermission or (isEditAllowed and editOwn)\n\n\t\tblockEditInMinutes = RocketChat.settings.get 'Message_AllowEditing_BlockEditInMinutes'\n\t\tif blockEditInMinutes? and blockEditInMinutes isnt 0\n\t\t\tmsgTs = moment(this.ts) if this.ts?\n\t\t\tcurrentTsDiff = moment().diff(msgTs, 'minutes') if msgTs?\n\t\t\treturn currentTsDiff < blockEditInMinutes\n\t\telse\n\t\t\treturn true\n\n\tcanDelete: ->\n\t\thasPermission = RocketChat.authz.hasAtLeastOnePermission('delete-message', this.rid )\n\t\tisDeleteAllowed = RocketChat.settings.get('Message_AllowDeleting')\n\t\tdeleteOwn = this.u?._id is Meteor.userId()\n\n\t\treturn unless hasPermission or (isDeleteAllowed and deleteOwn)\n\n\t\tblockDeleteInMinutes = RocketChat.settings.get 'Message_AllowDeleting_BlockDeleteInMinutes'\n\t\tif blockDeleteInMinutes? and blockDeleteInMinutes isnt 0\n\t\t\tmsgTs = moment(this.ts) if this.ts?\n\t\t\tcurrentTsDiff = moment().diff(msgTs, 'minutes') if msgTs?\n\t\t\treturn currentTsDiff < blockDeleteInMinutes\n\t\telse\n\t\t\treturn true\n\n\tshowEditedStatus: ->\n\t\treturn RocketChat.settings.get 'Message_ShowEditedStatus'\n\tlabel: ->\n\t\tif @i18nLabel\n\t\t\treturn t(@i18nLabel)\n\t\telse if @label\n\t\t\treturn @label\n\n\thasOembed: ->\n\t\treturn false unless this.urls?.length > 0 and Template.oembedBaseWidget? and RocketChat.settings.get 'API_Embed'\n\n\t\treturn false unless this.u?.username not in RocketChat.settings.get('API_EmbedDisabledFor')?.split(',').map (username) -> username.trim()\n\n\t\treturn true\n\n\treactions: ->\n\t\tmsgReactions = []\n\t\tuserUsername = Meteor.user()?.username\n\n\t\tfor emoji, reaction of @reactions\n\t\t\ttotal = reaction.usernames.length\n\t\t\tusernames = '@' + reaction.usernames.slice(0, 15).join(', @')\n\n\t\t\tusernames = usernames.replace('@'+userUsername, t('You').toLowerCase())\n\n\t\t\tif total > 15\n\t\t\t\tusernames = usernames + ' ' + t('And_more', { length: total - 15 }).toLowerCase()\n\t\t\telse\n\t\t\t\tusernames = usernames.replace(/,([^,]+)$/, ' '+t('and')+'$1')\n\n\t\t\tif usernames[0] isnt '@'\n\t\t\t\tusernames = usernames[0].toUpperCase() + usernames.substr(1)\n\n\t\t\tmsgReactions.push\n\t\t\t\temoji: emoji\n\t\t\t\tcount: reaction.usernames.length\n\t\t\t\tusernames: usernames\n\t\t\t\treaction: ' ' + t('Reacted_with').toLowerCase() + ' ' + emoji\n\t\t\t\tuserReacted: reaction.usernames.indexOf(userUsername) > -1\n\n\t\treturn msgReactions\n\n\tmarkUserReaction: (reaction) ->\n\t\tif reaction.userReacted\n\t\t\treturn {\n\t\t\t\tclass: 'selected'\n\t\t\t}\n\n\thideReactions: ->\n\t\treturn 'hidden' if _.isEmpty(@reactions)\n\n\tactionLinks: ->\n# remove 'method_id' and 'params' properties\n\t\treturn _.map(@actionLinks, (actionLink, key) -> _.extend({ id: key }, _.omit(actionLink, 'method_id', 'params')))\n\n\thideActionLinks: ->\n\t\treturn 'hidden' if _.isEmpty(@actionLinks)\n\n\tinjectIndex: (data, index) ->\n\t\tdata.index = index\n\t\treturn\n\n\thideCog: ->\n\t\tsubscription = RocketChat.models.Subscriptions.findOne({ rid: this.rid });\n\t\treturn 'hidden' if not subscription?\n\n\thideUsernames: ->\n\t\tprefs = Meteor.user()?.settings?.preferences\n\t\treturn if prefs?.hideUsernames\n\n\tmsgType: ->\n\t\treturn true if Template.instance().msgType?.id is 'chart'\n\n\tchartData: ->\n\t\treturn Template.instance().chartData\n\nTemplate.message.onCreated ->\n\tmsg = Template.currentData()\n\n\t@wasEdited = msg.editedAt? and not RocketChat.MessageTypes.isSystemMessage(msg)\n\n\t@chartData = JSON.stringify(msg.chartData)\n\n\t@msgType = RocketChat.MessageTypes.getType(msg)\n\n\t@body = do ->\n\t\t#TODO : 메시지 유형별로 화면에 표시할 내용이 다르게 표시할 경우 여기서 처리하되면 됨\n\t\t# 차트 보여주기, 아이템 링크 변환등.\n\t\t# renderMessageBody.js를 호출\n\t\tisSystemMessage = RocketChat.MessageTypes.isSystemMessage msg\n\t\tmessageType = RocketChat.MessageTypes.getType msg\n\n\t\tif messageType?.render?\n\t\t\tmsg = messageType.render(msg)\n\t\telse if messageType?.template?\n# render template\n\t\telse if messageType?.message?\n\t\t\tif messageType.data?(msg)?\n\t\t\t\tmsg = TAPi18n.__(messageType.message, messageType.data(msg))\n\t\t\telse\n\t\t\t\tmsg = TAPi18n.__(messageType.message)\n\t\telse\n\t\t\tif msg.u?.username is RocketChat.settings.get('Chatops_Username')\n\t\t\t\tmsg.html = msg.msg\n\t\t\t\tmsg = RocketChat.callbacks.run 'renderMentions', msg\n\t\t\t\t# console.log JSON.stringify message\n\t\t\t\tmsg = msg.html\n\t\t\telse\n\t\t\t\tmsg = renderMessageBody msg\n\n\t\tif isSystemMessage\n\t\t\tmsg.html = RocketChat.Markdown.parse msg.html\n\n\t\treturn msg\n\nTemplate.message.onViewRendered = (context) ->\n\tview = this\n\n\tthis._domrange.onAttached (domRange) ->\n\n\t\tcurrentNode = domRange.lastNode()\n\t\tcurrentDataset = currentNode.dataset\n\t\tpreviousNode = currentNode.previousElementSibling\n\t\tnextNode = currentNode.nextElementSibling\n\t\t$currentNode = $(currentNode)\n\t\t$nextNode = $(nextNode)\n\n\t\tunless previousNode?\n\t\t\t$currentNode.addClass('new-day').removeClass('sequential')\n\n\t\telse if previousNode?.dataset?\n\t\t\tpreviousDataset = previousNode.dataset\n\t\t\tpreviousMessageDate = new Date(parseInt(previousDataset.timestamp))\n\t\t\tcurrentMessageDate = new Date(parseInt(currentDataset.timestamp))\n\n\t\t\tif previousMessageDate.toDateString() isnt currentMessageDate.toDateString()\n\t\t\t\t$currentNode.addClass('new-day').removeClass('sequential')\n\t\t\telse\n\t\t\t\t$currentNode.removeClass('new-day')\n\n\t\t\tif previousDataset.groupable is 'false' or currentDataset.groupable is 'false'\n\t\t\t\t$currentNode.removeClass('sequential')\n\t\t\telse\n\t\t\t\tif previousDataset.username isnt currentDataset.username or parseInt(currentDataset.timestamp) - parseInt(previousDataset.timestamp) > RocketChat.settings.get('Message_GroupingPeriod') * 1000\n\t\t\t\t\t$currentNode.removeClass('sequential')\n\t\t\t\telse if not $currentNode.hasClass 'new-day'\n\t\t\t\t\t$currentNode.addClass('sequential')\n\n\t\tif nextNode?.dataset?\n\t\t\tnextDataset = nextNode.dataset\n\n\t\t\tif nextDataset.date isnt currentDataset.date\n\t\t\t\t$nextNode.addClass('new-day').removeClass('sequential')\n\t\t\telse\n\t\t\t\t$nextNode.removeClass('new-day')\n\n\t\t\tif nextDataset.groupable isnt 'false'\n\t\t\t\tif nextDataset.username isnt currentDataset.username or parseInt(nextDataset.timestamp) - parseInt(currentDataset.timestamp) > RocketChat.settings.get('Message_GroupingPeriod') * 1000\n\t\t\t\t\t$nextNode.removeClass('sequential')\n\t\t\t\telse if not $nextNode.hasClass 'new-day'\n\t\t\t\t\t$nextNode.addClass('sequential')\n\n\t\tif not nextNode?\n\t\t\ttemplateInstance = if $('#chat-window-' + context.rid)[0] then Blaze.getView($('#chat-window-' + context.rid)[0])?.templateInstance() else null\n\n\t\t\tcurrentDataset = currentNode.dataset\n\n\t\t\tif currentNode.classList.contains('own') is true\n\t\t\t\ttemplateInstance?.atBottom = true\n\t\t\telse\n\t\t\t\tif templateInstance?.firstNode && templateInstance?.atBottom is false\n\t\t\t\t\tnewMessage = templateInstance?.find(\".new-message\")\n\t\t\t\t\tnewMessage?.className = \"new-message background-primary-action-color color-content-background-color \"\n","var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\nimport moment from 'moment';\n\nTemplate.message.helpers({\n  encodeURI: function(text) {\n    return encodeURI(text);\n  },\n  isBot: function() {\n    if (this.bot != null) {\n      return 'bot';\n    }\n  },\n  roleTags: function() {\n    var ref, ref1, ref2, ref3, ref4, ref5, ref6, roles;\n    if (!RocketChat.settings.get('UI_DisplayRoles') || ((ref = Meteor.user()) != null ? (ref1 = ref.settings) != null ? (ref2 = ref1.preferences) != null ? ref2.hideRoles : void 0 : void 0 : void 0)) {\n      return [];\n    }\n    roles = _.union((ref3 = UserRoles.findOne((ref4 = this.u) != null ? ref4._id : void 0)) != null ? ref3.roles : void 0, (ref5 = RoomRoles.findOne({\n      'u._id': (ref6 = this.u) != null ? ref6._id : void 0,\n      rid: this.rid\n    })) != null ? ref5.roles : void 0);\n    return RocketChat.models.Roles.find({\n      _id: {\n        $in: roles\n      },\n      description: {\n        $exists: 1,\n        $ne: ''\n      }\n    }, {\n      fields: {\n        description: 1\n      }\n    });\n  },\n  isGroupable: function() {\n    if (this.groupable === false) {\n      return 'false';\n    }\n  },\n  isSequential: function() {\n    if (this.groupable !== false) {\n      return 'sequential';\n    }\n  },\n  avatarFromUsername: function() {\n    if ((this.avatar != null) && this.avatar[0] === '@') {\n      return this.avatar.replace(/^@/, '');\n    }\n  },\n  getEmoji: function(emoji) {\n    return renderEmoji(emoji);\n  },\n  getName: function() {\n    var ref, ref1;\n    if (this.alias) {\n      return this.alias;\n    }\n    if (RocketChat.settings.get('UI_Use_Real_Name') && ((ref = this.u) != null ? ref.name : void 0)) {\n      return this.u.name;\n    }\n    return (ref1 = this.u) != null ? ref1.username : void 0;\n  },\n  showUsername: function() {\n    var ref;\n    return this.alias || (RocketChat.settings.get('UI_Use_Real_Name') && ((ref = this.u) != null ? ref.name : void 0));\n  },\n  own: function() {\n    var ref;\n    if (((ref = this.u) != null ? ref._id : void 0) === Meteor.userId()) {\n      return 'own';\n    }\n  },\n  timestamp: function() {\n    return +this.ts;\n  },\n  chatops: function() {\n    var ref;\n    if (((ref = this.u) != null ? ref.username : void 0) === RocketChat.settings.get('Chatops_Username')) {\n      return 'chatops-message';\n    }\n  },\n  time: function() {\n    return moment(this.ts).format(RocketChat.settings.get('Message_TimeFormat'));\n  },\n  date: function() {\n    return moment(this.ts).format(RocketChat.settings.get('Message_DateFormat'));\n  },\n  isTemp: function() {\n    if (this.temp === true) {\n      return 'temp';\n    }\n  },\n  body: function() {\n    return Template.instance().body;\n  },\n  system: function(returnClass) {\n    if (RocketChat.MessageTypes.isSystemMessage(this)) {\n      if (returnClass) {\n        return 'color-info-font-color';\n      }\n      return 'system';\n    }\n  },\n  showTranslated: function() {\n    var language, ref, subscription;\n    if (RocketChat.settings.get('AutoTranslate_Enabled') && ((ref = this.u) != null ? ref._id : void 0) !== Meteor.userId() && !RocketChat.MessageTypes.isSystemMessage(this)) {\n      subscription = RocketChat.models.Subscriptions.findOne({\n        rid: this.rid,\n        'u._id': Meteor.userId()\n      }, {\n        fields: {\n          autoTranslate: 1,\n          autoTranslateLanguage: 1\n        }\n      });\n      language = RocketChat.AutoTranslate.getLanguage(this.rid);\n      return this.autoTranslateFetching || ((subscription != null ? subscription.autoTranslate : void 0) !== this.autoTranslateShowInverse && this.translations && this.translations[language]);\n    }\n  },\n  edited: function() {\n    return Template.instance().wasEdited;\n  },\n  editTime: function() {\n    if (Template.instance().wasEdited) {\n      return moment(this.editedAt).format(RocketChat.settings.get('Message_DateFormat') + ' ' + RocketChat.settings.get('Message_TimeFormat'));\n    }\n  },\n  editedBy: function() {\n    var ref;\n    if (!Template.instance().wasEdited) {\n      return \"\";\n    }\n    return ((ref = this.editedBy) != null ? ref.username : void 0) || \"?\";\n  },\n  canEdit: function() {\n    var blockEditInMinutes, currentTsDiff, editOwn, hasPermission, isEditAllowed, msgTs, ref;\n    hasPermission = RocketChat.authz.hasAtLeastOnePermission('edit-message', this.rid);\n    isEditAllowed = RocketChat.settings.get('Message_AllowEditing');\n    editOwn = ((ref = this.u) != null ? ref._id : void 0) === Meteor.userId();\n    if (!(hasPermission || (isEditAllowed && editOwn))) {\n      return;\n    }\n    blockEditInMinutes = RocketChat.settings.get('Message_AllowEditing_BlockEditInMinutes');\n    if ((blockEditInMinutes != null) && blockEditInMinutes !== 0) {\n      if (this.ts != null) {\n        msgTs = moment(this.ts);\n      }\n      if (msgTs != null) {\n        currentTsDiff = moment().diff(msgTs, 'minutes');\n      }\n      return currentTsDiff < blockEditInMinutes;\n    } else {\n      return true;\n    }\n  },\n  canDelete: function() {\n    var blockDeleteInMinutes, currentTsDiff, deleteOwn, hasPermission, isDeleteAllowed, msgTs, ref;\n    hasPermission = RocketChat.authz.hasAtLeastOnePermission('delete-message', this.rid);\n    isDeleteAllowed = RocketChat.settings.get('Message_AllowDeleting');\n    deleteOwn = ((ref = this.u) != null ? ref._id : void 0) === Meteor.userId();\n    if (!(hasPermission || (isDeleteAllowed && deleteOwn))) {\n      return;\n    }\n    blockDeleteInMinutes = RocketChat.settings.get('Message_AllowDeleting_BlockDeleteInMinutes');\n    if ((blockDeleteInMinutes != null) && blockDeleteInMinutes !== 0) {\n      if (this.ts != null) {\n        msgTs = moment(this.ts);\n      }\n      if (msgTs != null) {\n        currentTsDiff = moment().diff(msgTs, 'minutes');\n      }\n      return currentTsDiff < blockDeleteInMinutes;\n    } else {\n      return true;\n    }\n  },\n  showEditedStatus: function() {\n    return RocketChat.settings.get('Message_ShowEditedStatus');\n  },\n  label: function() {\n    if (this.i18nLabel) {\n      return t(this.i18nLabel);\n    } else if (this.label) {\n      return this.label;\n    }\n  },\n  hasOembed: function() {\n    var ref, ref1, ref2, ref3;\n    if (!(((ref = this.urls) != null ? ref.length : void 0) > 0 && (Template.oembedBaseWidget != null) && RocketChat.settings.get('API_Embed'))) {\n      return false;\n    }\n    if (ref1 = (ref2 = this.u) != null ? ref2.username : void 0, indexOf.call((ref3 = RocketChat.settings.get('API_EmbedDisabledFor')) != null ? ref3.split(',').map(function(username) {\n      return username.trim();\n    }) : void 0, ref1) >= 0) {\n      return false;\n    }\n    return true;\n  },\n  reactions: function() {\n    var emoji, msgReactions, reaction, ref, ref1, total, userUsername, usernames;\n    msgReactions = [];\n    userUsername = (ref = Meteor.user()) != null ? ref.username : void 0;\n    ref1 = this.reactions;\n    for (emoji in ref1) {\n      reaction = ref1[emoji];\n      total = reaction.usernames.length;\n      usernames = '@' + reaction.usernames.slice(0, 15).join(', @');\n      usernames = usernames.replace('@' + userUsername, t('You').toLowerCase());\n      if (total > 15) {\n        usernames = usernames + ' ' + t('And_more', {\n          length: total - 15\n        }).toLowerCase();\n      } else {\n        usernames = usernames.replace(/,([^,]+)$/, ' ' + t('and') + '$1');\n      }\n      if (usernames[0] !== '@') {\n        usernames = usernames[0].toUpperCase() + usernames.substr(1);\n      }\n      msgReactions.push({\n        emoji: emoji,\n        count: reaction.usernames.length,\n        usernames: usernames,\n        reaction: ' ' + t('Reacted_with').toLowerCase() + ' ' + emoji,\n        userReacted: reaction.usernames.indexOf(userUsername) > -1\n      });\n    }\n    return msgReactions;\n  },\n  markUserReaction: function(reaction) {\n    if (reaction.userReacted) {\n      return {\n        \"class\": 'selected'\n      };\n    }\n  },\n  hideReactions: function() {\n    if (_.isEmpty(this.reactions)) {\n      return 'hidden';\n    }\n  },\n  actionLinks: function() {\n    return _.map(this.actionLinks, function(actionLink, key) {\n      return _.extend({\n        id: key\n      }, _.omit(actionLink, 'method_id', 'params'));\n    });\n  },\n  hideActionLinks: function() {\n    if (_.isEmpty(this.actionLinks)) {\n      return 'hidden';\n    }\n  },\n  injectIndex: function(data, index) {\n    data.index = index;\n  },\n  hideCog: function() {\n    var subscription;\n    subscription = RocketChat.models.Subscriptions.findOne({\n      rid: this.rid\n    });\n    if (subscription == null) {\n      return 'hidden';\n    }\n  },\n  hideUsernames: function() {\n    var prefs, ref, ref1;\n    prefs = (ref = Meteor.user()) != null ? (ref1 = ref.settings) != null ? ref1.preferences : void 0 : void 0;\n    if (prefs != null ? prefs.hideUsernames : void 0) {\n\n    }\n  },\n  msgType: function() {\n    var ref;\n    if (((ref = Template.instance().msgType) != null ? ref.id : void 0) === 'chart') {\n      return true;\n    }\n  },\n  chartData: function() {\n    return Template.instance().chartData;\n  }\n});\n\nTemplate.message.onCreated(function() {\n  var msg;\n  msg = Template.currentData();\n  this.wasEdited = (msg.editedAt != null) && !RocketChat.MessageTypes.isSystemMessage(msg);\n  this.chartData = JSON.stringify(msg.chartData);\n  this.msgType = RocketChat.MessageTypes.getType(msg);\n  return this.body = (function() {\n    var isSystemMessage, messageType, ref;\n    isSystemMessage = RocketChat.MessageTypes.isSystemMessage(msg);\n    messageType = RocketChat.MessageTypes.getType(msg);\n    if ((messageType != null ? messageType.render : void 0) != null) {\n      msg = messageType.render(msg);\n    } else if ((messageType != null ? messageType.template : void 0) != null) {\n\n    } else if ((messageType != null ? messageType.message : void 0) != null) {\n      if ((typeof messageType.data === \"function\" ? messageType.data(msg) : void 0) != null) {\n        msg = TAPi18n.__(messageType.message, messageType.data(msg));\n      } else {\n        msg = TAPi18n.__(messageType.message);\n      }\n    } else {\n      if (((ref = msg.u) != null ? ref.username : void 0) === RocketChat.settings.get('Chatops_Username')) {\n        msg.html = msg.msg;\n        msg = RocketChat.callbacks.run('renderMentions', msg);\n        msg = msg.html;\n      } else {\n        msg = renderMessageBody(msg);\n      }\n    }\n    if (isSystemMessage) {\n      msg.html = RocketChat.Markdown.parse(msg.html);\n    }\n    return msg;\n  })();\n});\n\nTemplate.message.onViewRendered = function(context) {\n  var view;\n  view = this;\n  return this._domrange.onAttached(function(domRange) {\n    var $currentNode, $nextNode, currentDataset, currentMessageDate, currentNode, newMessage, nextDataset, nextNode, previousDataset, previousMessageDate, previousNode, ref, templateInstance;\n    currentNode = domRange.lastNode();\n    currentDataset = currentNode.dataset;\n    previousNode = currentNode.previousElementSibling;\n    nextNode = currentNode.nextElementSibling;\n    $currentNode = $(currentNode);\n    $nextNode = $(nextNode);\n    if (previousNode == null) {\n      $currentNode.addClass('new-day').removeClass('sequential');\n    } else if ((previousNode != null ? previousNode.dataset : void 0) != null) {\n      previousDataset = previousNode.dataset;\n      previousMessageDate = new Date(parseInt(previousDataset.timestamp));\n      currentMessageDate = new Date(parseInt(currentDataset.timestamp));\n      if (previousMessageDate.toDateString() !== currentMessageDate.toDateString()) {\n        $currentNode.addClass('new-day').removeClass('sequential');\n      } else {\n        $currentNode.removeClass('new-day');\n      }\n      if (previousDataset.groupable === 'false' || currentDataset.groupable === 'false') {\n        $currentNode.removeClass('sequential');\n      } else {\n        if (previousDataset.username !== currentDataset.username || parseInt(currentDataset.timestamp) - parseInt(previousDataset.timestamp) > RocketChat.settings.get('Message_GroupingPeriod') * 1000) {\n          $currentNode.removeClass('sequential');\n        } else if (!$currentNode.hasClass('new-day')) {\n          $currentNode.addClass('sequential');\n        }\n      }\n    }\n    if ((nextNode != null ? nextNode.dataset : void 0) != null) {\n      nextDataset = nextNode.dataset;\n      if (nextDataset.date !== currentDataset.date) {\n        $nextNode.addClass('new-day').removeClass('sequential');\n      } else {\n        $nextNode.removeClass('new-day');\n      }\n      if (nextDataset.groupable !== 'false') {\n        if (nextDataset.username !== currentDataset.username || parseInt(nextDataset.timestamp) - parseInt(currentDataset.timestamp) > RocketChat.settings.get('Message_GroupingPeriod') * 1000) {\n          $nextNode.removeClass('sequential');\n        } else if (!$nextNode.hasClass('new-day')) {\n          $nextNode.addClass('sequential');\n        }\n      }\n    }\n    if (nextNode == null) {\n      templateInstance = $('#chat-window-' + context.rid)[0] ? (ref = Blaze.getView($('#chat-window-' + context.rid)[0])) != null ? ref.templateInstance() : void 0 : null;\n      currentDataset = currentNode.dataset;\n      if (currentNode.classList.contains('own') === true) {\n        return templateInstance != null ? templateInstance.atBottom = true : void 0;\n      } else {\n        if ((templateInstance != null ? templateInstance.firstNode : void 0) && (templateInstance != null ? templateInstance.atBottom : void 0) === false) {\n          newMessage = templateInstance != null ? templateInstance.find(\".new-message\") : void 0;\n          return newMessage != null ? newMessage.className = \"new-message background-primary-action-color color-content-background-color \" : void 0;\n        }\n      }\n    }\n  });\n};\n","import toastr from 'toastr'\nimport mime from 'mime-type/with-db'\nimport moment from 'moment'\nimport {VRecDialog} from 'meteor/rocketchat:ui-vrecord'\nimport {ChartDialog} from 'meteor/lily:ui-chart'\n\nkatexSyntax = ->\n\tif RocketChat.katex.katex_enabled()\n\t\treturn \"$$KaTeX$$\"   if RocketChat.katex.dollar_syntax_enabled()\n\t\treturn \"\\\\[KaTeX\\\\]\" if RocketChat.katex.parenthesis_syntax_enabled()\n\n\treturn false\n\nTemplate.messageBox.helpers\n\troomName: ->\n\t\troomData = Session.get('roomData' + this._id)\n\t\treturn '' unless roomData\n\n\t\tif roomData.t is 'd'\n\t\t\treturn ChatSubscription.findOne({ rid: this._id }, { fields: { name: 1 } })?.name\n\t\telse\n\t\t\treturn roomData.name\n\tshowMarkdown: ->\n\t\treturn RocketChat.Markdown\n\tshowMarkdownCode: ->\n\t\treturn RocketChat.MarkdownCode\n\tshowKatex: ->\n\t\treturn RocketChat.katex\n\tkatexSyntax: ->\n\t\treturn katexSyntax()\n\tshowFormattingTips: ->\n\t\treturn RocketChat.settings.get('Message_ShowFormattingTips') and (RocketChat.Markdown or RocketChat.MarkdownCode or katexSyntax())\n\tcanJoin: ->\n\t\treturn Meteor.userId()? and RocketChat.roomTypes.verifyShowJoinLink @_id\n\tjoinCodeRequired: ->\n\t\treturn Session.get('roomData' + this._id)?.joinCodeRequired\n\tsubscribed: ->\n\t\treturn RocketChat.roomTypes.verifyCanSendMessage @_id\n\tallowedToSend: ->\n\t\tif RocketChat.roomTypes.readOnly @_id, Meteor.user()\n\t\t\treturn false\n\n\t\tif RocketChat.roomTypes.archived @_id\n\t\t\treturn false\n\n\t\troomData = Session.get('roomData' + this._id)\n\t\tif roomData?.t is 'd'\n\t\t\tsubscription = ChatSubscription.findOne({ rid: this._id }, { fields: { archived: 1, blocked: 1, blocker: 1 } })\n\t\t\tif subscription and (subscription.archived or subscription.blocked or subscription.blocker)\n\t\t\t\treturn false\n\n\t\treturn true\n\tisBlockedOrBlocker: ->\n\t\troomData = Session.get('roomData' + this._id)\n\t\tif roomData?.t is 'd'\n\t\t\tsubscription = ChatSubscription.findOne({ rid: this._id }, { fields: { blocked: 1, blocker: 1 } })\n\t\t\tif subscription and (subscription.blocked or subscription.blocker)\n\t\t\t\treturn true\n\n\tgetPopupConfig: ->\n\t\ttemplate = Template.instance()\n\t\treturn {\n\t\t\tgetInput: ->\n\t\t\t\treturn template.find('.input-message')\n\t\t}\n\tusersTyping: ->\n\t\tusers = MsgTyping.get @_id\n\t\tif users.length is 0\n\t\t\treturn\n\t\tif users.length is 1\n\t\t\treturn {\n\t\t\t\tmulti: false\n\t\t\t\tselfTyping: MsgTyping.selfTyping.get()\n\t\t\t\tusers: users[0]\n\t\t\t}\n\t\t# usernames = _.map messages, (message) -> return message.u.username\n\t\tlast = users.pop()\n\t\tif users.length > 4\n\t\t\tlast = t('others')\n\t\t# else\n\t\tusernames = users.join(', ')\n\t\tusernames = [usernames, last]\n\t\treturn {\n\t\t\tmulti: true\n\t\t\tselfTyping: MsgTyping.selfTyping.get()\n\t\t\tusers: usernames.join \" #{t 'and'} \"\n\t\t}\n\n\tgroupAttachHidden: ->\n\t\treturn 'hidden' if RocketChat.settings.get('Message_Attachments_GroupAttach')\n\n\tfileUploadEnabled: ->\n\t\treturn RocketChat.settings.get('FileUpload_Enabled')\n\n\tfileUploadAllowedMediaTypes: ->\n\t\treturn RocketChat.settings.get('FileUpload_MediaTypeWhiteList')\n\n\tshowFileUpload: ->\n\t\tif (RocketChat.settings.get('FileUpload_Enabled'))\n\t\t\troomData = Session.get('roomData' + this._id)\n\t\t\tif roomData?.t is 'd'\n\t\t\t\treturn RocketChat.settings.get('FileUpload_Enabled_Direct')\n\t\t\telse\n\t\t\t\treturn true\n\t\telse\n\t\t\treturn RocketChat.settings.get('FileUpload_Enabled')\n\n\n\tshowMic: ->\n\t\treturn Template.instance().showMicButton.get()\n\n\tshowVRec: ->\n\t\treturn Template.instance().showVideoRec.get()\n\n\tshowChart: ->\n\t\treturn Template.instance().showChartButton.get()\n\n\tshowSend: ->\n\t\tif not Template.instance().isMessageFieldEmpty.get()\n\t\t\treturn 'show-send'\n\n\tshowLocation: ->\n\t\treturn RocketChat.Geolocation.get() isnt false\n\n\tnotSubscribedTpl: ->\n\t\treturn RocketChat.roomTypes.getNotSubscribedTpl @_id\n\n\tshowSandstorm: ->\n\t\treturn Meteor.settings.public.sandstorm && !Meteor.isCordova\n\n\tanonymousRead: ->\n\t\treturn not Meteor.userId()? and RocketChat.settings.get('Accounts_AllowAnonymousRead') is true\n\n\tanonymousWrite: ->\n\t\treturn not Meteor.userId()? and RocketChat.settings.get('Accounts_AllowAnonymousRead') is true and RocketChat.settings.get('Accounts_AllowAnonymousWrite') is true\n\nfirefoxPasteUpload = (fn) ->\n\tuser = navigator.userAgent.match(/Firefox\\/(\\d+)\\.\\d/)\n\tif !user or user[1] > 49\n\t\treturn fn\n\treturn (event, instance) ->\n\t\tif (event.originalEvent.ctrlKey or event.originalEvent.metaKey) and (event.keyCode == 86)\n\t\t\ttextarea = instance.find(\"textarea\")\n\t\t\tselectionStart = textarea.selectionStart\n\t\t\tselectionEnd = textarea.selectionEnd\n\t\t\tcontentEditableDiv = instance.find('#msg_contenteditable')\n\t\t\tcontentEditableDiv.focus()\n\t\t\tMeteor.setTimeout ->\n\t\t\t\tpastedImg = contentEditableDiv.querySelector 'img'\n\t\t\t\ttextareaContent = textarea.value\n\t\t\t\tstartContent = textareaContent.substring(0, selectionStart)\n\t\t\t\tendContent = textareaContent.substring(selectionEnd)\n\t\t\t\trestoreSelection = (pastedText) ->\n\t\t\t\t\ttextarea.value = startContent + pastedText + endContent\n\t\t\t\t\ttextarea.selectionStart = selectionStart + pastedText.length\n\t\t\t\t\ttextarea.selectionEnd = textarea.selectionStart\n\t\t\t\tcontentEditableDiv.innerHTML = '' if pastedImg\n\t\t\t\ttextarea.focus\n\t\t\t\treturn if (!pastedImg || contentEditableDiv.innerHTML.length > 0)\n\t\t\t\t\t[].slice.call(contentEditableDiv.querySelectorAll(\"br\")).forEach (el) ->\n\t\t\t\t\t\tcontentEditableDiv.replaceChild(new Text(\"\\n\") , el)\n\t\t\t\t\t\trestoreSelection(contentEditableDiv.innerText)\n\t\t\t\timageSrc = pastedImg.getAttribute(\"src\")\n\t\t\t\tif imageSrc.match(/^data:image/)\n\t\t\t\t\tfetch(imageSrc)\n\t\t\t\t\t.then((img)->\n\t\t\t\t\t\treturn img.blob())\n\t\t\t\t\t.then (blob)->\n\t\t\t\t\t\tfileUpload [{\n\t\t\t\t\t\t\tfile: blob\n\t\t\t\t\t\t\tname: 'Clipboard'\n\t\t\t\t\t\t}]\n\t\t\t, 150\n\t\tfn?.apply @, arguments\n\n\nTemplate.messageBox.events\n\t'click .join': (event) ->\n\t\tevent.stopPropagation()\n\t\tevent.preventDefault()\n\t\tMeteor.call 'joinRoom', @_id, Template.instance().$('[name=joinCode]').val(), (err) =>\n\t\t\tif err?\n\t\t\t\ttoastr.error t(err.reason)\n\n\t\t\tif RocketChat.authz.hasAllPermission('preview-c-room') is false and RoomHistoryManager.getRoom(@_id).loaded is 0\n\t\t\t\tRoomManager.getOpenedRoomByRid(@_id).streamActive = false\n\t\t\t\tRoomManager.getOpenedRoomByRid(@_id).ready = false\n\t\t\t\tRoomHistoryManager.getRoom(@_id).loaded = undefined\n\t\t\t\tRoomManager.computation.invalidate()\n\n\t'click .register': (event) ->\n\t\tevent.stopPropagation()\n\t\tevent.preventDefault()\n\t\tSession.set('forceLogin', true)\n\n\t'click .register-anonymous': (event) ->\n\t\tevent.stopPropagation()\n\t\tevent.preventDefault()\n\n\t\tMeteor.call 'registerUser', {}, (error, loginData) ->\n\t\t\tif loginData && loginData.token\n\t\t\t\tMeteor.loginWithToken loginData.token\n\n\n\t'focus .input-message': (event, instance) ->\n\t\tKonchatNotification.removeRoomNotification @_id\n\t\tchatMessages[@_id].input = instance.find('.input-message')\n\n\t'click .send-button': (event, instance) ->\n\t\tinput = instance.find('.input-message')\n\t\tchatMessages[@_id].send(@_id, input, =>\n\t\t\t# fixes https://github.com/RocketChat/Rocket.Chat/issues/3037\n\t\t\t# at this point, the input is cleared and ready for autogrow\n\t\t\tinput.updateAutogrow()\n\t\t\tinstance.isMessageFieldEmpty.set(chatMessages[@_id].isEmpty())\n\t\t)\n\t\tinput.focus()\n\n\t'keyup .input-message': (event, instance) ->\n\t\tchatMessages[@_id].keyup(@_id, event, instance)\n\t\tinstance.isMessageFieldEmpty.set(chatMessages[@_id].isEmpty())\n\n\t'paste .input-message': (e, instance) ->\n\t\tMeteor.setTimeout ->\n\t\t\tinput = instance.find('.input-message')\n\t\t\tinput.updateAutogrow?()\n\t\t, 50\n\n\t\tif not e.originalEvent.clipboardData?\n\t\t\treturn\n\t\titems = e.originalEvent.clipboardData.items\n\t\tfiles = []\n\t\tfor item in items\n\t\t\tif item.kind is 'file' and item.type.indexOf('image/') isnt -1\n\t\t\t\te.preventDefault()\n\t\t\t\tfiles.push\n\t\t\t\t\tfile: item.getAsFile()\n\t\t\t\t\tname: 'Clipboard - ' + moment().format(RocketChat.settings.get('Message_TimeAndDateFormat'))\n\n\t\tif files.length\n\t\t\tfileUpload files\n\t\telse\n\t\t\tinstance.isMessageFieldEmpty.set(false)\n\n\t'keydown .input-message': firefoxPasteUpload((event, instance) ->\n\t\tchatMessages[@_id].keydown(@_id, event, Template.instance()))\n\n\t'input .input-message': (event) ->\n\t\tchatMessages[@_id].valueChanged(@_id, event, Template.instance())\n\n\t'propertychange .input-message': (event) ->\n\t\tif event.originalEvent.propertyName is 'value'\n\t\t\tchatMessages[@_id].valueChanged(@_id, event, Template.instance())\n\n\t\"click .editing-commands-cancel > button\": (e) ->\n\t\tchatMessages[@_id].clearEditing()\n\n\t\"click .editing-commands-save > button\": (e) ->\n\t\tchatMessages[@_id].send(@_id, chatMessages[@_id].input)\n\n\t'change .message-form input[type=file]': (event, template) ->\n\t\te = event.originalEvent or event\n\t\tfiles = e.target.files\n\t\tif not files or files.length is 0\n\t\t\tfiles = e.dataTransfer?.files or []\n\n\t\tfilesToUpload = []\n\t\tfor file in files\n\t\t\t# `file.type = mime.lookup(file.name)` does not work.\n\t\t\tObject.defineProperty(file, 'type', { value: mime.lookup(file.name) })\n\t\t\tfilesToUpload.push\n\t\t\t\tfile: file\n\t\t\t\tname: file.name\n\n\t\tfileUpload filesToUpload\n\n\t\"click .message-buttons.share\": (e, t) ->\n\t\tconsole.log('messageButtonClick')\n\t\tt.$('.share-items').toggleClass('hidden')\n\t\tt.$('.message-buttons.share').toggleClass('active')\n\n\t'click .message-form .message-buttons.location': (event, instance) ->\n\t\troomId = @_id\n\n\t\tposition = RocketChat.Geolocation.get()\n\n\t\tlatitude = position.coords.latitude\n\t\tlongitude = position.coords.longitude\n\n\t\ttext = \"\"\"\n\t\t\t<div class=\"location-preview\">\n\t\t\t\t<img style=\"height: 250px; width: 250px;\" src=\"https://maps.googleapis.com/maps/api/staticmap?zoom=14&size=250x250&markers=color:gray%7Clabel:%7C#{latitude},#{longitude}&key=#{RocketChat.settings.get('MapView_GMapsAPIKey')}\" />\n\t\t\t</div>\n\t\t\"\"\"\n\n\t\tswal\n\t\t\ttitle: t('Share_Location_Title')\n\t\t\ttext: text\n\t\t\tshowCancelButton: true\n\t\t\tcloseOnConfirm: true\n\t\t\tcloseOnCancel: true\n\t\t\thtml: true\n\t\t, (isConfirm) ->\n\t\t\tif isConfirm isnt true\n\t\t\t\treturn\n\n\t\t\tMeteor.call \"sendMessage\",\n\t\t\t\t_id: Random.id()\n\t\t\t\trid: roomId\n\t\t\t\tmsg: \"\"\n\t\t\t\tlocation:\n\t\t\t\t\ttype: 'Point'\n\t\t\t\t\tcoordinates: [ longitude, latitude ]\n\n\n\t'click .message-form .mic': (e, t) ->\n\t\tAudioRecorder.start ->\n\t\t\tt.$('.stop-mic').removeClass('hidden')\n\t\t\tt.$('.mic').addClass('hidden')\n\n\t'click .message-form .video-button': (e, t) ->\n\t\tif VRecDialog.opened\n\t\t\tVRecDialog.close()\n\t\telse\n\t\t\tVRecDialog.open(e.currentTarget)\n\n\t'click .message-form .chart-button': (e, t) ->\n\t\tif ChartDialog.opened\n\t\t\tChartDialog.close()\n\t\telse\n\t\t\tChartDialog.open(e.currentTarget, @_id)\n\n\t'click .message-form .stop-mic': (e, t) ->\n\t\tAudioRecorder.stop (blob) ->\n\t\t\tfileUpload [{\n\t\t\t\tfile: blob\n\t\t\t\ttype: 'audio'\n\t\t\t\tname: TAPi18n.__('Audio record') + '.wav'\n\t\t\t}]\n\n\t\tt.$('.stop-mic').addClass('hidden')\n\t\tt.$('.mic').removeClass('hidden')\n\n\t'click .sandstorm-offer': (e, t) ->\n\t\troomId = @_id\n\t\tRocketChat.Sandstorm.request \"uiView\", (err, data) =>\n\t\t\tif err or !data.token\n\t\t\t\tconsole.error err\n\t\t\t\treturn\n\t\t\tMeteor.call \"sandstormClaimRequest\", data.token, data.descriptor, (err, viewInfo) =>\n\t\t\t\tif err\n\t\t\t\t\tconsole.error err\n\t\t\t\t\treturn\n\n\t\t\t\tMeteor.call \"sendMessage\", {\n\t\t\t\t\t_id: Random.id()\n\t\t\t\t\trid: roomId\n\t\t\t\t\tmsg: \"\"\n\t\t\t\t\turls: [{ url: \"grain://sandstorm\", sandstormViewInfo: viewInfo }]\n\t\t\t\t}\n\nTemplate.messageBox.onCreated ->\n\t@isMessageFieldEmpty = new ReactiveVar true\n\t@showMicButton = new ReactiveVar false\n\t@showVideoRec = new ReactiveVar false\n\t@showChartButton = new ReactiveVar true\n\n\t@autorun =>\n\t\tvideoRegex = /video\\/webm|video\\/\\*/i\n\t\tvideoEnabled = !RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\") || RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\").match(videoRegex)\n\t\tif RocketChat.settings.get('Message_VideoRecorderEnabled') and (navigator.getUserMedia? or navigator.webkitGetUserMedia?) and videoEnabled and RocketChat.settings.get('FileUpload_Enabled')\n\t\t\t@showVideoRec.set true\n\t\telse\n\t\t\t@showVideoRec.set false\n\n\t\twavRegex = /audio\\/wav|audio\\/\\*/i\n\t\twavEnabled = !RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\") || RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\").match(wavRegex)\n\t\tif RocketChat.settings.get('Message_AudioRecorderEnabled') and (navigator.getUserMedia? or navigator.webkitGetUserMedia?) and wavEnabled and RocketChat.settings.get('FileUpload_Enabled')\n\t\t\t@showMicButton.set true\n\t\telse\n\t\t\t@showMicButton.set false\n\n\nMeteor.startup ->\n\tRocketChat.Geolocation = new ReactiveVar false\n\n\tTracker.autorun ->\n\t\tif RocketChat.settings.get('MapView_Enabled') is true and RocketChat.settings.get('MapView_GMapsAPIKey')?.length and navigator.geolocation?.getCurrentPosition?\n\t\t\tsuccess = (position) =>\n\t\t\t\tRocketChat.Geolocation.set position\n\n\t\t\terror = (error) =>\n\t\t\t\tconsole.log 'Error getting your geolocation', error\n\t\t\t\tRocketChat.Geolocation.set false\n\n\t\t\toptions =\n\t\t\t\tenableHighAccuracy: true\n\t\t\t\tmaximumAge: 0\n\t\t\t\ttimeout: 10000\n\n\t\t\tnavigator.geolocation.watchPosition success, error\n\t\telse\n\t\t\tRocketChat.Geolocation.set false\n","var firefoxPasteUpload, katexSyntax;\n\nimport toastr from 'toastr';\n\nimport mime from 'mime-type/with-db';\n\nimport moment from 'moment';\n\nimport {\n  VRecDialog\n} from 'meteor/rocketchat:ui-vrecord';\n\nimport {\n  ChartDialog\n} from 'meteor/lily:ui-chart';\n\nkatexSyntax = function() {\n  if (RocketChat.katex.katex_enabled()) {\n    if (RocketChat.katex.dollar_syntax_enabled()) {\n      return \"$$KaTeX$$\";\n    }\n    if (RocketChat.katex.parenthesis_syntax_enabled()) {\n      return \"\\\\[KaTeX\\\\]\";\n    }\n  }\n  return false;\n};\n\nTemplate.messageBox.helpers({\n  roomName: function() {\n    var ref, roomData;\n    roomData = Session.get('roomData' + this._id);\n    if (!roomData) {\n      return '';\n    }\n    if (roomData.t === 'd') {\n      return (ref = ChatSubscription.findOne({\n        rid: this._id\n      }, {\n        fields: {\n          name: 1\n        }\n      })) != null ? ref.name : void 0;\n    } else {\n      return roomData.name;\n    }\n  },\n  showMarkdown: function() {\n    return RocketChat.Markdown;\n  },\n  showMarkdownCode: function() {\n    return RocketChat.MarkdownCode;\n  },\n  showKatex: function() {\n    return RocketChat.katex;\n  },\n  katexSyntax: function() {\n    return katexSyntax();\n  },\n  showFormattingTips: function() {\n    return RocketChat.settings.get('Message_ShowFormattingTips') && (RocketChat.Markdown || RocketChat.MarkdownCode || katexSyntax());\n  },\n  canJoin: function() {\n    return (Meteor.userId() != null) && RocketChat.roomTypes.verifyShowJoinLink(this._id);\n  },\n  joinCodeRequired: function() {\n    var ref;\n    return (ref = Session.get('roomData' + this._id)) != null ? ref.joinCodeRequired : void 0;\n  },\n  subscribed: function() {\n    return RocketChat.roomTypes.verifyCanSendMessage(this._id);\n  },\n  allowedToSend: function() {\n    var roomData, subscription;\n    if (RocketChat.roomTypes.readOnly(this._id, Meteor.user())) {\n      return false;\n    }\n    if (RocketChat.roomTypes.archived(this._id)) {\n      return false;\n    }\n    roomData = Session.get('roomData' + this._id);\n    if ((roomData != null ? roomData.t : void 0) === 'd') {\n      subscription = ChatSubscription.findOne({\n        rid: this._id\n      }, {\n        fields: {\n          archived: 1,\n          blocked: 1,\n          blocker: 1\n        }\n      });\n      if (subscription && (subscription.archived || subscription.blocked || subscription.blocker)) {\n        return false;\n      }\n    }\n    return true;\n  },\n  isBlockedOrBlocker: function() {\n    var roomData, subscription;\n    roomData = Session.get('roomData' + this._id);\n    if ((roomData != null ? roomData.t : void 0) === 'd') {\n      subscription = ChatSubscription.findOne({\n        rid: this._id\n      }, {\n        fields: {\n          blocked: 1,\n          blocker: 1\n        }\n      });\n      if (subscription && (subscription.blocked || subscription.blocker)) {\n        return true;\n      }\n    }\n  },\n  getPopupConfig: function() {\n    var template;\n    template = Template.instance();\n    return {\n      getInput: function() {\n        return template.find('.input-message');\n      }\n    };\n  },\n  usersTyping: function() {\n    var last, usernames, users;\n    users = MsgTyping.get(this._id);\n    if (users.length === 0) {\n      return;\n    }\n    if (users.length === 1) {\n      return {\n        multi: false,\n        selfTyping: MsgTyping.selfTyping.get(),\n        users: users[0]\n      };\n    }\n    last = users.pop();\n    if (users.length > 4) {\n      last = t('others');\n    }\n    usernames = users.join(', ');\n    usernames = [usernames, last];\n    return {\n      multi: true,\n      selfTyping: MsgTyping.selfTyping.get(),\n      users: usernames.join(\" \" + (t('and')) + \" \")\n    };\n  },\n  groupAttachHidden: function() {\n    if (RocketChat.settings.get('Message_Attachments_GroupAttach')) {\n      return 'hidden';\n    }\n  },\n  fileUploadEnabled: function() {\n    return RocketChat.settings.get('FileUpload_Enabled');\n  },\n  fileUploadAllowedMediaTypes: function() {\n    return RocketChat.settings.get('FileUpload_MediaTypeWhiteList');\n  },\n  showFileUpload: function() {\n    var roomData;\n    if (RocketChat.settings.get('FileUpload_Enabled')) {\n      roomData = Session.get('roomData' + this._id);\n      if ((roomData != null ? roomData.t : void 0) === 'd') {\n        return RocketChat.settings.get('FileUpload_Enabled_Direct');\n      } else {\n        return true;\n      }\n    } else {\n      return RocketChat.settings.get('FileUpload_Enabled');\n    }\n  },\n  showMic: function() {\n    return Template.instance().showMicButton.get();\n  },\n  showVRec: function() {\n    return Template.instance().showVideoRec.get();\n  },\n  showChart: function() {\n    return Template.instance().showChartButton.get();\n  },\n  showSend: function() {\n    if (!Template.instance().isMessageFieldEmpty.get()) {\n      return 'show-send';\n    }\n  },\n  showLocation: function() {\n    return RocketChat.Geolocation.get() !== false;\n  },\n  notSubscribedTpl: function() {\n    return RocketChat.roomTypes.getNotSubscribedTpl(this._id);\n  },\n  showSandstorm: function() {\n    return Meteor.settings[\"public\"].sandstorm && !Meteor.isCordova;\n  },\n  anonymousRead: function() {\n    return (Meteor.userId() == null) && RocketChat.settings.get('Accounts_AllowAnonymousRead') === true;\n  },\n  anonymousWrite: function() {\n    return (Meteor.userId() == null) && RocketChat.settings.get('Accounts_AllowAnonymousRead') === true && RocketChat.settings.get('Accounts_AllowAnonymousWrite') === true;\n  }\n});\n\nfirefoxPasteUpload = function(fn) {\n  var user;\n  user = navigator.userAgent.match(/Firefox\\/(\\d+)\\.\\d/);\n  if (!user || user[1] > 49) {\n    return fn;\n  }\n  return function(event, instance) {\n    var contentEditableDiv, selectionEnd, selectionStart, textarea;\n    if ((event.originalEvent.ctrlKey || event.originalEvent.metaKey) && (event.keyCode === 86)) {\n      textarea = instance.find(\"textarea\");\n      selectionStart = textarea.selectionStart;\n      selectionEnd = textarea.selectionEnd;\n      contentEditableDiv = instance.find('#msg_contenteditable');\n      contentEditableDiv.focus();\n      Meteor.setTimeout(function() {\n        var endContent, imageSrc, pastedImg, restoreSelection, startContent, textareaContent;\n        pastedImg = contentEditableDiv.querySelector('img');\n        textareaContent = textarea.value;\n        startContent = textareaContent.substring(0, selectionStart);\n        endContent = textareaContent.substring(selectionEnd);\n        restoreSelection = function(pastedText) {\n          textarea.value = startContent + pastedText + endContent;\n          textarea.selectionStart = selectionStart + pastedText.length;\n          return textarea.selectionEnd = textarea.selectionStart;\n        };\n        if (pastedImg) {\n          contentEditableDiv.innerHTML = '';\n        }\n        textarea.focus;\n        if (!pastedImg || contentEditableDiv.innerHTML.length > 0) {\n          return [].slice.call(contentEditableDiv.querySelectorAll(\"br\")).forEach(function(el) {\n            contentEditableDiv.replaceChild(new Text(\"\\n\"), el);\n            return restoreSelection(contentEditableDiv.innerText);\n          });\n        }\n        imageSrc = pastedImg.getAttribute(\"src\");\n        if (imageSrc.match(/^data:image/)) {\n          return fetch(imageSrc).then(function(img) {\n            return img.blob();\n          }).then(function(blob) {\n            return fileUpload([\n              {\n                file: blob,\n                name: 'Clipboard'\n              }\n            ]);\n          });\n        }\n      }, 150);\n    }\n    return fn != null ? fn.apply(this, arguments) : void 0;\n  };\n};\n\nTemplate.messageBox.events({\n  'click .join': function(event) {\n    event.stopPropagation();\n    event.preventDefault();\n    return Meteor.call('joinRoom', this._id, Template.instance().$('[name=joinCode]').val(), (function(_this) {\n      return function(err) {\n        if (err != null) {\n          toastr.error(t(err.reason));\n        }\n        if (RocketChat.authz.hasAllPermission('preview-c-room') === false && RoomHistoryManager.getRoom(_this._id).loaded === 0) {\n          RoomManager.getOpenedRoomByRid(_this._id).streamActive = false;\n          RoomManager.getOpenedRoomByRid(_this._id).ready = false;\n          RoomHistoryManager.getRoom(_this._id).loaded = void 0;\n          return RoomManager.computation.invalidate();\n        }\n      };\n    })(this));\n  },\n  'click .register': function(event) {\n    event.stopPropagation();\n    event.preventDefault();\n    return Session.set('forceLogin', true);\n  },\n  'click .register-anonymous': function(event) {\n    event.stopPropagation();\n    event.preventDefault();\n    return Meteor.call('registerUser', {}, function(error, loginData) {\n      if (loginData && loginData.token) {\n        return Meteor.loginWithToken(loginData.token);\n      }\n    });\n  },\n  'focus .input-message': function(event, instance) {\n    KonchatNotification.removeRoomNotification(this._id);\n    return chatMessages[this._id].input = instance.find('.input-message');\n  },\n  'click .send-button': function(event, instance) {\n    var input;\n    input = instance.find('.input-message');\n    chatMessages[this._id].send(this._id, input, (function(_this) {\n      return function() {\n        input.updateAutogrow();\n        return instance.isMessageFieldEmpty.set(chatMessages[_this._id].isEmpty());\n      };\n    })(this));\n    return input.focus();\n  },\n  'keyup .input-message': function(event, instance) {\n    chatMessages[this._id].keyup(this._id, event, instance);\n    return instance.isMessageFieldEmpty.set(chatMessages[this._id].isEmpty());\n  },\n  'paste .input-message': function(e, instance) {\n    var files, i, item, items, len;\n    Meteor.setTimeout(function() {\n      var input;\n      input = instance.find('.input-message');\n      return typeof input.updateAutogrow === \"function\" ? input.updateAutogrow() : void 0;\n    }, 50);\n    if (e.originalEvent.clipboardData == null) {\n      return;\n    }\n    items = e.originalEvent.clipboardData.items;\n    files = [];\n    for (i = 0, len = items.length; i < len; i++) {\n      item = items[i];\n      if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {\n        e.preventDefault();\n        files.push({\n          file: item.getAsFile(),\n          name: 'Clipboard - ' + moment().format(RocketChat.settings.get('Message_TimeAndDateFormat'))\n        });\n      }\n    }\n    if (files.length) {\n      return fileUpload(files);\n    } else {\n      return instance.isMessageFieldEmpty.set(false);\n    }\n  },\n  'keydown .input-message': firefoxPasteUpload(function(event, instance) {\n    return chatMessages[this._id].keydown(this._id, event, Template.instance());\n  }),\n  'input .input-message': function(event) {\n    return chatMessages[this._id].valueChanged(this._id, event, Template.instance());\n  },\n  'propertychange .input-message': function(event) {\n    if (event.originalEvent.propertyName === 'value') {\n      return chatMessages[this._id].valueChanged(this._id, event, Template.instance());\n    }\n  },\n  \"click .editing-commands-cancel > button\": function(e) {\n    return chatMessages[this._id].clearEditing();\n  },\n  \"click .editing-commands-save > button\": function(e) {\n    return chatMessages[this._id].send(this._id, chatMessages[this._id].input);\n  },\n  'change .message-form input[type=file]': function(event, template) {\n    var e, file, files, filesToUpload, i, len, ref;\n    e = event.originalEvent || event;\n    files = e.target.files;\n    if (!files || files.length === 0) {\n      files = ((ref = e.dataTransfer) != null ? ref.files : void 0) || [];\n    }\n    filesToUpload = [];\n    for (i = 0, len = files.length; i < len; i++) {\n      file = files[i];\n      Object.defineProperty(file, 'type', {\n        value: mime.lookup(file.name)\n      });\n      filesToUpload.push({\n        file: file,\n        name: file.name\n      });\n    }\n    return fileUpload(filesToUpload);\n  },\n  \"click .message-buttons.share\": function(e, t) {\n    console.log('messageButtonClick');\n    t.$('.share-items').toggleClass('hidden');\n    return t.$('.message-buttons.share').toggleClass('active');\n  },\n  'click .message-form .message-buttons.location': function(event, instance) {\n    var latitude, longitude, position, roomId, text;\n    roomId = this._id;\n    position = RocketChat.Geolocation.get();\n    latitude = position.coords.latitude;\n    longitude = position.coords.longitude;\n    text = \"<div class=\\\"location-preview\\\">\\n\t<img style=\\\"height: 250px; width: 250px;\\\" src=\\\"https://maps.googleapis.com/maps/api/staticmap?zoom=14&size=250x250&markers=color:gray%7Clabel:%7C\" + latitude + \",\" + longitude + \"&key=\" + (RocketChat.settings.get('MapView_GMapsAPIKey')) + \"\\\" />\\n</div>\";\n    return swal({\n      title: t('Share_Location_Title'),\n      text: text,\n      showCancelButton: true,\n      closeOnConfirm: true,\n      closeOnCancel: true,\n      html: true\n    }, function(isConfirm) {\n      if (isConfirm !== true) {\n        return;\n      }\n      return Meteor.call(\"sendMessage\", {\n        _id: Random.id(),\n        rid: roomId,\n        msg: \"\",\n        location: {\n          type: 'Point',\n          coordinates: [longitude, latitude]\n        }\n      });\n    });\n  },\n  'click .message-form .mic': function(e, t) {\n    return AudioRecorder.start(function() {\n      t.$('.stop-mic').removeClass('hidden');\n      return t.$('.mic').addClass('hidden');\n    });\n  },\n  'click .message-form .video-button': function(e, t) {\n    if (VRecDialog.opened) {\n      return VRecDialog.close();\n    } else {\n      return VRecDialog.open(e.currentTarget);\n    }\n  },\n  'click .message-form .chart-button': function(e, t) {\n    if (ChartDialog.opened) {\n      return ChartDialog.close();\n    } else {\n      return ChartDialog.open(e.currentTarget, this._id);\n    }\n  },\n  'click .message-form .stop-mic': function(e, t) {\n    AudioRecorder.stop(function(blob) {\n      return fileUpload([\n        {\n          file: blob,\n          type: 'audio',\n          name: TAPi18n.__('Audio record') + '.wav'\n        }\n      ]);\n    });\n    t.$('.stop-mic').addClass('hidden');\n    return t.$('.mic').removeClass('hidden');\n  },\n  'click .sandstorm-offer': function(e, t) {\n    var roomId;\n    roomId = this._id;\n    return RocketChat.Sandstorm.request(\"uiView\", (function(_this) {\n      return function(err, data) {\n        if (err || !data.token) {\n          console.error(err);\n          return;\n        }\n        return Meteor.call(\"sandstormClaimRequest\", data.token, data.descriptor, function(err, viewInfo) {\n          if (err) {\n            console.error(err);\n            return;\n          }\n          return Meteor.call(\"sendMessage\", {\n            _id: Random.id(),\n            rid: roomId,\n            msg: \"\",\n            urls: [\n              {\n                url: \"grain://sandstorm\",\n                sandstormViewInfo: viewInfo\n              }\n            ]\n          });\n        });\n      };\n    })(this));\n  }\n});\n\nTemplate.messageBox.onCreated(function() {\n  this.isMessageFieldEmpty = new ReactiveVar(true);\n  this.showMicButton = new ReactiveVar(false);\n  this.showVideoRec = new ReactiveVar(false);\n  this.showChartButton = new ReactiveVar(true);\n  return this.autorun((function(_this) {\n    return function() {\n      var videoEnabled, videoRegex, wavEnabled, wavRegex;\n      videoRegex = /video\\/webm|video\\/\\*/i;\n      videoEnabled = !RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\") || RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\").match(videoRegex);\n      if (RocketChat.settings.get('Message_VideoRecorderEnabled') && ((navigator.getUserMedia != null) || (navigator.webkitGetUserMedia != null)) && videoEnabled && RocketChat.settings.get('FileUpload_Enabled')) {\n        _this.showVideoRec.set(true);\n      } else {\n        _this.showVideoRec.set(false);\n      }\n      wavRegex = /audio\\/wav|audio\\/\\*/i;\n      wavEnabled = !RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\") || RocketChat.settings.get(\"FileUpload_MediaTypeWhiteList\").match(wavRegex);\n      if (RocketChat.settings.get('Message_AudioRecorderEnabled') && ((navigator.getUserMedia != null) || (navigator.webkitGetUserMedia != null)) && wavEnabled && RocketChat.settings.get('FileUpload_Enabled')) {\n        return _this.showMicButton.set(true);\n      } else {\n        return _this.showMicButton.set(false);\n      }\n    };\n  })(this));\n});\n\nMeteor.startup(function() {\n  RocketChat.Geolocation = new ReactiveVar(false);\n  return Tracker.autorun(function() {\n    var error, options, ref, ref1, success;\n    if (RocketChat.settings.get('MapView_Enabled') === true && ((ref = RocketChat.settings.get('MapView_GMapsAPIKey')) != null ? ref.length : void 0) && (((ref1 = navigator.geolocation) != null ? ref1.getCurrentPosition : void 0) != null)) {\n      success = (function(_this) {\n        return function(position) {\n          return RocketChat.Geolocation.set(position);\n        };\n      })(this);\n      error = (function(_this) {\n        return function(error) {\n          console.log('Error getting your geolocation', error);\n          return RocketChat.Geolocation.set(false);\n        };\n      })(this);\n      options = {\n        enableHighAccuracy: true,\n        maximumAge: 0,\n        timeout: 10000\n      };\n      return navigator.geolocation.watchPosition(success, error);\n    } else {\n      return RocketChat.Geolocation.set(false);\n    }\n  });\n});\n","/* global renderMessageBody:true */\n\nrenderMessageBody = function(msg) {\n\tmsg.html = msg.msg;\n\n\tif (_.trim(msg.html) !== '') {\n\t\tmsg.html = _.escapeHTML(msg.html);\n\t}\n\n\tconst message = RocketChat.callbacks.run('renderMessage', msg);\n\n\tif (message.tokens && message.tokens.length > 0) {\n\t\tfor (const {token, text} of message.tokens) {\n\t\t\tmessage.html = message.html.replace(token, () => text); // Uses lambda so doesn't need to escape $\n\t\t}\n\t}\n\n\tmsg.html = message.html.replace(/\\n/gm, '<br/>');\n\n\treturn msg.html;\n};\n\n/* exported renderMessageBody */\n"]}