{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:channel-settings-mail-messages/server/lib/startup.js","meteor://ðŸ’»app/packages/rocketchat:channel-settings-mail-messages/server/methods/mailMessages.js"],"names":["Meteor","startup","permission","_id","roles","RocketChat","models","Permissions","upsert","$setOnInsert","moment","module","watch","require","v","methods","data","userId","Error","method","check","Match","ObjectIncluding","rid","String","to_users","to_emails","subject","messages","language","room","call","authz","hasPermission","action","rfcMailPatternWithName","emails","_","compact","trim","split","missing","length","each","username","user","Users","findOneByUsername","address","push","console","log","email","test","shift","toLowerCase","localeFn","Function","header","placeholders","replace","settings","get","footer","html","Messages","findByRoomIdAndMessageIds","sort","ts","map","message","dateTime","locale","format","u","Message","parse","join","defer","Email","send","to","from","replyTo","success"],"mappings":"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","file":"/packages/rocketchat_channel-settings-mail-messages.js","sourcesContent":["Meteor.startup(function() {\n\tconst permission = {\n\t\t_id: 'mail-messages',\n\t\troles: ['admin']\n\t};\n\treturn RocketChat.models.Permissions.upsert(permission._id, {\n\t\t$setOnInsert: permission\n\t});\n});\n","import moment from 'moment';\n\nMeteor.methods({\n\t'mailMessages'(data) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'mailMessages'\n\t\t\t});\n\t\t}\n\t\tcheck(data, Match.ObjectIncluding({\n\t\t\trid: String,\n\t\t\tto_users: [String],\n\t\t\tto_emails: String,\n\t\t\tsubject: String,\n\t\t\tmessages: [String],\n\t\t\tlanguage: String\n\t\t}));\n\t\tconst room = Meteor.call('canAccessRoom', data.rid, Meteor.userId());\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'mailMessages'\n\t\t\t});\n\t\t}\n\t\tif (!RocketChat.authz.hasPermission(Meteor.userId(), 'mail-messages')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Mailing is not allowed', {\n\t\t\t\tmethod: 'mailMessages',\n\t\t\t\taction: 'Mailing'\n\t\t\t});\n\t\t}\n\t\tconst rfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;\n\t\tconst emails = _.compact(data.to_emails.trim().split(','));\n\t\tconst missing = [];\n\t\tif (data.to_users.length > 0) {\n\t\t\t_.each(data.to_users, (username) => {\n\t\t\t\tconst user = RocketChat.models.Users.findOneByUsername(username);\n\t\t\t\tif (user && user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\t\temails.push(user.emails[0].address);\n\t\t\t\t} else {\n\t\t\t\t\tmissing.push(username);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconsole.log('Sending messages to e-mails: ', emails);\n\t\t_.each(emails, (email) => {\n\t\t\tif (!rfcMailPatternWithName.test(email.trim())) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email', `Invalid email ${ email }`, {\n\t\t\t\t\tmethod: 'mailMessages',\n\t\t\t\t\temail\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tconst user = Meteor.user();\n\t\tconst email = user.emails && user.emails[0] && user.emails[0].address;\n\t\tdata.language = data.language.split('-').shift().toLowerCase();\n\t\tif (data.language !== 'en') {\n\t\t\tconst localeFn = Meteor.call('loadLocale', data.language);\n\t\t\tif (localeFn) {\n\t\t\t\tFunction(localeFn)();\n\t\t\t}\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\t\tconst html = RocketChat.models.Messages.findByRoomIdAndMessageIds(data.rid, data.messages, {\n\t\t\tsort: {\tts: 1 }\n\t\t}).map(function(message) {\n\t\t\tconst dateTime = moment(message.ts).locale(data.language).format('L LT');\n\t\t\treturn `<p style='margin-bottom: 5px'><b>${ message.u.username }</b> <span style='color: #aaa; font-size: 12px'>${ dateTime }</span><br />${ RocketChat.Message.parse(message, data.language) }</p>`;\n\t\t}).join('');\n\n\t\tMeteor.defer(function() {\n\t\t\tEmail.send({\n\t\t\t\tto: emails,\n\t\t\t\tfrom: RocketChat.settings.get('From_Email'),\n\t\t\t\treplyTo: email,\n\t\t\t\tsubject: data.subject,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t\treturn console.log(`Sending email to ${ emails.join(', ') }`);\n\t\t});\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\tmissing\n\t\t};\n\t}\n});\n"]}