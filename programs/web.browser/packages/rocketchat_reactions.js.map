{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:reactions/client/init.js","meteor://ðŸ’»app/packages/rocketchat:reactions/client/methods/setReaction.js","meteor://ðŸ’»app/packages/rocketchat:reactions/server/models/Messages.js"],"names":["Template","room","events","event","preventDefault","stopPropagation","data","Blaze","getData","currentTarget","user","Meteor","RocketChat","models","Rooms","findOne","_id","_arguments","rid","Array","isArray","muted","indexOf","username","reactWhenReadOnly","EmojiPicker","open","emoji","call","$","tooltip","hide","showElement","find","get","startup","MessageAction","addButton","id","icon","i18nLabel","context","action","validation","message","Subscriptions","private","order","methods","setReaction","reaction","messageId","userId","Error","Messages","reactions","usernames","splice","length","_","isEmpty","unsetReactions","callbacks","run","setReactions","push","update","$set","$unset"],"mappings":"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","file":"/packages/rocketchat_reactions.js","sourcesContent":["Template.room.events({\n\t'click .add-reaction'(event) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t\tconst data = Blaze.getData(event.currentTarget);\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOne({ _id: data._arguments[1].rid });\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\treturn false;\n\t\t}\n\n\t\tRocketChat.EmojiPicker.open(event.currentTarget, (emoji) => {\n\t\t\tMeteor.call('setReaction', `:${ emoji }:`, data._arguments[1]._id);\n\t\t});\n\t},\n\n\t'click .reactions > li:not(.add-reaction)'(event) {\n\t\tevent.preventDefault();\n\t\tconst data = Blaze.getData(event.currentTarget);\n\t\tMeteor.call('setReaction', $(event.currentTarget).data('emoji'), data._arguments[1]._id, () => {\n\t\t\tRocketChat.tooltip.hide();\n\t\t});\n\t},\n\n\t'mouseenter .reactions > li:not(.add-reaction)'(event) {\n\t\tevent.stopPropagation();\n\t\tRocketChat.tooltip.showElement($(event.currentTarget).find('.people').get(0), event.currentTarget);\n\t},\n\n\t'mouseleave .reactions > li:not(.add-reaction)'(event) {\n\t\tevent.stopPropagation();\n\t\tRocketChat.tooltip.hide();\n\t}\n});\n\nMeteor.startup(function() {\n\tRocketChat.MessageAction.addButton({\n\t\tid: 'reaction-message',\n\t\ticon: 'icon-people-plus',\n\t\ti18nLabel: 'Reactions',\n\t\tcontext: [\n\t\t\t'message',\n\t\t\t'message-mobile'\n\t\t],\n\t\taction(event) {\n\t\t\tconst data = Blaze.getData(event.currentTarget);\n\n\t\t\tevent.stopPropagation();\n\n\t\t\tRocketChat.EmojiPicker.open(event.currentTarget, (emoji) => {\n\t\t\t\tMeteor.call('setReaction', `:${ emoji }:`, data._arguments[1]._id);\n\t\t\t});\n\t\t},\n\t\tvalidation(message) {\n\t\t\tconst room = RocketChat.models.Rooms.findOne({ _id: message.rid });\n\t\t\tconst user = Meteor.user();\n\n\t\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\t\treturn false;\n\t\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\t\treturn false;\n\t\t\t} else if (message.private) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\t\torder: 22\n\t});\n});\n","Meteor.methods({\n\tsetReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst message = RocketChat.models.Messages.findOne({ _id: messageId });\n\t\tconst room = RocketChat.models.Rooms.findOne({ _id: message.rid });\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\treturn false;\n\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t} else if (message.private) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions && message.reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (_.isEmpty(message.reactions)) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tRocketChat.models.Messages.unsetReactions(messageId);\n\t\t\t\tRocketChat.callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: []\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","RocketChat.models.Messages.setReactions = function(messageId, reactions) {\n\treturn this.update({ _id: messageId }, { $set: { reactions }});\n};\n\nRocketChat.models.Messages.unsetReactions = function(messageId) {\n\treturn this.update({ _id: messageId }, { $unset: { reactions: 1 }});\n};\n"]}