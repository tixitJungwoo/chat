{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/server/models/OAuthApps.coffee","meteor://ðŸ’»app/server/models/OAuthApps.coffee.js","meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/oauth/server/oauth2-server.coffee","meteor://ðŸ’»app/oauth/server/oauth2-server.coffee.js","meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/oauth/server/default-services.coffee","meteor://ðŸ’»app/oauth/server/default-services.coffee.js","meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/admin/server/publications/oauthApps.coffee","meteor://ðŸ’»app/admin/server/publications/oauthApps.coffee.js","meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/admin/server/methods/addOAuthApp.coffee","meteor://ðŸ’»app/admin/server/methods/addOAuthApp.coffee.js","meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/admin/server/methods/updateOAuthApp.coffee","meteor://ðŸ’»app/admin/server/methods/updateOAuthApp.coffee.js","meteor://ðŸ’»app/packages/rocketchat_oauth2-server-config/admin/server/methods/deleteOAuthApp.coffee","meteor://ðŸ’»app/admin/server/methods/deleteOAuthApp.coffee.js"],"names":["extend","child","parent","key","hasProp","call","ctor","constructor","prototype","__super__","hasOwnProperty","RocketChat","models","OAuthApps","superClass","_Class","_Base","oauth2server","OAuth2Server","accessTokensCollectionName","refreshTokensCollectionName","authCodesCollectionName","clientsCollection","model","debug","WebApp","connectHandlers","use","app","routes","get","req","res","next","accessToken","token","user","headers","authorization","sendStatus","send","replace","oauth","AccessTokens","findOne","Users","findOneById","userId","sub","_id","name","email","emails","address","email_verified","verified","department","birthdate","preffered_username","username","updated_at","_updatedAt","picture","Meteor","absoluteUrl","publish","clientId","ready","find","active","fields","API","v1","addAuthMethod","bearerToken","getAccessToken","getToken","headerToken","matches","request","query","access_token","match","wrapAsync","expires","Date","_","omit","insert","clientSecret","redirectUri","_createdAt","_createdBy","authz","hasPermission","error","Error","methods","addOAuthApp","application","method","isString","trim","isBoolean","Random","id","secret","updateOAuthApp","applicationId","currentApplication","update","$set","_updatedBy","deleteOAuthApp","remove"],"mappings":"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","file":"/packages/rocketchat_oauth2-server-config.js","sourcesContent":["RocketChat.models.OAuthApps = new class extends RocketChat.models._Base\n\tconstructor: ->\n\t\tsuper('oauth_apps')\n\n\n\t# FIND\n\t# findByRole: (role, options) ->\n\t# \tquery =\n\t# \t\troles: role\n\n\t# \treturn @find query, options\n\n\t# CREATE\n","var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n  hasProp = {}.hasOwnProperty;\n\nRocketChat.models.OAuthApps = new ((function(superClass) {\n  extend(_Class, superClass);\n\n  function _Class() {\n    _Class.__super__.constructor.call(this, 'oauth_apps');\n  }\n\n  return _Class;\n\n})(RocketChat.models._Base));\n","oauth2server = new OAuth2Server\n\taccessTokensCollectionName: 'rocketchat_oauth_access_tokens'\n\trefreshTokensCollectionName: 'rocketchat_oauth_refresh_tokens'\n\tauthCodesCollectionName: 'rocketchat_oauth_auth_codes'\n\tclientsCollection: RocketChat.models.OAuthApps.model\n\tdebug: true\n\n\nWebApp.connectHandlers.use oauth2server.app\n\noauth2server.routes.get '/oauth/userinfo', (req, res, next) ->\n\tif not req.headers.authorization?\n\t\treturn res.sendStatus(401).send('No token')\n\n\taccessToken = req.headers.authorization.replace('Bearer ', '')\n\n\ttoken = oauth2server.oauth.model.AccessTokens.findOne accessToken: accessToken\n\n\tif not token?\n\t\treturn res.sendStatus(401).send('Invalid Token')\n\n\tuser = RocketChat.models.Users.findOneById(token.userId);\n\n\tif not user?\n\t\treturn res.sendStatus(401).send('Invalid Token')\n\n\tres.send\n\t\tsub: user._id\n\t\tname: user.name\n\t\temail: user.emails[0].address\n\t\temail_verified: user.emails[0].verified\n\t\tdepartment: \"\"\n\t\tbirthdate: \"\"\n\t\tpreffered_username: user.username\n\t\tupdated_at: user._updatedAt\n\t\tpicture: \"#{Meteor.absoluteUrl()}avatar/#{user.username}\"\n\n\nMeteor.publish 'oauthClient', (clientId) ->\n\tunless @userId\n\t\treturn @ready()\n\n\treturn RocketChat.models.OAuthApps.find {clientId: clientId, active: true},\n\t\tfields:\n\t\t\tname: 1\n\n\nRocketChat.API.v1.addAuthMethod ->\n\theaderToken = @request.headers['authorization']\n\tgetToken = @request.query.access_token\n\n\tif headerToken?\n\t\tif matches = headerToken.match(/Bearer\\s(\\S+)/)\n\t\t\theaderToken = matches[1]\n\t\telse\n\t\t\theaderToken = undefined\n\n\tbearerToken = headerToken or getToken\n\n\tif not bearerToken?\n\t\t# console.log 'token not found'.red\n\t\treturn\n\n\t# console.log 'bearerToken', bearerToken\n\n\tgetAccessToken = Meteor.wrapAsync oauth2server.oauth.model.getAccessToken, oauth2server.oauth.model\n\taccessToken = getAccessToken bearerToken\n\n\tif not accessToken?\n\t\t# console.log 'accessToken not found'.red\n\t\treturn\n\n\tif accessToken.expires? and accessToken.expires isnt 0 and accessToken.expires < new Date()\n\t\t# console.log 'accessToken expired'.red\n\t\treturn\n\n\tuser = RocketChat.models.Users.findOne(accessToken.userId)\n\tif not user?\n\t\t# console.log 'user not found'.red\n\t\treturn\n\n\treturn user: _.omit(user, '$loki')\n","var oauth2server;\n\noauth2server = new OAuth2Server({\n  accessTokensCollectionName: 'rocketchat_oauth_access_tokens',\n  refreshTokensCollectionName: 'rocketchat_oauth_refresh_tokens',\n  authCodesCollectionName: 'rocketchat_oauth_auth_codes',\n  clientsCollection: RocketChat.models.OAuthApps.model,\n  debug: true\n});\n\nWebApp.connectHandlers.use(oauth2server.app);\n\noauth2server.routes.get('/oauth/userinfo', function(req, res, next) {\n  var accessToken, token, user;\n  if (req.headers.authorization == null) {\n    return res.sendStatus(401).send('No token');\n  }\n  accessToken = req.headers.authorization.replace('Bearer ', '');\n  token = oauth2server.oauth.model.AccessTokens.findOne({\n    accessToken: accessToken\n  });\n  if (token == null) {\n    return res.sendStatus(401).send('Invalid Token');\n  }\n  user = RocketChat.models.Users.findOneById(token.userId);\n  if (user == null) {\n    return res.sendStatus(401).send('Invalid Token');\n  }\n  return res.send({\n    sub: user._id,\n    name: user.name,\n    email: user.emails[0].address,\n    email_verified: user.emails[0].verified,\n    department: \"\",\n    birthdate: \"\",\n    preffered_username: user.username,\n    updated_at: user._updatedAt,\n    picture: (Meteor.absoluteUrl()) + \"avatar/\" + user.username\n  });\n});\n\nMeteor.publish('oauthClient', function(clientId) {\n  if (!this.userId) {\n    return this.ready();\n  }\n  return RocketChat.models.OAuthApps.find({\n    clientId: clientId,\n    active: true\n  }, {\n    fields: {\n      name: 1\n    }\n  });\n});\n\nRocketChat.API.v1.addAuthMethod(function() {\n  var accessToken, bearerToken, getAccessToken, getToken, headerToken, matches, user;\n  headerToken = this.request.headers['authorization'];\n  getToken = this.request.query.access_token;\n  if (headerToken != null) {\n    if (matches = headerToken.match(/Bearer\\s(\\S+)/)) {\n      headerToken = matches[1];\n    } else {\n      headerToken = void 0;\n    }\n  }\n  bearerToken = headerToken || getToken;\n  if (bearerToken == null) {\n    return;\n  }\n  getAccessToken = Meteor.wrapAsync(oauth2server.oauth.model.getAccessToken, oauth2server.oauth.model);\n  accessToken = getAccessToken(bearerToken);\n  if (accessToken == null) {\n    return;\n  }\n  if ((accessToken.expires != null) && accessToken.expires !== 0 && accessToken.expires < new Date()) {\n    return;\n  }\n  user = RocketChat.models.Users.findOne(accessToken.userId);\n  if (user == null) {\n    return;\n  }\n  return {\n    user: _.omit(user, '$loki')\n  };\n});\n","if not RocketChat.models.OAuthApps.findOne('zapier')\n\tRocketChat.models.OAuthApps.insert\n\t\t_id: 'zapier'\n\t\tname: 'Zapier'\n\t\tactive: true\n\t\tclientId: 'zapier'\n\t\tclientSecret: 'RTK6TlndaCIolhQhZ7_KHIGOKj41RnlaOq_o-7JKwLr'\n\t\tredirectUri: 'https://zapier.com/dashboard/auth/oauth/return/App32270API/'\n\t\t_createdAt: new Date\n\t\t_createdBy:\n\t\t\t_id: 'system'\n\t\t\tusername: 'system'\n","if (!RocketChat.models.OAuthApps.findOne('zapier')) {\n  RocketChat.models.OAuthApps.insert({\n    _id: 'zapier',\n    name: 'Zapier',\n    active: true,\n    clientId: 'zapier',\n    clientSecret: 'RTK6TlndaCIolhQhZ7_KHIGOKj41RnlaOq_o-7JKwLr',\n    redirectUri: 'https://zapier.com/dashboard/auth/oauth/return/App32270API/',\n    _createdAt: new Date,\n    _createdBy: {\n      _id: 'system',\n      username: 'system'\n    }\n  });\n}\n","Meteor.publish 'oauthApps', ->\n\tunless @userId\n\t\treturn @ready()\n\n\tif not RocketChat.authz.hasPermission @userId, 'manage-oauth-apps'\n\t\t@error Meteor.Error \"error-not-allowed\", \"Not allowed\", { publish: 'oauthApps' }\n\n\treturn RocketChat.models.OAuthApps.find()\n","Meteor.publish('oauthApps', function() {\n  if (!this.userId) {\n    return this.ready();\n  }\n  if (!RocketChat.authz.hasPermission(this.userId, 'manage-oauth-apps')) {\n    this.error(Meteor.Error(\"error-not-allowed\", \"Not allowed\", {\n      publish: 'oauthApps'\n    }));\n  }\n  return RocketChat.models.OAuthApps.find();\n});\n","Meteor.methods\n\taddOAuthApp: (application) ->\n\t\tif not RocketChat.authz.hasPermission @userId, 'manage-oauth-apps'\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'addOAuthApp' }\n\n\t\tif not _.isString(application.name) or application.name.trim() is ''\n\t\t\tthrow new Meteor.Error 'error-invalid-name', 'Invalid name', { method: 'addOAuthApp' }\n\n\t\tif not _.isString(application.redirectUri) or application.redirectUri.trim() is ''\n\t\t\tthrow new Meteor.Error 'error-invalid-redirectUri', 'Invalid redirectUri', { method: 'addOAuthApp' }\n\n\t\tif not _.isBoolean(application.active)\n\t\t\tthrow new Meteor.Error 'error-invalid-arguments', 'Invalid arguments', { method: 'addOAuthApp' }\n\n\t\tapplication.clientId = Random.id()\n\t\tapplication.clientSecret = Random.secret()\n\t\tapplication._createdAt = new Date\n\t\tapplication._createdBy = RocketChat.models.Users.findOne @userId, {fields: {username: 1}}\n\n\t\tapplication._id = RocketChat.models.OAuthApps.insert application\n\n\t\treturn application\n","Meteor.methods({\n  addOAuthApp: function(application) {\n    if (!RocketChat.authz.hasPermission(this.userId, 'manage-oauth-apps')) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed', {\n        method: 'addOAuthApp'\n      });\n    }\n    if (!_.isString(application.name) || application.name.trim() === '') {\n      throw new Meteor.Error('error-invalid-name', 'Invalid name', {\n        method: 'addOAuthApp'\n      });\n    }\n    if (!_.isString(application.redirectUri) || application.redirectUri.trim() === '') {\n      throw new Meteor.Error('error-invalid-redirectUri', 'Invalid redirectUri', {\n        method: 'addOAuthApp'\n      });\n    }\n    if (!_.isBoolean(application.active)) {\n      throw new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n        method: 'addOAuthApp'\n      });\n    }\n    application.clientId = Random.id();\n    application.clientSecret = Random.secret();\n    application._createdAt = new Date;\n    application._createdBy = RocketChat.models.Users.findOne(this.userId, {\n      fields: {\n        username: 1\n      }\n    });\n    application._id = RocketChat.models.OAuthApps.insert(application);\n    return application;\n  }\n});\n","Meteor.methods\n\tupdateOAuthApp: (applicationId, application) ->\n\t\tif not RocketChat.authz.hasPermission @userId, 'manage-oauth-apps'\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: 'updateOAuthApp' }\n\n\t\tif not _.isString(application.name) or application.name.trim() is ''\n\t\t\tthrow new Meteor.Error 'error-invalid-name', 'Invalid name', { method: 'updateOAuthApp' }\n\n\t\tif not _.isString(application.redirectUri) or application.redirectUri.trim() is ''\n\t\t\tthrow new Meteor.Error 'error-invalid-redirectUri', 'Invalid redirectUri', { method: 'updateOAuthApp' }\n\n\t\tif not _.isBoolean(application.active)\n\t\t\tthrow new Meteor.Error 'error-invalid-arguments', 'Invalid arguments', { method: 'updateOAuthApp' }\n\n\t\tcurrentApplication = RocketChat.models.OAuthApps.findOne(applicationId)\n\t\tif not currentApplication?\n\t\t\tthrow new Meteor.Error 'error-application-not-found', 'Application not found', { method: 'updateOAuthApp' }\n\n\t\tRocketChat.models.OAuthApps.update applicationId,\n\t\t\t$set:\n\t\t\t\tname: application.name\n\t\t\t\tactive: application.active\n\t\t\t\tredirectUri: application.redirectUri\n\t\t\t\t_updatedAt: new Date\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne @userId, {fields: {username: 1}}\n\n\t\treturn RocketChat.models.OAuthApps.findOne(applicationId)\n","Meteor.methods({\n  updateOAuthApp: function(applicationId, application) {\n    var currentApplication;\n    if (!RocketChat.authz.hasPermission(this.userId, 'manage-oauth-apps')) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed', {\n        method: 'updateOAuthApp'\n      });\n    }\n    if (!_.isString(application.name) || application.name.trim() === '') {\n      throw new Meteor.Error('error-invalid-name', 'Invalid name', {\n        method: 'updateOAuthApp'\n      });\n    }\n    if (!_.isString(application.redirectUri) || application.redirectUri.trim() === '') {\n      throw new Meteor.Error('error-invalid-redirectUri', 'Invalid redirectUri', {\n        method: 'updateOAuthApp'\n      });\n    }\n    if (!_.isBoolean(application.active)) {\n      throw new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {\n        method: 'updateOAuthApp'\n      });\n    }\n    currentApplication = RocketChat.models.OAuthApps.findOne(applicationId);\n    if (currentApplication == null) {\n      throw new Meteor.Error('error-application-not-found', 'Application not found', {\n        method: 'updateOAuthApp'\n      });\n    }\n    RocketChat.models.OAuthApps.update(applicationId, {\n      $set: {\n        name: application.name,\n        active: application.active,\n        redirectUri: application.redirectUri,\n        _updatedAt: new Date,\n        _updatedBy: RocketChat.models.Users.findOne(this.userId, {\n          fields: {\n            username: 1\n          }\n        })\n      }\n    });\n    return RocketChat.models.OAuthApps.findOne(applicationId);\n  }\n});\n","Meteor.methods\n\tdeleteOAuthApp: (applicationId) ->\n\t\tif not RocketChat.authz.hasPermission @userId, 'manage-oauth-apps'\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'deleteOAuthApp' });\n\n\t\tapplication = RocketChat.models.OAuthApps.findOne(applicationId)\n\n\t\tif not application?\n\t\t\tthrow new Meteor.Error('error-application-not-found', 'Application not found', { method: 'deleteOAuthApp' });\n\n\n\t\tRocketChat.models.OAuthApps.remove _id: applicationId\n\n\t\treturn true\n","Meteor.methods({\n  deleteOAuthApp: function(applicationId) {\n    var application;\n    if (!RocketChat.authz.hasPermission(this.userId, 'manage-oauth-apps')) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed', {\n        method: 'deleteOAuthApp'\n      });\n    }\n    application = RocketChat.models.OAuthApps.findOne(applicationId);\n    if (application == null) {\n      throw new Meteor.Error('error-application-not-found', 'Application not found', {\n        method: 'deleteOAuthApp'\n      });\n    }\n    RocketChat.models.OAuthApps.remove({\n      _id: applicationId\n    });\n    return true;\n  }\n});\n"]}