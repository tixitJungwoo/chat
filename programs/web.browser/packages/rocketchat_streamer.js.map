{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:streamer/lib/ev.js","meteor://ðŸ’»app/packages/rocketchat:streamer/client/client.js"],"names":["EV","handlers","emit","event","args","forEach","handler","apply","emitWithScope","scope","on","callback","push","once","self","onetimeCallback","arguments","removeListener","index","indexOf","splice","removeAllListeners","undefined","NonEmptyString","Match","Where","x","check","String","length","StreamerCentral","instances","ddpConnections","setupDdpConnection","name","ddpConnection","hasMeteorStreamerEventListeners","_stream","raw_msg","msg","DDPCommon","parseDDP","collection","fields","eventName","unshift","storeDdpConnection","Meteor","Streamer","useCollection","connection","console","warn","subscriptions","subscriptionName","lastMessage","call","stop","subscription","unsubscribe","stopAll","hasOwnProperty","subscribe","Tracker","nonreactive","onStop","onReconnect","fn","getLastMessageFromEvent","Function","_name","_useCollection","Boolean"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\tif (this.handlers[event]) {\n\t\t\tthis.handlers[event].forEach((handler) => handler.apply(this, args));\n\t\t}\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\tif (this.handlers[event]) {\n\t\t\tthis.handlers[event].forEach((handler) => handler.apply(scope, args));\n\t\t}\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tself = this;\n\t\tself.on(event, function onetimeCallback() {\n\t\t\tcallback.apply(this, arguments);\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif(this.handlers[event]) {\n\t\t\tconst index = this.handlers[event].indexOf(callback);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.handlers[event].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals DDPCommon, EV */\n/* eslint-disable new-cap */\n\nconst NonEmptyString = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn x.length > 0;\n});\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t\tthis.ddpConnections = {};\t\t// since each Streamer instance can provide its own ddp connection, store them by streamer name\n\n\t}\n\n\tsetupDdpConnection(name, ddpConnection) {\n\t\t// make sure we only setup event listeners for each ddp connection once\n\t\tif (ddpConnection.hasMeteorStreamerEventListeners) {\n\t\t\treturn;\n\t\t}\n\t\tddpConnection._stream.on('message', (raw_msg) => {\n\t\t\tconst msg = DDPCommon.parseDDP(raw_msg);\n\t\t\tif (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n\t\t\t\tmsg.fields.args.unshift(msg.fields.eventName);\n\t\t\t\tmsg.fields.args.unshift(msg.collection);\n\t\t\t\tthis.emit.apply(this, msg.fields.args);\n\t\t\t}\n\t\t});\n\t\t// store ddp connection\n\t\tthis.storeDdpConnection(name, ddpConnection);\n\n\t}\n\n\tstoreDdpConnection(name, ddpConnection) {\n\t\t// mark the connection as setup for Streamer, and store it\n\t\tddpConnection.hasMeteorStreamerEventListeners = true;\n\t\tthis.ddpConnections[name] = ddpConnection;\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {useCollection = false, ddpConnection = Meteor.connection } = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\t\tMeteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n\n\t\tsuper();\n\n\t\tthis.ddpConnection = ddpConnection || Meteor.connection;\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.useCollection = useCollection;\n\t\tthis.subscriptions = {};\n\n\t\tMeteor.StreamerCentral.on(this.subscriptionName, (eventName, ...args) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\tthis.subscriptions[eventName].lastMessage = args;\n\t\t\t\tsuper.emit.call(this, eventName, ...args);\n\t\t\t}\n\t\t});\n\n\t\tthis.ddpConnection._stream.on('reset', () => {\n\t\t\tsuper.emit.call(this, '__reconnect__');\n\t\t});\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget useCollection() {\n\t\treturn this._useCollection;\n\t}\n\n\tset useCollection(useCollection) {\n\t\tcheck(useCollection, Boolean);\n\t\tthis._useCollection = useCollection;\n\t}\n\n\tstop(eventName) {\n\t\tif (this.subscriptions[eventName] && this.subscriptions[eventName].subscription) {\n\t\t\tthis.subscriptions[eventName].subscription.stop();\n\t\t}\n\t\tthis.unsubscribe(eventName);\n\t}\n\n\tstopAll() {\n\t\tfor (let eventName in this.subscriptions) {\n\t\t\tif (this.subscriptions.hasOwnProperty(eventName)) {\n\t\t\t\tthis.stop(eventName);\n\t\t\t}\n\t\t}\n\t}\n\n\tunsubscribe(eventName) {\n\t\tthis.removeAllListeners(eventName);\n\t\tdelete this.subscriptions[eventName];\n\t}\n\n\tsubscribe(eventName) {\n\t\tlet subscribe;\n\t\tTracker.nonreactive(() => {\n\t\t\tsubscribe = this.ddpConnection.subscribe(this.subscriptionName, eventName, this.useCollection, {\n\t\t\t\tonStop: () => {\n\t\t\t\t\tthis.unsubscribe(eventName);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\treturn subscribe;\n\t}\n\n\tonReconnect(fn) {\n\t\tif (typeof fn === 'function') {\n\t\t\tsuper.on('__reconnect__', fn);\n\t\t}\n\t}\n\n\tgetLastMessageFromEvent(eventName) {\n\t\tconst subscription = this.subscriptions[eventName];\n\t\tif (subscription && subscription.lastMessage) {\n\t\t\treturn subscription.lastMessage;\n\t\t}\n\t}\n\n\tonce(eventName, callback) {\n\t\tcheck(eventName, NonEmptyString);\n\t\tcheck(callback, Function);\n\n\t\tif (!this.subscriptions[eventName]) {\n\t\t\tthis.subscriptions[eventName] = {\n\t\t\t\tsubscription: this.subscribe(eventName)\n\t\t\t};\n\t\t}\n\n\t\tsuper.once(eventName, callback);\n\t}\n\n\ton(eventName, callback) {\n\t\tcheck(eventName, NonEmptyString);\n\t\tcheck(callback, Function);\n\n\t\tif (!this.subscriptions[eventName]) {\n\t\t\tthis.subscriptions[eventName] = {\n\t\t\t\tsubscription: this.subscribe(eventName)\n\t\t\t};\n\t\t}\n\n\t\tsuper.on(eventName, callback);\n\t}\n\n\temit(...args) {\n\t\tthis.ddpConnection.call(this.subscriptionName, ...args);\n\t}\n};\n"]}