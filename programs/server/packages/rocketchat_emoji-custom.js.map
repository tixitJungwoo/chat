{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:emoji-custom/function-isSet.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/emoji-custom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/models/EmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/publications/fullEmojiData.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/listEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/deleteEmojiCustom.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/insertOrUpdateEmoji.js","meteor://ðŸ’»app/packages/rocketchat:emoji-custom/server/methods/uploadEmojiCustom.js"],"names":["isSet","fn","value","e","undefined","isSetNotNull","Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileEmojiCustomInstance","name","absolutePath","WebApp","connectHandlers","use","bindEnvironment","req","res","params","emoji","decodeURIComponent","url","replace","_","isEmpty","writeHead","write","end","file","getFileWithReadStream","encodeURIComponent","setHeader","reqModifiedHeader","headers","color","initials","svg","fileUploadDate","uploadDate","toUTCString","Date","test","split","pop","length","readStream","pipe","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","EmojiCustom","tryEnsureIndex","findOneByID","options","findOne","findByNameOrAlias","query","$or","aliases","find","findByNameOrAliasExceptID","except","$nin","setName","update","$set","setAliases","setExtension","extension","create","data","insert","removeByID","remove","models","_Base","publish","filter","limit","userId","ready","fields","s","sort","filterReg","RegExp","escapeRegExp","methods","listEmojiCustom","fetch","deleteEmojiCustom","emojiID","authz","hasPermission","method","deleteFile","Notifications","notifyLogged","emojiData","insertOrUpdateEmoji","field","nameValidation","aliasValidation","input","Boolean","without","matchingResults","alias","concat","createEmoji","newFile","previousExtension","previousName","rs","ws","createWriteStream","contentType","on","uploadEmojiCustom","binaryContent","Buffer","bufferToStream","setTimeout"],"mappings":"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","file":"/packages/rocketchat_emoji-custom.js","sourcesContent":["/* globals isSet:true, isSetNotNull:true */\n//http://stackoverflow.com/a/26990347 function isSet() from Gajus\nisSet = function(fn) {\n\tlet value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = undefined;\n\t} finally {\n\t\treturn value !== undefined;\n\t}\n};\n\nisSetNotNull = function(fn) {\n\tlet value;\n\ttry {\n\t\tvalue = fn();\n\t} catch (e) {\n\t\tvalue = null;\n\t} finally {\n\t\treturn value !== null && value !== undefined;\n\t}\n};\n\n/* exported isSet, isSetNotNull */\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('EmojiUpload_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('EmojiUpload_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${ storeType }]`);\n\t}\n\n\tconsole.log(`Using ${ storeType } for custom emoji storage`.green);\n\n\tlet path = '~/uploads';\n\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath') != null) {\n\t\tif (RocketChat.settings.get('EmojiUpload_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('EmojiUpload_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileEmojiCustomInstance = new RocketChatStore({\n\t\tname: 'custom_emoji',\n\t\tabsolutePath: path\n\t});\n\n\treturn WebApp.connectHandlers.use('/emoji-custom/', Meteor.bindEnvironment(function(req, res/*, next*/) {\n\t\tconst params =\n\t\t\t{emoji: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, ''))};\n\n\t\tif (_.isEmpty(params.emoji)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(params.emoji));\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tif (file == null) {\n\t\t\t//use code from username initials renderer until file upload is complete\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\t\tres.setHeader('Expires', '-1');\n\t\t\tres.setHeader('Last-Modified', 'Thu, 01 Jan 2015 00:00:00 GMT');\n\n\t\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\t\tif (reqModifiedHeader != null) {\n\t\t\t\tif (reqModifiedHeader === 'Thu, 01 Jan 2015 00:00:00 GMT') {\n\t\t\t\t\tres.writeHead(304);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst color = '#000';\n\t\t\tconst initials = '?';\n\n\t\t\tconst svg = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: ${ color };\">\n\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n\t\t${ initials }\n\t</text>\n</svg>`;\n\n\t\t\tres.write(svg);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (file.uploadDate != null) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader != null) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (fileUploadDate != null) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tif (/^svg$/i.test(params.emoji.split('.').pop())) {\n\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t} else {\n\t\t\tres.setHeader('Content-Type', 'image/jpeg');\n\t\t}\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","RocketChat.settings.addGroup('EmojiCustomFilesystem', function() {\n\tthis.add('EmojiUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type'\n\t});\n\n\tthis.add('EmojiUpload_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'EmojiUpload_Storage_Type',\n\t\t\tvalue: 'FileSystem'\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath'\n\t});\n});\n","class EmojiCustom extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_emoji');\n\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t\tthis.tryEnsureIndex({ 'aliases': 1 });\n\t\tthis.tryEnsureIndex({ 'extension': 1});\n\t}\n\n\t//find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t//find\n\tfindByNameOrAlias(name, options) {\n\t\tconst query = {\n\t\t\t$or: [\n\t\t\t\t{name},\n\t\t\t\t{aliases: name}\n\t\t\t]\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameOrAliasExceptID(name, except, options) {\n\t\tconst query = {\n\t\t\t_id: { $nin: [ except ] },\n\t\t\t$or: [\n\t\t\t\t{name},\n\t\t\t\t{aliases: name}\n\t\t\t]\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\n\t//update\n\tsetName(_id, name) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tname\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\tsetAliases(_id, aliases) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\taliases\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\tsetExtension(_id, extension) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\textension\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.EmojiCustom = new EmojiCustom();\n","Meteor.publish('fullEmojiData', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tconst fields = {\n\t\tname: 1,\n\t\taliases: 1,\n\t\textension: 1\n\t};\n\n\tfilter = s.trim(filter);\n\n\tconst options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 }\n\t};\n\n\tif (filter) {\n\t\tconst filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.EmojiCustom.findByNameOrAlias(filterReg, options);\n\t}\n\n\treturn RocketChat.models.EmojiCustom.find({}, options);\n});\n","Meteor.methods({\n\tlistEmojiCustom() {\n\t\treturn RocketChat.models.EmojiCustom.find({}).fetch();\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tdeleteEmojiCustom(emojiID) {\n\t\tlet emoji = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\temoji = RocketChat.models.EmojiCustom.findOneByID(emojiID);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (emoji == null) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Invalid_Emoji', 'Invalid emoji', { method: 'deleteEmojiCustom' });\n\t\t}\n\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emoji.name }.${ emoji.extension }`));\n\t\tRocketChat.models.EmojiCustom.removeByID(emojiID);\n\t\tRocketChat.Notifications.notifyLogged('deleteEmojiCustom', {emojiData: emoji});\n\n\t\treturn true;\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tinsertOrUpdateEmoji(emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateEmoji', field: 'Name' });\n\t\t}\n\n\t\t//let nameValidation = new RegExp('^[0-9a-zA-Z-_+;.]+$');\n\t\t//let aliasValidation = new RegExp('^[0-9a-zA-Z-_+;., ]+$');\n\n\t\t//allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t//more practical than allowing specific sets of characters; also allows foreign languages\n\t\tconst nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\t\tconst aliasValidation = /[:><&\"'\\/\\\\\\(\\)]/;\n\n\t\t//silently strip colon; this allows for uploading :emojiname: as emojiname\n\t\temojiData.name = emojiData.name.replace(/:/g, '');\n\t\temojiData.aliases = emojiData.aliases.replace(/:/g, '');\n\n\t\tif (nameValidation.test(emojiData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ emojiData.name } is not a valid name`, { method: 'insertOrUpdateEmoji', input: emojiData.name, field: 'Name' });\n\t\t}\n\n\t\tif (emojiData.aliases) {\n\t\t\tif (aliasValidation.test(emojiData.aliases)) {\n\t\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ emojiData.aliases } is not a valid alias set`, { method: 'insertOrUpdateEmoji', input: emojiData.aliases, field: 'Alias_Set' });\n\t\t\t}\n\t\t\temojiData.aliases = emojiData.aliases.split(/[\\s,]/);\n\t\t\temojiData.aliases = emojiData.aliases.filter(Boolean);\n\t\t\temojiData.aliases = _.without(emojiData.aliases, emojiData.name);\n\t\t} else {\n\t\t\temojiData.aliases = [];\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (emojiData._id) {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(emojiData.name, emojiData._id).fetch();\n\t\t\tfor (const alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAliasExceptID(alias, emojiData._id).fetch());\n\t\t\t}\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.EmojiCustom.findByNameOrAlias(emojiData.name).fetch();\n\t\t\tfor (const alias of emojiData.aliases) {\n\t\t\t\tmatchingResults = matchingResults.concat(RocketChat.models.EmojiCustom.findByNameOrAlias(alias).fetch());\n\t\t\t}\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Emoji_Error_Name_Or_Alias_Already_In_Use', 'The custom emoji or one of its aliases is already in use', { method: 'insertOrUpdateEmoji' });\n\t\t}\n\n\t\tif (!emojiData._id) {\n\t\t\t//insert emoji\n\t\t\tconst createEmoji = {\n\t\t\t\tname: emojiData.name,\n\t\t\t\taliases: emojiData.aliases,\n\t\t\t\textension: emojiData.extension\n\t\t\t};\n\n\t\t\tconst _id = RocketChat.models.EmojiCustom.create(createEmoji);\n\n\t\t\tRocketChat.Notifications.notifyLogged('updateEmojiCustom', {emojiData: createEmoji});\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t//update emoji\n\t\t\tif (emojiData.newFile) {\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.previousExtension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.extension }`));\n\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`));\n\n\t\t\t\tRocketChat.models.EmojiCustom.setExtension(emojiData._id, emojiData.extension);\n\t\t\t} else if (emojiData.name !== emojiData.previousName) {\n\t\t\t\tconst rs = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`));\n\t\t\t\tif (rs !== null) {\n\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\t\t\t\tconst ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${ emojiData.name }.${ emojiData.previousExtension }`), rs.contentType);\n\t\t\t\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\t\t\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.previousName }.${ emojiData.previousExtension }`))\n\t\t\t\t\t\t));\n\t\t\t\t\trs.readStream.pipe(ws);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (emojiData.name !== emojiData.previousName) {\n\t\t\t\tRocketChat.models.EmojiCustom.setName(emojiData._id, emojiData.name);\n\t\t\t}\n\n\t\t\tif (emojiData.aliases) {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, emojiData.aliases);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.EmojiCustom.setAliases(emojiData._id, []);\n\t\t\t}\n\n\t\t\tRocketChat.Notifications.notifyLogged('updateEmojiCustom', {emojiData});\n\n\t\t\treturn true;\n\t\t}\n\t}\n});\n","/* globals RocketChatFileEmojiCustomInstance */\nMeteor.methods({\n\tuploadEmojiCustom(binaryContent, contentType, emojiData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-emoji')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\t//delete aliases for notification purposes. here, it is a string rather than an array\n\t\tdelete emojiData.aliases;\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileEmojiCustomInstance.deleteFile(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`));\n\t\tconst ws = RocketChatFileEmojiCustomInstance.createWriteStream(encodeURIComponent(`${ emojiData.name }.${ emojiData.extension }`), contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyLogged('updateEmojiCustom', {emojiData})\n\t\t\t, 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t}\n});\n"]}