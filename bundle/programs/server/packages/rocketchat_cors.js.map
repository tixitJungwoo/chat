{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:cors/cors.js","meteor://ðŸ’»app/packages/rocketchat:cors/common.js"],"names":["url","module","watch","require","v","WebApp","rawConnectHandlers","use","req","res","next","_body","headers","undefined","isNaN","indexOf","buf","setEncoding","on","chunk","RocketChat","debugLevel","console","log","green","method","body","JSON","parse","error","test","setHeader","key","val","toLowerCase","apply","arguments","_staticFilesMiddleware","WebAppInternals","staticFilesMiddleware","staticFiles","oldHttpServerListeners","httpServer","listeners","slice","removeAllListeners","addListener","oldListener","settings","get","remoteAddress","connection","socket","localhostRegexp","localhostTest","x","isLocal","_","all","split","isSsl","pair","host","Meteor","absoluteUrl","hostname","replace","writeHead","end","startup","onload","value","defaultOptions","secure"],"mappings":"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","file":"/packages/rocketchat_cors.js","sourcesContent":["/* globals WebAppInternals */\n\nimport url from 'url';\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n\tif (req._body) {\n\t\treturn next();\n\t}\n\tif (req.headers['transfer-encoding'] === undefined && isNaN(req.headers['content-length'])) {\n\t\treturn next();\n\t}\n\tif (req.headers['content-type'] !== '' && req.headers['content-type'] !== undefined) {\n\t\treturn next();\n\t}\n\tif (req.url.indexOf('/ufs/') === 0) {\n\t\treturn next();\n\t}\n\n\tlet buf = '';\n\treq.setEncoding('utf8');\n\treq.on('data', function(chunk) {\n\t\treturn buf += chunk;\n\t});\n\n\treq.on('end', function() {\n\t\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\t\tconsole.log('[request]'.green, req.method, req.url, '\\nheaders ->', req.headers, '\\nbody ->', buf);\n\t\t}\n\n\t\ttry {\n\t\t\treq.body = JSON.parse(buf);\n\t\t} catch (error) {\n\t\t\treq.body = buf;\n\t\t}\n\t\treq._body = true;\n\n\t\treturn next();\n\t});\n});\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n\tif (/^\\/(api|_timesync|sockjs|tap-i18n|__cordova)(\\/|$)/.test(req.url)) {\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t}\n\n\tconst setHeader = res.setHeader;\n\tres.setHeader = function(key, val) {\n\t\tif (key.toLowerCase() === 'access-control-allow-origin' && val === 'http://meteor.local') {\n\t\t\treturn;\n\t\t}\n\t\treturn setHeader.apply(this, arguments);\n\t};\n\treturn next();\n});\n\nconst _staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function(staticFiles, req, res, next) {\n\tres.setHeader('Access-Control-Allow-Origin', '*');\n\treturn _staticFilesMiddleware(staticFiles, req, res, next);\n};\n\nconst oldHttpServerListeners = WebApp.httpServer.listeners('request').slice(0);\n\nWebApp.httpServer.removeAllListeners('request');\n\nWebApp.httpServer.addListener('request', function(req, res) {\n\tconst next = () => {\n\t\tfor (const oldListener of oldHttpServerListeners) {\n\t\t\toldListener.apply(WebApp.httpServer, arguments);\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Force_SSL') !== true) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;\n\tconst localhostRegexp = /^\\s*(127\\.0\\.0\\.1|::1)\\s*$/;\n\tconst localhostTest = function(x) {\n\t\treturn localhostRegexp.test(x);\n\t};\n\n\tconst isLocal = localhostRegexp.test(remoteAddress) && (!req.headers['x-forwarded-for'] || _.all(req.headers['x-forwarded-for'].split(','), localhostTest));\n\tconst isSsl = req.connection.pair || (req.headers['x-forwarded-proto'] && req.headers['x-forwarded-proto'].indexOf('https') !== -1);\n\n\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\tconsole.log('req.url', req.url);\n\t\tconsole.log('remoteAddress', remoteAddress);\n\t\tconsole.log('isLocal', isLocal);\n\t\tconsole.log('isSsl', isSsl);\n\t\tconsole.log('req.headers', req.headers);\n\t}\n\n\tif (!isLocal && !isSsl) {\n\t\tlet host = req.headers['host'] || url.parse(Meteor.absoluteUrl()).hostname;\n\t\thost = host.replace(/:\\d+$/, '');\n\t\tres.writeHead(302, {\n\t\t\t'Location': `https://${ host }${ req.url }`\n\t\t});\n\t\tres.end();\n\t\treturn;\n\t}\n\n\treturn next();\n});\n","Meteor.startup(function() {\n\treturn RocketChat.settings.onload('Force_SSL', function(key, value) {\n\t\treturn Meteor.absoluteUrl.defaultOptions.secure = value;\n\t});\n});\n"]}