{"version":3,"sources":["meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_server.js","meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_utils.js","meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_rocketchat.js"],"names":["Accounts","saml","settings","debug","generateUsername","providers","fiber","Npm","require","connect","RoutePolicy","declare","getSamlProviderConfig","provider","Meteor","Error","method","samlProvider","element","filter","methods","samlLogout","userId","providerConfig","console","log","JSON","stringify","user","users","findOne","_id","nameID","services","sessionIndex","idpSession","_saml","SAML","request","generateLogoutRequest","update","$set","id","_syncRequestToUrl","wrapAsync","requestToUrl","result","registerLoginHandler","loginRequest","credentialToken","undefined","loginResult","retrieveCredential","type","error","LoginCancelledError","numericError","profile","email","newUser","name","cn","username","active","globalRoles","emails","address","verified","RocketChat","generateUsernameSuggestion","insertUserDoc","stampedToken","_generateStampedLoginToken","$push","samlLogin","RelayState","idp","issuer","token","_loginResultForCredentialToken","hasCredential","_","has","closePopup","res","err","writeHead","content","end","samlUrlToObject","url","splitUrl","split","splitPath","actionName","serviceName","middleware","req","next","samlObject","service","find","samlSetting","callbackUrl","absoluteUrl","write","generateServiceProviderMetadata","validateLogoutResponse","query","SAMLResponse","logOutUser","inResponseTo","loggedOutUser","fetch","length","$unset","run","redirect","getAuthorizeUrl","body","validateResponse","inResponseToId","InResponseTo","saml_idp_credentialToken","Random","WebApp","connectHandlers","use","bodyParser","zlib","xml2js","xmlCrypto","crypto","xmldom","querystring","xmlbuilder","options","initialize","prototype","protocol","path","identifierFormat","authnContext","generateUniqueID","chars","uniqueID","i","substr","Math","floor","random","generateInstant","Date","toISOString","signRequest","xml","signer","createSign","sign","privateKey","generateAuthorizeRequest","instant","headers","host","entryPoint","idpSLORedirectURL","operation","callback","self","deflateRaw","buffer","base64","toString","target","indexOf","relayState","samlRequest","SAMLRequest","privateCert","SigAlg","Signature","getLogoutUrl","certToPEM","cert","match","join","validateSignature","doc","DOMParser","parseFromString","signature","xpath","sig","SignedXml","keyInfoProvider","getKeyInfo","getKey","loadSignature","checkSignature","getElement","parentElement","elementName","samlResponse","compressedSAMLResponse","Buffer","inflateRaw","decoded","parser","Parser","explicitRoot","parseString","response","$","status","statusCode","Value","assertion","subject","Format","nameIDFormat","authnStatement","SessionIndex","attributeStatement","attributes","forEach","attribute","value","Name","mail","logoutResponse","decryptionCert","keyDescriptor","replace","metadata","create","pretty","indent","newline","module","export","updateServices","configureSamlService","getSamlConfigs","debounce","logger","Logger","updated","addGroup","addSamlService","add","group","section","i18nLabel","multiline","buttonLabelText","get","key","buttonLabelColor","buttonColor","clientConfig","secret","publicCert","fn","delay","timer","clearTimeout","setTimeout","samlConfigs","map","ServiceConfiguration","configurations","upsert","toLowerCase","remove","e","startup","call"],"mappings":"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","file":"/packages/steffo_meteor-accounts-saml.js","sourcesContent":["/* globals RoutePolicy, SAML */\n/* jshint newcap: false */\n\nif (!Accounts.saml) {\n\tAccounts.saml = {\n\t\tsettings: {\n\t\t\tdebug: true,\n\t\t\tgenerateUsername: false,\n\t\t\tproviders: []\n\t\t}\n\t};\n}\n\nconst fiber = Npm.require('fibers');\nconst connect = Npm.require('connect');\nRoutePolicy.declare('/_saml/', 'network');\n\n/**\n * Fetch SAML provider configs for given 'provider'.\n */\nfunction getSamlProviderConfig(provider) {\n\tif (! provider) {\n\t\tthrow new Meteor.Error('no-saml-provider',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t'SAML internal error',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{ method: 'getSamlProviderConfig' });\n\t}\n\tconst samlProvider = function(element) {\n\t\treturn (element.provider === provider);\n\t};\n\treturn Accounts.saml.settings.providers.filter(samlProvider)[0];\n}\n\nMeteor.methods({\n\tsamlLogout(provider) {\n\t\t// Make sure the user is logged in before initiate SAML SLO\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'samlLogout' });\n\t\t}\n\t\tconst providerConfig = getSamlProviderConfig(provider);\n\n\t\tif (Accounts.saml.settings.debug) {\n\t\t\tconsole.log(`Logout request from ${ JSON.stringify(providerConfig) }`);\n\t\t}\n\t\t// This query should respect upcoming array of SAML logins\n\t\tconst user = Meteor.users.findOne({\n\t\t\t_id: Meteor.userId(),\n\t\t\t'services.saml.provider': provider\n\t\t}, {\n\t\t\t'services.saml': 1\n\t\t});\n\t\tlet nameID = user.services.saml.nameID;\n\t\tconst sessionIndex = user.services.saml.idpSession;\n\t\tnameID = sessionIndex;\n\t\tif (Accounts.saml.settings.debug) {\n\t\t\tconsole.log(`NameID for user ${ Meteor.userId() } found: ${ JSON.stringify(nameID) }`);\n\t\t}\n\n\t\tconst _saml = new SAML(providerConfig);\n\n\t\tconst request = _saml.generateLogoutRequest({\n\t\t\tnameID,\n\t\t\tsessionIndex\n\t\t});\n\n\t\t// request.request: actual XML SAML Request\n\t\t// request.id: comminucation id which will be mentioned in the ResponseTo field of SAMLResponse\n\n\t\tMeteor.users.update({\n\t\t\t_id: Meteor.userId()\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\t'services.saml.inResponseTo': request.id\n\t\t\t}\n\t\t});\n\n\t\tconst _syncRequestToUrl = Meteor.wrapAsync(_saml.requestToUrl, _saml);\n\t\tconst result = _syncRequestToUrl(request.request, 'logout');\n\t\tif (Accounts.saml.settings.debug) {\n\t\t\tconsole.log(`SAML Logout Request ${ result }`);\n\t\t}\n\n\n\t\treturn result;\n\t}\n});\n\nAccounts.registerLoginHandler(function(loginRequest) {\n\tif (!loginRequest.saml || !loginRequest.credentialToken) {\n\t\treturn undefined;\n\t}\n\n\tconst loginResult = Accounts.saml.retrieveCredential(loginRequest.credentialToken);\n\tif (Accounts.saml.settings.debug) {\n\t\tconsole.log(`RESULT :${ JSON.stringify(loginResult) }`);\n\t}\n\n\tif (loginResult === undefined) {\n\t\treturn {\n\t\t\ttype: 'saml',\n\t\t\terror: new Meteor.Error(Accounts.LoginCancelledError.numericError, 'No matching login attempt found')\n\t\t};\n\t}\n\n\tif (loginResult && loginResult.profile && loginResult.profile.email) {\n\t\tlet user = Meteor.users.findOne({\n\t\t\t'emails.address': loginResult.profile.email\n\t\t});\n\n\t\tif (!user) {\n\t\t\tconst newUser = {\n\t\t\t\tname: loginResult.profile.cn || loginResult.profile.username,\n\t\t\t\tactive: true,\n\t\t\t\tglobalRoles: ['user'],\n\t\t\t\temails: [{\n\t\t\t\t\taddress: loginResult.profile.email,\n\t\t\t\t\tverified: true\n\t\t\t\t}]\n\t\t\t};\n\n\t\t\tif (Accounts.saml.settings.generateUsername === true) {\n\t\t\t\tconst username = RocketChat.generateUsernameSuggestion(newUser);\n\t\t\t\tif (username) {\n\t\t\t\t\tnewUser.username = username;\n\t\t\t\t}\n\t\t\t} else if (loginResult.profile.username) {\n\t\t\t\tnewUser.username = loginResult.profile.username;\n\t\t\t}\n\n\t\t\tconst userId = Accounts.insertUserDoc({}, newUser);\n\t\t\tuser = Meteor.users.findOne(userId);\n\t\t}\n\n\t\t//creating the token and adding to the user\n\t\tconst stampedToken = Accounts._generateStampedLoginToken();\n\t\tMeteor.users.update(user, {\n\t\t\t$push: {\n\t\t\t\t'services.resume.loginTokens': stampedToken\n\t\t\t}\n\t\t});\n\n\t\tconst samlLogin = {\n\t\t\tprovider: Accounts.saml.RelayState,\n\t\t\tidp: loginResult.profile.issuer,\n\t\t\tidpSession: loginResult.profile.sessionIndex,\n\t\t\tnameID: loginResult.profile.nameID\n\t\t};\n\n\t\tMeteor.users.update({\n\t\t\t_id: user._id\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\t// TBD this should be pushed, otherwise we're only able to SSO into a single IDP at a time\n\t\t\t\t'services.saml': samlLogin\n\t\t\t}\n\t\t});\n\n\t\t//sending token along with the userId\n\t\tconst result = {\n\t\t\tuserId: user._id,\n\t\t\ttoken: stampedToken.token\n\t\t};\n\n\t\treturn result;\n\n\t} else {\n\t\tthrow new Error('SAML Profile did not contain an email address');\n\t}\n});\n\nAccounts.saml._loginResultForCredentialToken = {};\n\nAccounts.saml.hasCredential = function(credentialToken) {\n\treturn _.has(Accounts.saml._loginResultForCredentialToken, credentialToken);\n};\n\nAccounts.saml.retrieveCredential = function(credentialToken) {\n\t// The credentialToken in all these functions corresponds to SAMLs inResponseTo field and is mandatory to check.\n\tconst result = Accounts.saml._loginResultForCredentialToken[credentialToken];\n\tdelete Accounts.saml._loginResultForCredentialToken[credentialToken];\n\treturn result;\n};\n\nconst closePopup = function(res, err) {\n\tres.writeHead(200, {\n\t\t'Content-Type': 'text/html'\n\t});\n\tlet content = '<html><head><script>window.close()</script></head><body><H1>Verified</H1></body></html>';\n\tif (err) {\n\t\tcontent = `<html><body><h2>Sorry, an annoying error occured</h2><div>${ err }</div><a onclick=\"window.close();\">Close Window</a></body></html>`;\n\t}\n\tres.end(content, 'utf-8');\n};\n\nconst samlUrlToObject = function(url) {\n\t// req.url will be '/_saml/<action>/<service name>/<credentialToken>'\n\tif (!url) {\n\t\treturn null;\n\t}\n\n\tconst splitUrl = url.split('?');\n\tconst splitPath = splitUrl[0].split('/');\n\n\t// Any non-saml request will continue down the default\n\t// middlewares.\n\tif (splitPath[1] !== '_saml') {\n\t\treturn null;\n\t}\n\n\tconst result = {\n\t\tactionName: splitPath[2],\n\t\tserviceName: splitPath[3],\n\t\tcredentialToken: splitPath[4]\n\t};\n\tif (Accounts.saml.settings.debug) {\n\t\tconsole.log(result);\n\t}\n\treturn result;\n};\n\nconst middleware = function(req, res, next) {\n\t// Make sure to catch any exceptions because otherwise we'd crash\n\t// the runner\n\ttry {\n\t\tconst samlObject = samlUrlToObject(req.url);\n\t\tif (!samlObject || !samlObject.serviceName) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\tif (!samlObject.actionName) {\n\t\t\tthrow new Error('Missing SAML action');\n\t\t}\n\n\t\tconsole.log(Accounts.saml.settings.providers);\n\t\tconsole.log(samlObject.serviceName);\n\t\tconst service = _.find(Accounts.saml.settings.providers, function(samlSetting) {\n\t\t\treturn samlSetting.provider === samlObject.serviceName;\n\t\t});\n\n\t\t// Skip everything if there's no service set by the saml middleware\n\t\tif (!service) {\n\t\t\tthrow new Error(`Unexpected SAML service ${ samlObject.serviceName }`);\n\t\t}\n\t\tlet _saml;\n\t\tswitch (samlObject.actionName) {\n\t\t\tcase 'metadata':\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\tservice.callbackUrl = Meteor.absoluteUrl(`_saml/validate/${ service.provider }`);\n\t\t\t\tres.writeHead(200);\n\t\t\t\tres.write(_saml.generateServiceProviderMetadata(service.callbackUrl));\n\t\t\t\tres.end();\n\t\t\t\t//closePopup(res);\n\t\t\t\tbreak;\n\t\t\tcase 'logout':\n\t\t\t\t// This is where we receive SAML LogoutResponse\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\t_saml.validateLogoutResponse(req.query.SAMLResponse, function(err, result) {\n\t\t\t\t\tif (!err) {\n\t\t\t\t\t\tconst logOutUser = function(inResponseTo) {\n\t\t\t\t\t\t\tif (Accounts.saml.settings.debug) {\n\t\t\t\t\t\t\t\tconsole.log(`Logging Out user via inResponseTo ${ inResponseTo }`);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst loggedOutUser = Meteor.users.find({\n\t\t\t\t\t\t\t\t'services.saml.inResponseTo': inResponseTo\n\t\t\t\t\t\t\t}).fetch();\n\t\t\t\t\t\t\tif (loggedOutUser.length === 1) {\n\t\t\t\t\t\t\t\tif (Accounts.saml.settings.debug) {\n\t\t\t\t\t\t\t\t\tconsole.log(`Found user ${ loggedOutUser[0]._id }`);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tMeteor.users.update({\n\t\t\t\t\t\t\t\t\t_id: loggedOutUser[0]._id\n\t\t\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\t\t'services.resume.loginTokens': []\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tMeteor.users.update({\n\t\t\t\t\t\t\t\t\t_id: loggedOutUser[0]._id\n\t\t\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t\t\t$unset: {\n\t\t\t\t\t\t\t\t\t\t'services.saml': ''\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthrow new Meteor.Error('Found multiple users matching SAML inResponseTo fields');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tfiber(function() {\n\t\t\t\t\t\t\tlogOutUser(result);\n\t\t\t\t\t\t}).run();\n\n\n\t\t\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t\t\t'Location': req.query.RelayState\n\t\t\t\t\t\t});\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t}\n\t\t\t\t\t//  else {\n\t\t\t\t\t// \t// TBD thinking of sth meaning full.\n\t\t\t\t\t// }\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase 'sloRedirect':\n\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t// credentialToken here is the SAML LogOut Request that we'll send back to IDP\n\t\t\t\t\t'Location': req.query.redirect\n\t\t\t\t});\n\t\t\t\tres.end();\n\t\t\t\tbreak;\n\t\t\tcase 'authorize':\n\t\t\t\tservice.callbackUrl = Meteor.absoluteUrl(`_saml/validate/${ service.provider }`);\n\t\t\t\tservice.id = samlObject.credentialToken;\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\t_saml.getAuthorizeUrl(req, function(err, url) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Error('Unable to generate authorize url');\n\t\t\t\t\t}\n\t\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t\t'Location': url\n\t\t\t\t\t});\n\t\t\t\t\tres.end();\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase 'validate':\n\t\t\t\t_saml = new SAML(service);\n\t\t\t\tAccounts.saml.RelayState = req.body.RelayState;\n\t\t\t\t_saml.validateResponse(req.body.SAMLResponse, req.body.RelayState, function(err, profile/*, loggedOut*/) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tthrow new Error(`Unable to validate response url: ${ err }`);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst credentialToken = profile.inResponseToId || profile.InResponseTo || samlObject.credentialToken;\n\t\t\t\t\tif (!credentialToken) {\n\t\t\t\t\t\t// No credentialToken in IdP-initiated SSO\n\t\t\t\t\t\tconst saml_idp_credentialToken = Random.id();\n\t\t\t\t\t\tAccounts.saml._loginResultForCredentialToken[saml_idp_credentialToken] = {\n\t\t\t\t\t\t\tprofile\n\t\t\t\t\t\t};\n\t\t\t\t\t\tconst url = `${ Meteor.absoluteUrl('home') }?saml_idp_credentialToken=${ saml_idp_credentialToken }`;\n\t\t\t\t\t\tres.writeHead(302, {\n\t\t\t\t\t\t\t'Location': url\n\t\t\t\t\t\t});\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tAccounts.saml._loginResultForCredentialToken[credentialToken] = {\n\t\t\t\t\t\t\tprofile\n\t\t\t\t\t\t};\n\t\t\t\t\t\tclosePopup(res);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`Unexpected SAML action ${ samlObject.actionName }`);\n\n\t\t}\n\t} catch (err) {\n\t\tclosePopup(res, err);\n\t}\n};\n\n// Listen to incoming SAML http requests\nWebApp.connectHandlers.use(connect.bodyParser()).use(function(req, res, next) {\n\t// Need to create a fiber since we're using synchronous http calls and nothing\n\t// else is wrapping this in a fiber automatically\n\tfiber(function() {\n\t\tmiddleware(req, res, next);\n\t}).run();\n});\n","/* globals SAML:true */\n\nconst zlib = Npm.require('zlib');\nconst xml2js = Npm.require('xml2js');\nconst xmlCrypto = Npm.require('xml-crypto');\nconst crypto = Npm.require('crypto');\nconst xmldom = Npm.require('xmldom');\nconst querystring = Npm.require('querystring');\nconst xmlbuilder = Npm.require('xmlbuilder');\n\n// var prefixMatch = new RegExp(/(?!xmlns)^.*:/);\n\n\nSAML = function(options) {\n\tthis.options = this.initialize(options);\n};\n\n// var stripPrefix = function(str) {\n// \treturn str.replace(prefixMatch, '');\n// };\n\nSAML.prototype.initialize = function(options) {\n\tif (!options) {\n\t\toptions = {};\n\t}\n\n\tif (!options.protocol) {\n\t\toptions.protocol = 'https://';\n\t}\n\n\tif (!options.path) {\n\t\toptions.path = '/saml/consume';\n\t}\n\n\tif (!options.issuer) {\n\t\toptions.issuer = 'onelogin_saml';\n\t}\n\n\tif (options.identifierFormat === undefined) {\n\t\toptions.identifierFormat = 'urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress';\n\t}\n\n\tif (options.authnContext === undefined) {\n\t\toptions.authnContext = 'urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport';\n\t}\n\n\treturn options;\n};\n\nSAML.prototype.generateUniqueID = function() {\n\tconst chars = 'abcdef0123456789';\n\tlet uniqueID = '';\n\tfor (let i = 0; i < 20; i++) {\n\t\tuniqueID += chars.substr(Math.floor((Math.random() * 15)), 1);\n\t}\n\treturn uniqueID;\n};\n\nSAML.prototype.generateInstant = function() {\n\treturn new Date().toISOString();\n};\n\nSAML.prototype.signRequest = function(xml) {\n\tconst signer = crypto.createSign('RSA-SHA1');\n\tsigner.update(xml);\n\treturn signer.sign(this.options.privateKey, 'base64');\n};\n\nSAML.prototype.generateAuthorizeRequest = function(req) {\n\tlet id = `_${ this.generateUniqueID() }`;\n\tconst instant = this.generateInstant();\n\n\t// Post-auth destination\n\tlet callbackUrl;\n\tif (this.options.callbackUrl) {\n\t\tcallbackUrl = this.options.callbackUrl;\n\t} else {\n\t\tcallbackUrl = this.options.protocol + req.headers.host + this.options.path;\n\t}\n\n\tif (this.options.id) {\n\t\tid = this.options.id;\n\t}\n\n\tlet request =\n\t\t`<samlp:AuthnRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" ID=\"${ id }\" Version=\"2.0\" IssueInstant=\"${ instant\n\t\t}\" ProtocolBinding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\" AssertionConsumerServiceURL=\"${ callbackUrl }\" Destination=\"${\n\t\tthis.options.entryPoint }\">` +\n\t\t`<saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">${ this.options.issuer }</saml:Issuer>\\n`;\n\n\tif (this.options.identifierFormat) {\n\t\trequest += `<samlp:NameIDPolicy xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" Format=\"${ this.options.identifierFormat\n\t\t\t}\" AllowCreate=\"true\"></samlp:NameIDPolicy>\\n`;\n\t}\n\n\trequest +=\n\t\t'<samlp:RequestedAuthnContext xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" Comparison=\"exact\">' +\n\t\t'<saml:AuthnContextClassRef xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport</saml:AuthnContextClassRef></samlp:RequestedAuthnContext>\\n' +\n\t\t'</samlp:AuthnRequest>';\n\n\treturn request;\n};\n\nSAML.prototype.generateLogoutRequest = function(options) {\n\t// options should be of the form\n\t// nameId: <nameId as submitted during SAML SSO>\n\t// sessionIndex: sessionIndex\n\t// --- NO SAMLsettings: <Meteor.setting.saml  entry for the provider you want to SLO from\n\n\tconst id = `_${ this.generateUniqueID() }`;\n\tconst instant = this.generateInstant();\n\n\tlet request = `${ '<samlp:LogoutRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\" ' +\n\t\t'xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" ID=\"' }${ id }\" Version=\"2.0\" IssueInstant=\"${ instant\n\t\t}\" Destination=\"${ this.options.idpSLORedirectURL }\">` +\n\t\t`<saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">${ this.options.issuer }</saml:Issuer>` +\n\t\t`<saml:NameID Format=\"${ this.options.identifierFormat }\">${ options.nameID }</saml:NameID>` +\n\t\t'</samlp:LogoutRequest>';\n\n\trequest = `${ '<samlp:LogoutRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\"  ' +\n\t\t'ID=\"' }${ id }\" ` +\n\t\t'Version=\"2.0\" ' +\n\t\t`IssueInstant=\"${ instant }\" ` +\n\t\t`Destination=\"${ this.options.idpSLORedirectURL }\" ` +\n\t\t'>' +\n\t\t`<saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">${ this.options.issuer }</saml:Issuer>` +\n\t\t'<saml:NameID xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\" ' +\n\t\t'NameQualifier=\"http://id.init8.net:8080/openam\" ' +\n\t\t`SPNameQualifier=\"${ this.options.issuer }\" ` +\n\t\t`Format=\"${ this.options.identifierFormat }\">${\n\t\toptions.nameID }</saml:NameID>` +\n\t\t`<samlp:SessionIndex xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\">${ options.sessionIndex }</samlp:SessionIndex>` +\n\t\t'</samlp:LogoutRequest>';\n\tif (Meteor.settings.debug) {\n\t\tconsole.log('------- SAML Logout request -----------');\n\t\tconsole.log(request);\n\t}\n\treturn {\n\t\trequest,\n\t\tid\n\t};\n};\n\nSAML.prototype.requestToUrl = function(request, operation, callback) {\n\tconst self = this;\n\tzlib.deflateRaw(request, function(err, buffer) {\n\t\tif (err) {\n\t\t\treturn callback(err);\n\t\t}\n\n\t\tconst base64 = buffer.toString('base64');\n\t\tlet target = self.options.entryPoint;\n\n\t\tif (operation === 'logout') {\n\t\t\tif (self.options.idpSLORedirectURL) {\n\t\t\t\ttarget = self.options.idpSLORedirectURL;\n\t\t\t}\n\t\t}\n\n\t\tif (target.indexOf('?') > 0) {\n\t\t\ttarget += '&';\n\t\t} else {\n\t\t\ttarget += '?';\n\t\t}\n\n\t\t// TBD. We should really include a proper RelayState here\n\t\tlet relayState;\n\t\tif (operation === 'logout') {\n\t\t\t// in case of logout we want to be redirected back to the Meteor app.\n\t\t\trelayState = Meteor.absoluteUrl();\n\t\t} else {\n\t\t\trelayState = self.options.provider;\n\t\t}\n\n\t\tconst samlRequest = {\n\t\t\tSAMLRequest: base64,\n\t\t\tRelayState: relayState\n\t\t};\n\n\t\tif (self.options.privateCert) {\n\t\t\tsamlRequest.SigAlg = 'http://www.w3.org/2000/09/xmldsig#rsa-sha1';\n\t\t\tsamlRequest.Signature = self.signRequest(querystring.stringify(samlRequest));\n\t\t}\n\n\t\ttarget += querystring.stringify(samlRequest);\n\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log(`requestToUrl: ${ target }`);\n\t\t}\n\t\tif (operation === 'logout') {\n\t\t\t// in case of logout we want to be redirected back to the Meteor app.\n\t\t\treturn callback(null, target);\n\n\t\t} else {\n\t\t\tcallback(null, target);\n\t\t}\n\t});\n};\n\nSAML.prototype.getAuthorizeUrl = function(req, callback) {\n\tconst request = this.generateAuthorizeRequest(req);\n\n\tthis.requestToUrl(request, 'authorize', callback);\n};\n\nSAML.prototype.getLogoutUrl = function(req, callback) {\n\tconst request = this.generateLogoutRequest(req);\n\n\tthis.requestToUrl(request, 'logout', callback);\n};\n\nSAML.prototype.certToPEM = function(cert) {\n\tcert = cert.match(/.{1,64}/g).join('\\n');\n\tcert = `-----BEGIN CERTIFICATE-----\\n${ cert }`;\n\tcert = `${ cert }\\n-----END CERTIFICATE-----\\n`;\n\treturn cert;\n};\n\n// functionfindChilds(node, localName, namespace) {\n// \tvar res = [];\n// \tfor (var i = 0; i < node.childNodes.length; i++) {\n// \t\tvar child = node.childNodes[i];\n// \t\tif (child.localName === localName && (child.namespaceURI === namespace || !namespace)) {\n// \t\t\tres.push(child);\n// \t\t}\n// \t}\n// \treturn res;\n// }\n\nSAML.prototype.validateSignature = function(xml, cert) {\n\tconst self = this;\n\n\tconst doc = new xmldom.DOMParser().parseFromString(xml);\n\tconst signature = xmlCrypto.xpath(doc, '//*[local-name(.)=\\'Signature\\' and namespace-uri(.)=\\'http://www.w3.org/2000/09/xmldsig#\\']')[0];\n\n\tconst sig = new xmlCrypto.SignedXml();\n\n\tsig.keyInfoProvider = {\n\t\tgetKeyInfo(/*key*/) {\n\t\t\treturn '<X509Data></X509Data>';\n\t\t},\n\t\tgetKey(/*keyInfo*/) {\n\t\t\treturn self.certToPEM(cert);\n\t\t}\n\t};\n\n\tsig.loadSignature(signature);\n\n\treturn sig.checkSignature(xml);\n};\n\nSAML.prototype.getElement = function(parentElement, elementName) {\n\tif (parentElement[`saml:${ elementName }`]) {\n\t\treturn parentElement[`saml:${ elementName }`];\n\t} else if (parentElement[`samlp:${ elementName }`]) {\n\t\treturn parentElement[`samlp:${ elementName }`];\n\t} else if (parentElement[`saml2p:${ elementName }`]) {\n\t\treturn parentElement[`saml2p:${ elementName }`];\n\t} else if (parentElement[`saml2:${ elementName }`]) {\n\t\treturn parentElement[`saml2:${ elementName }`];\n\t}\n\treturn parentElement[elementName];\n};\n\nSAML.prototype.validateLogoutResponse = function(samlResponse, callback) {\n\tconst self = this;\n\n\tconst compressedSAMLResponse = new Buffer(samlResponse, 'base64');\n\tzlib.inflateRaw(compressedSAMLResponse, function(err, decoded) {\n\n\t\tif (err) {\n\t\t\tif (Meteor.settings.debug) {\n\t\t\t\tconsole.log(err);\n\t\t\t}\n\t\t} else {\n\t\t\tconst parser = new xml2js.Parser({\n\t\t\t\texplicitRoot: true\n\t\t\t});\n\t\t\tparser.parseString(decoded, function(err, doc) {\n\t\t\t\tconst response = self.getElement(doc, 'LogoutResponse');\n\n\t\t\t\tif (response) {\n\t\t\t\t\t// TBD. Check if this msg corresponds to one we sent\n\t\t\t\t\tconst inResponseTo = response.$.InResponseTo;\n\t\t\t\t\tif (Meteor.settings.debug) {\n\t\t\t\t\t\tconsole.log(`In Response to: ${ inResponseTo }`);\n\t\t\t\t\t}\n\t\t\t\t\tconst status = self.getElement(response, 'Status');\n\t\t\t\t\tconst statusCode = self.getElement(status[0], 'StatusCode')[0].$.Value;\n\t\t\t\t\tif (Meteor.settings.debug) {\n\t\t\t\t\t\tconsole.log(`StatusCode: ${ JSON.stringify(statusCode) }`);\n\t\t\t\t\t}\n\t\t\t\t\tif (statusCode === 'urn:oasis:names:tc:SAML:2.0:status:Success') {\n\t\t\t\t\t\t// In case of a successful logout at IDP we return inResponseTo value.\n\t\t\t\t\t\t// This is the only way how we can identify the Meteor user (as we don't use Session Cookies)\n\t\t\t\t\t\tcallback(null, inResponseTo);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcallback('Error. Logout not confirmed by IDP', null);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tcallback('No Response Found', null);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t});\n};\n\nSAML.prototype.validateResponse = function(samlResponse, relayState, callback) {\n\tconst self = this;\n\tconst xml = new Buffer(samlResponse, 'base64').toString('utf8');\n\t// We currently use RelayState to save SAML provider\n\tif (Meteor.settings.debug) {\n\t\tconsole.log(`Validating response with relay state: ${ xml }`);\n\t}\n\tconst parser = new xml2js.Parser({\n\t\texplicitRoot: true\n\t});\n\n\tparser.parseString(xml, function(err, doc) {\n\t\t// Verify signature\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log('Verify signature');\n\t\t}\n\t\tif (self.options.cert && !self.validateSignature(xml, self.options.cert)) {\n\t\t\tif (Meteor.settings.debug) {\n\t\t\t\tconsole.log('Signature WRONG');\n\t\t\t}\n\t\t\treturn callback(new Error('Invalid signature'), null, false);\n\t\t}\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log('Signature OK');\n\t\t}\n\t\tconst response = self.getElement(doc, 'Response');\n\t\tif (Meteor.settings.debug) {\n\t\t\tconsole.log('Got response');\n\t\t}\n\t\tif (response) {\n\t\t\tconst assertion = self.getElement(response, 'Assertion');\n\t\t\tif (!assertion) {\n\t\t\t\treturn callback(new Error('Missing SAML assertion'), null, false);\n\t\t\t}\n\n\t\t\tconst profile = {};\n\n\t\t\tif (response.$ && response.$.InResponseTo) {\n\t\t\t\tprofile.inResponseToId = response.$.InResponseTo;\n\t\t\t}\n\n\t\t\tconst issuer = self.getElement(assertion[0], 'Issuer');\n\t\t\tif (issuer) {\n\t\t\t\tprofile.issuer = issuer[0]._;\n\t\t\t}\n\n\t\t\tconst subject = self.getElement(assertion[0], 'Subject');\n\n\t\t\tif (subject) {\n\t\t\t\tconst nameID = self.getElement(subject[0], 'NameID');\n\t\t\t\tif (nameID) {\n\t\t\t\t\tprofile.nameID = nameID[0]._;\n\n\t\t\t\t\tif (nameID[0].$.Format) {\n\t\t\t\t\t\tprofile.nameIDFormat = nameID[0].$.Format;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst authnStatement = self.getElement(assertion[0], 'AuthnStatement');\n\n\t\t\tif (authnStatement) {\n\t\t\t\tif (authnStatement[0].$.SessionIndex) {\n\n\t\t\t\t\tprofile.sessionIndex = authnStatement[0].$.SessionIndex;\n\t\t\t\t\tif (Meteor.settings.debug) {\n\t\t\t\t\t\tconsole.log(`Session Index: ${ profile.sessionIndex }`);\n\t\t\t\t\t}\n\t\t\t\t} else if (Meteor.settings.debug) {\n\t\t\t\t\tconsole.log('No Session Index Found');\n\t\t\t\t}\n\n\n\t\t\t} else if (Meteor.settings.debug) {\n\t\t\t\tconsole.log('No AuthN Statement found');\n\t\t\t}\n\n\t\t\tconst attributeStatement = self.getElement(assertion[0], 'AttributeStatement');\n\t\t\tif (attributeStatement) {\n\t\t\t\tconst attributes = self.getElement(attributeStatement[0], 'Attribute');\n\n\t\t\t\tif (attributes) {\n\t\t\t\t\tattributes.forEach(function(attribute) {\n\t\t\t\t\t\tconst value = self.getElement(attribute, 'AttributeValue');\n\t\t\t\t\t\tif (typeof value[0] === 'string') {\n\t\t\t\t\t\t\tprofile[attribute.$.Name] = value[0];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tprofile[attribute.$.Name] = value[0]._;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (!profile.mail && profile['urn:oid:0.9.2342.19200300.100.1.3']) {\n\t\t\t\t\t// See http://www.incommonfederation.org/attributesummary.html for definition of attribute OIDs\n\t\t\t\t\tprofile.mail = profile['urn:oid:0.9.2342.19200300.100.1.3'];\n\t\t\t\t}\n\n\t\t\t\tif (!profile.email && profile.mail) {\n\t\t\t\t\tprofile.email = profile.mail;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!profile.email && profile.nameID && profile.nameIDFormat && profile.nameIDFormat.indexOf('emailAddress') >= 0) {\n\t\t\t\tprofile.email = profile.nameID;\n\t\t\t}\n\t\t\tif (Meteor.settings.debug) {\n\t\t\t\tconsole.log(`NameID: ${ JSON.stringify(profile) }`);\n\t\t\t}\n\n\t\t\tcallback(null, profile, false);\n\t\t} else {\n\t\t\tconst logoutResponse = self.getElement(doc, 'LogoutResponse');\n\n\t\t\tif (logoutResponse) {\n\t\t\t\tcallback(null, null, true);\n\t\t\t} else {\n\t\t\t\treturn callback(new Error('Unknown SAML response message'), null, false);\n\t\t\t}\n\n\t\t}\n\t});\n};\n\nlet decryptionCert;\nSAML.prototype.generateServiceProviderMetadata = function(callbackUrl) {\n\n\tlet keyDescriptor = null;\n\n\tif (!decryptionCert) {\n\t\tdecryptionCert = this.options.privateCert;\n\t}\n\n\tif (this.options.privateKey) {\n\t\tif (!decryptionCert) {\n\t\t\tthrow new Error(\n\t\t\t\t'Missing decryptionCert while generating metadata for decrypting service provider');\n\t\t}\n\n\t\tdecryptionCert = decryptionCert.replace(/-+BEGIN CERTIFICATE-+\\r?\\n?/, '');\n\t\tdecryptionCert = decryptionCert.replace(/-+END CERTIFICATE-+\\r?\\n?/, '');\n\t\tdecryptionCert = decryptionCert.replace(/\\r\\n/g, '\\n');\n\n\t\tkeyDescriptor = {\n\t\t\t'ds:KeyInfo': {\n\t\t\t\t'ds:X509Data': {\n\t\t\t\t\t'ds:X509Certificate': {\n\t\t\t\t\t\t'#text': decryptionCert\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t'#list': [\n\t\t\t\t// this should be the set that the xmlenc library supports\n\t\t\t\t{\n\t\t\t\t\t'EncryptionMethod': {\n\t\t\t\t\t\t'@Algorithm': 'http://www.w3.org/2001/04/xmlenc#aes256-cbc'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t'EncryptionMethod': {\n\t\t\t\t\t\t'@Algorithm': 'http://www.w3.org/2001/04/xmlenc#aes128-cbc'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t'EncryptionMethod': {\n\t\t\t\t\t\t'@Algorithm': 'http://www.w3.org/2001/04/xmlenc#tripledes-cbc'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t};\n\t}\n\n\tif (!this.options.callbackUrl && !callbackUrl) {\n\t\tthrow new Error(\n\t\t\t'Unable to generate service provider metadata when callbackUrl option is not set');\n\t}\n\n\tconst metadata = {\n\t\t'EntityDescriptor': {\n\t\t\t'@xmlns': 'urn:oasis:names:tc:SAML:2.0:metadata',\n\t\t\t'@xmlns:ds': 'http://www.w3.org/2000/09/xmldsig#',\n\t\t\t'@entityID': this.options.issuer,\n\t\t\t'SPSSODescriptor': {\n\t\t\t\t'@protocolSupportEnumeration': 'urn:oasis:names:tc:SAML:2.0:protocol',\n\t\t\t\t'KeyDescriptor': keyDescriptor,\n\t\t\t\t'SingleLogoutService': {\n\t\t\t\t\t'@Binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect',\n\t\t\t\t\t'@Location': `${ Meteor.absoluteUrl() }_saml/logout/${ this.options.provider }/`,\n\t\t\t\t\t'@ResponseLocation': `${ Meteor.absoluteUrl() }_saml/logout/${ this.options.provider }/`\n\t\t\t\t},\n\t\t\t\t'NameIDFormat': this.options.identifierFormat,\n\t\t\t\t'AssertionConsumerService': {\n\t\t\t\t\t'@index': '1',\n\t\t\t\t\t'@isDefault': 'true',\n\t\t\t\t\t'@Binding': 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',\n\t\t\t\t\t'@Location': callbackUrl\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\treturn xmlbuilder.create(metadata).end({\n\t\tpretty: true,\n\t\tindent: '  ',\n\t\tnewline: '\\n'\n\t});\n};\n","const logger = new Logger('steffo:meteor-accounts-saml', {\n\tmethods: {\n\t\tupdated: {\n\t\t\ttype: 'info'\n\t\t}\n\t}\n});\n\nRocketChat.settings.addGroup('SAML');\n\nMeteor.methods({\n\taddSamlService(name) {\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }`, false, {\n\t\t\ttype: 'boolean',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Enable'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_provider`, 'provider-name', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Provider'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_entry_point`, 'https://example.com/simplesaml/saml2/idp/SSOService.php', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Entry_point'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_idp_slo_redirect_url`, 'https://example.com/simplesaml/saml2/idp/SingleLogoutService.php', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_IDP_SLO_Redirect_URL'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_issuer`, 'https://your-rocket-chat/_saml/metadata/provider-name', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Issuer'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_cert`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Cert',\n\t\t\tmultiline: true\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_public_cert`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\tmultiline: true,\n\t\t\ti18nLabel: 'SAML_Custom_Public_Cert'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_private_key`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\tmultiline: true,\n\t\t\ti18nLabel: 'SAML_Custom_Private_Key'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_button_label_text`, '', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Button_Label_Text'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_button_label_color`, '#FFFFFF', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Button_Label_Color'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_button_color`, '#13679A', {\n\t\t\ttype: 'string',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'Accounts_OAuth_Custom_Button_Color'\n\t\t});\n\t\tRocketChat.settings.add(`SAML_Custom_${ name }_generate_username`, false, {\n\t\t\ttype: 'boolean',\n\t\t\tgroup: 'SAML',\n\t\t\tsection: name,\n\t\t\ti18nLabel: 'SAML_Custom_Generate_Username'\n\t\t});\n\t}\n});\n\nconst getSamlConfigs = function(service) {\n\treturn {\n\t\tbuttonLabelText: RocketChat.settings.get(`${ service.key }_button_label_text`),\n\t\tbuttonLabelColor: RocketChat.settings.get(`${ service.key }_button_label_color`),\n\t\tbuttonColor: RocketChat.settings.get(`${ service.key }_button_color`),\n\t\tclientConfig: {\n\t\t\tprovider: RocketChat.settings.get(`${ service.key }_provider`)\n\t\t},\n\t\tentryPoint: RocketChat.settings.get(`${ service.key }_entry_point`),\n\t\tidpSLORedirectURL: RocketChat.settings.get(`${ service.key }_idp_slo_redirect_url`),\n\t\tgenerateUsername: RocketChat.settings.get(`${ service.key }_generate_username`),\n\t\tissuer: RocketChat.settings.get(`${ service.key }_issuer`),\n\t\tsecret: {\n\t\t\tprivateKey: RocketChat.settings.get(`${ service.key }_private_key`),\n\t\t\tpublicCert: RocketChat.settings.get(`${ service.key }_public_cert`),\n\t\t\tcert: RocketChat.settings.get(`${ service.key }_cert`)\n\t\t}\n\t};\n};\n\nconst debounce = (fn, delay) => {\n\tlet timer = null;\n\treturn () => {\n\t\tif (timer != null) {\n\t\t\tMeteor.clearTimeout(timer);\n\t\t}\n\t\treturn timer = Meteor.setTimeout(fn, delay);\n\t};\n};\nconst serviceName = 'saml';\n\nconst configureSamlService = function(samlConfigs) {\n\tlet privateCert = false;\n\tlet privateKey = false;\n\tif (samlConfigs.secret.privateKey && samlConfigs.secret.publicCert) {\n\t\tprivateKey = samlConfigs.secret.privateKey;\n\t\tprivateCert = samlConfigs.secret.publicCert;\n\t} else if (samlConfigs.secret.privateKey || samlConfigs.secret.publicCert) {\n\t\tlogger.error('You must specify both cert and key files.');\n\t}\n\t// TODO: the function configureSamlService is called many times and Accounts.saml.settings.generateUsername keeps just the last value\n\tAccounts.saml.settings.generateUsername = samlConfigs.generateUsername;\n\treturn {\n\t\tprovider: samlConfigs.clientConfig.provider,\n\t\tentryPoint: samlConfigs.entryPoint,\n\t\tidpSLORedirectURL: samlConfigs.idpSLORedirectURL,\n\t\tissuer: samlConfigs.issuer,\n\t\tcert: samlConfigs.secret.cert,\n\t\tprivateCert,\n\t\tprivateKey\n\t};\n};\n\nconst updateServices = debounce(() => {\n\tconst services = RocketChat.settings.get(/^(SAML_Custom_)[a-z]+$/i);\n\tAccounts.saml.settings.providers = services.map((service) => {\n\t\tif (service.value === true) {\n\t\t\tconst samlConfigs = getSamlConfigs(service);\n\t\t\tlogger.updated(service.key);\n\t\t\tServiceConfiguration.configurations.upsert({\n\t\t\t\tservice: serviceName.toLowerCase()\n\t\t\t}, {\n\t\t\t\t$set: samlConfigs\n\t\t\t});\n\t\t\treturn configureSamlService(samlConfigs);\n\t\t} else {\n\t\t\tServiceConfiguration.configurations.remove({\n\t\t\t\tservice: serviceName.toLowerCase()\n\t\t\t});\n\t\t}\n\t}).filter(e => e);\n}, 2000);\n\n\nRocketChat.settings.get(/^SAML_.+/, updateServices);\n\nMeteor.startup(() => {\n\treturn Meteor.call('addSamlService', 'Default');\n});\n\nexport {\n\tupdateServices,\n\tconfigureSamlService,\n\tgetSamlConfigs,\n\tdebounce,\n\tlogger\n};\n"]}