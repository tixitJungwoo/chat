{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:reactions/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:reactions/setReaction.js"],"names":["RocketChat","models","Messages","setReactions","messageId","reactions","update","_id","$set","unsetReactions","$unset","Meteor","methods","setReaction","reaction","userId","Error","method","message","findOneById","room","call","rid","user","Array","isArray","muted","indexOf","username","reactWhenReadOnly","Notifications","notifyUser","Random","id","ts","Date","msg","TAPi18n","__","language","Subscriptions","findOne","usernames","splice","length","_","isEmpty","callbacks","run","push","msgStream","emit"],"mappings":"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","file":"/packages/rocketchat_reactions.js","sourcesContent":["RocketChat.models.Messages.setReactions = function(messageId, reactions) {\n\treturn this.update({ _id: messageId }, { $set: { reactions }});\n};\n\nRocketChat.models.Messages.unsetReactions = function(messageId) {\n\treturn this.update({ _id: messageId }, { $unset: { reactions: 1 }});\n};\n","/* globals msgStream */\nMeteor.methods({\n\tsetReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'setReaction' });\n\t\t}\n\n\t\tconst message = RocketChat.models.Messages.findOneById(messageId);\n\n\t\tif (!message) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', message.rid, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t_id: Random.id(),\n\t\t\t\trid: room._id,\n\t\t\t\tts: new Date(),\n\t\t\t\tmsg: TAPi18n.__('You_have_been_muted', {}, user.language)\n\t\t\t});\n\t\t\treturn false;\n\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions && message.reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (_.isEmpty(message.reactions)) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tRocketChat.models.Messages.unsetReactions(messageId);\n\t\t\t\tRocketChat.callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: []\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\n\t\tmsgStream.emit(message.rid, message);\n\n\t\treturn;\n\t}\n});\n"]}