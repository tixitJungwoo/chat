{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/methods/snippetMessage.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/requests.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/publications/snippetedMessagesByRoom.js","meteor://ðŸ’»app/packages/rocketchat:message-snippet/server/publications/snippetedMessage.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","models","Permissions","upsert","$setOnInsert","roles","methods","snippetMessage","message","filename","userId","Error","method","room","Rooms","findOne","_id","rid","Array","isArray","usernames","indexOf","user","username","get","Messages","cloneAndSaveAsHistoryById","me","Users","findOneById","snippeted","snippetedAt","Date","now","snippetedBy","callbacks","run","setSnippetedByIdAndUserId","createWithTypeRoomIdMessageAndUser","WebApp","connectHandlers","use","req","res","rawCookies","token","uid","cookie","Cookies","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","writeHead","end","match","exec","url","snippet","undefined","setHeader","encodeURIComponent","snippetName","snippetContent","msg","substr","length","write","publish","limit","ready","publication","cursorHandle","findSnippetedByRoom","sort","ts","observeChanges","added","record","changed","removed","onStop","stop","roomSnippetQuery","cursor","find"],"mappings":"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","file":"/packages/rocketchat_message-snippet.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('Message_AllowSnippeting', false, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\tgroup: 'Message'\n\t});\n\tRocketChat.models.Permissions.upsert('snippet-message', {\n\t\t$setOnInsert: {\n\t\t\troles: ['owner', 'moderator', 'admin']\n\t\t}\n\t});\n});\n\n","Meteor.methods({\n\tsnippetMessage(message, filename) {\n\t\tif ((typeof Meteor.userId() === 'undefined') || (Meteor.userId() === null)) {\n\t\t\t//noinspection JSUnresolvedFunction\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user',\n\t\t\t\t{method: 'snippetMessage'});\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOne({ _id: message.rid });\n\n\t\tif ((typeof room === 'undefined') || (room === null)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (Array.isArray(room.usernames) && (room.usernames.indexOf(Meteor.user().username) === -1)) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// If we keep history of edits, insert a new message to store history information\n\t\tif (RocketChat.settings.get('Message_KeepHistory')) {\n\t\t\tRocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);\n\t\t}\n\n\t\tconst me = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tmessage.snippeted = true;\n\t\tmessage.snippetedAt = Date.now;\n\t\tmessage.snippetedBy = {\n\t\t\t_id: Meteor.userId(),\n\t\t\tusername: me.username\n\t\t};\n\n\t\tmessage = RocketChat.callbacks.run('beforeSaveMessage', message);\n\n\t\t// Create the SnippetMessage\n\t\tRocketChat.models.Messages.setSnippetedByIdAndUserId(message, filename, message.snippetedBy,\n\t\t\tmessage.snippeted, Date.now, filename);\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser(\n\t\t\t'message_snippeted', message.rid, '', me, {\t'snippetId': message._id, 'snippetName': filename });\n\t}\n});\n","/* global Cookies */\nWebApp.connectHandlers.use('/snippet/download', function(req, res) {\n\tlet rawCookies;\n\tlet token;\n\tlet uid;\n\tconst cookie = new Cookies();\n\n\tif (req.headers && req.headers.cookie !== null) {\n\t\trawCookies = req.headers.cookie;\n\t}\n\n\tif (rawCookies !== null) {\n\t\tuid = cookie.get('rc_uid', rawCookies);\n\t}\n\n\tif (rawCookies !== null) {\n\t\ttoken = cookie.get('rc_token', rawCookies);\n\t}\n\n\tif (uid === null) {\n\t\tuid = req.query.rc_uid;\n\t\ttoken = req.query.rc_token;\n\t}\n\n\tconst user = RocketChat.models.Users.findOneByIdAndLoginToken(uid, token);\n\n\tif (!(uid && token && user)) {\n\t\tres.writeHead(403);\n\t\tres.end();\n\t\treturn false;\n\t}\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst snippet = RocketChat.models.Messages.findOne(\n\t\t\t{\n\t\t\t\t'_id': match[1],\n\t\t\t\t'snippeted': true\n\t\t\t}\n\t\t);\n\t\tconst room = RocketChat.models.Rooms.findOne({ '_id': snippet.rid, 'usernames': { '$in': [user.username] }});\n\t\tif (room === undefined) {\n\t\t\tres.writeHead(403);\n\t\t\tres.end();\n\t\t\treturn false;\n\t\t}\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(snippet.snippetName) }`);\n\t\tres.setHeader('Content-Type', 'application/octet-stream');\n\n\t\t// Removing the ``` contained in the msg.\n\t\tconst snippetContent = snippet.msg.substr(3, snippet.msg.length - 6);\n\t\tres.setHeader('Content-Length', snippetContent.length);\n\t\tres.write(snippetContent);\n\t\tres.end();\n\t\treturn;\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","Meteor.publish('snippetedMessages', function(rid, limit=50) {\n\tif (typeof this.userId === 'undefined' || this.userId === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst publication = this;\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (typeof user === 'undefined' || user === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst cursorHandle = RocketChat.models.Messages.findSnippetedByRoom(\n\t\trid,\n\t\t{\n\t\t\tsort: {ts: -1},\n\t\t\tlimit\n\t\t}\n\t).observeChanges({\n\t\tadded(_id, record) {\n\t\t\tpublication.added('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tchanged(_id, record) {\n\t\t\tpublication.changed('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tremoved(_id) {\n\t\t\tpublication.removed('rocketchat_snippeted_message', _id);\n\t\t}\n\t});\n\tthis.ready();\n\n\tthis.onStop = function() {\n\t\tcursorHandle.stop();\n\t};\n});\n","Meteor.publish('snippetedMessage', function(_id) {\n\tif (typeof this.userId === 'undefined' || this.userId === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst snippet = RocketChat.models.Messages.findOne({_id, snippeted: true});\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\tconst roomSnippetQuery = {\n\t\t'_id': snippet.rid,\n\t\t'usernames': {\n\t\t\t'$in': [\n\t\t\t\tuser.username\n\t\t\t]\n\t\t}\n\t};\n\n\tif (RocketChat.models.Rooms.findOne(roomSnippetQuery) === undefined) {\n\t\treturn this.ready();\n\t}\n\n\tconst publication = this;\n\n\n\tif (typeof user === 'undefined' || user === null) {\n\t\treturn this.ready();\n\t}\n\n\tconst cursor = RocketChat.models.Messages.find(\n\t\t{ _id }\n\t).observeChanges({\n\t\tadded(_id, record) {\n\t\t\tpublication.added('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tchanged(_id, record) {\n\t\t\tpublication.changed('rocketchat_snippeted_message', _id, record);\n\t\t},\n\t\tremoved(_id) {\n\t\t\tpublication.removed('rocketchat_snippeted_message', _id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop = function() {\n\t\tcursor.stop();\n\t};\n});\n"]}