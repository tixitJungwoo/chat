{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:otr/client/rocketchat.otr.js","meteor://ðŸ’»app/packages/rocketchat:otr/client/rocketchat.otr.room.js","meteor://ðŸ’»app/packages/rocketchat:otr/client/views/otrFlexTab.js","meteor://ðŸ’»app/packages/rocketchat:otr/client/tabBar.js"],"names":["OTR","enabled","ReactiveVar","instancesByRoomId","isEnabled","get","getInstanceByRoomId","roomId","subscription","RocketChat","models","Subscriptions","findOne","rid","t","Room","Meteor","userId","startup","Tracker","autorun","Notifications","onUser","type","data","onUserStream","promises","add","message","established","encrypt","then","msg","Promise","resolve","priority","HIGH","notification","otrRoom","decrypt","_id","text","ack","ts","otrAck","encryptText","call","toastr","module","watch","require","v","peerId","replace","establishing","userOnlineComputation","keyPair","exportedPublicKey","sessionKey","handshake","refresh","set","firstPeer","generateKeyPair","notifyUser","publicKey","EJSON","stringify","acknowledge","deny","reset","end","stop","$room","$","$title","length","prepend","addClass","remove","removeClass","crypto","generateKey","name","namedCurve","exportKey","catch","e","error","importPublicKey","importKey","parse","peerPublicKey","deriveBits","privateKey","bits","digest","hashedBits","sessionKeyData","Uint8Array","slice","_","isObject","TextEncoder","encode","Random","id","fraction","iv","getRandomValues","cipherText","output","Error","isNaN","TimeSync","serverOffset","Date","now","enc","TextDecoder","decode","user","users","timeout","establishConnection","clearTimeout","FlowRouter","goToRoomById","defer","swal","title","TAPi18n","__","username","html","showCancelButton","allowOutsideClick","confirmButtonText","cancelButtonText","isConfirm","setTimeout","close","Template","otrFlexTab","helpers","otrAvailable","userIsOnline","status","online","otr","events","preventDefault","onCreated","settings","window","subtle","webkitSubtle","TabBar","addButton","groups","i18nTitle","icon","template","order","removeButton"],"mappings":"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","file":"/packages/rocketchat_otr.js","sourcesContent":["class OTR {\n\tconstructor() {\n\t\tthis.enabled = new ReactiveVar(false);\n\t\tthis.instancesByRoomId = {};\n\t}\n\n\tisEnabled() {\n\t\treturn this.enabled.get();\n\t}\n\n\tgetInstanceByRoomId(roomId) {\n\t\tif (!this.enabled.get()) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.instancesByRoomId[roomId]) {\n\t\t\treturn this.instancesByRoomId[roomId];\n\t\t}\n\n\t\tconst subscription = RocketChat.models.Subscriptions.findOne({\n\t\t\trid: roomId\n\t\t});\n\n\t\tif (!subscription || subscription.t !== 'd') {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.instancesByRoomId[roomId] = new RocketChat.OTR.Room(Meteor.userId(), roomId);\n\t\treturn this.instancesByRoomId[roomId];\n\t}\n}\n\nRocketChat.OTR = new OTR();\n\nMeteor.startup(function() {\n\tTracker.autorun(function() {\n\t\tif (Meteor.userId()) {\n\t\t\tRocketChat.Notifications.onUser('otr', (type, data) => {\n\t\t\t\tif (!data.roomId || !data.userId || data.userId === Meteor.userId()) {\n\t\t\t\t\treturn;\n\t\t\t\t} else {\n\t\t\t\t\tRocketChat.OTR.getInstanceByRoomId(data.roomId).onUserStream(type, data);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n\n\tRocketChat.promises.add('onClientBeforeSendMessage', function(message) {\n\t\tif (message.rid && RocketChat.OTR.getInstanceByRoomId(message.rid) && RocketChat.OTR.getInstanceByRoomId(message.rid).established.get()) {\n\t\t\treturn RocketChat.OTR.getInstanceByRoomId(message.rid).encrypt(message)\n\t\t\t\t.then((msg) => {\n\t\t\t\t\tmessage.msg = msg;\n\t\t\t\t\tmessage.t = 'otr';\n\t\t\t\t\treturn message;\n\t\t\t\t});\n\t\t} else {\n\t\t\treturn Promise.resolve(message);\n\t\t}\n\t}, RocketChat.promises.priority.HIGH);\n\n\tRocketChat.promises.add('onClientMessageReceived', function(message) {\n\t\tif (message.rid && RocketChat.OTR.getInstanceByRoomId(message.rid) && RocketChat.OTR.getInstanceByRoomId(message.rid).established.get()) {\n\t\t\tif (message.notification) {\n\t\t\t\tmessage.msg = t('Encrypted_message');\n\t\t\t\treturn Promise.resolve(message);\n\t\t\t} else {\n\t\t\t\tconst otrRoom = RocketChat.OTR.getInstanceByRoomId(message.rid);\n\t\t\t\treturn otrRoom.decrypt(message.msg)\n\t\t\t\t\t.then((data) => {\n\t\t\t\t\t\tconst {_id, text, ack} = data;\n\t\t\t\t\t\tmessage._id = _id;\n\t\t\t\t\t\tmessage.msg = text;\n\n\t\t\t\t\t\tif (data.ts) {\n\t\t\t\t\t\t\tmessage.ts = data.ts;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (message.otrAck) {\n\t\t\t\t\t\t\treturn otrRoom.decrypt(message.otrAck)\n\t\t\t\t\t\t\t\t.then((data) => {\n\t\t\t\t\t\t\t\t\tif (ack === data.text) {\n\t\t\t\t\t\t\t\t\t\tmessage.t = 'otr-ack';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn message;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else if (data.userId !== Meteor.userId()) {\n\t\t\t\t\t\t\treturn otrRoom.encryptText(ack)\n\t\t\t\t\t\t\t\t.then((ack) => {\n\t\t\t\t\t\t\t\t\tMeteor.call('updateOTRAck', message._id, ack);\n\t\t\t\t\t\t\t\t\treturn message;\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treturn message;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tif (message.t === 'otr') {\n\t\t\t\tmessage.msg = '';\n\t\t\t}\n\t\t\treturn Promise.resolve(message);\n\t\t}\n\t}, RocketChat.promises.priority.HIGH);\n});\n","import toastr from 'toastr';\n/* globals crypto */\n\nRocketChat.OTR.Room = class {\n\tconstructor(userId, roomId) {\n\t\tthis.userId = userId;\n\t\tthis.roomId = roomId;\n\t\tthis.peerId = roomId.replace(userId, '');\n\t\tthis.established = new ReactiveVar(false);\n\t\tthis.establishing = new ReactiveVar(false);\n\n\t\tthis.userOnlineComputation = null;\n\n\t\tthis.keyPair = null;\n\t\tthis.exportedPublicKey = null;\n\t\tthis.sessionKey = null;\n\t}\n\n\thandshake(refresh) {\n\t\tthis.establishing.set(true);\n\t\tthis.firstPeer = true;\n\t\tthis.generateKeyPair().then(() => {\n\t\t\tRocketChat.Notifications.notifyUser(this.peerId, 'otr', 'handshake', { roomId: this.roomId, userId: this.userId, publicKey: EJSON.stringify(this.exportedPublicKey), refresh });\n\t\t});\n\t}\n\n\tacknowledge() {\n\t\tRocketChat.Notifications.notifyUser(this.peerId, 'otr', 'acknowledge', { roomId: this.roomId, userId: this.userId, publicKey: EJSON.stringify(this.exportedPublicKey) });\n\t}\n\n\tdeny() {\n\t\tthis.reset();\n\t\tRocketChat.Notifications.notifyUser(this.peerId, 'otr', 'deny', { roomId: this.roomId, userId: this.userId });\n\t}\n\n\tend() {\n\t\tthis.reset();\n\t\tRocketChat.Notifications.notifyUser(this.peerId, 'otr', 'end', { roomId: this.roomId, userId: this.userId });\n\t}\n\n\treset() {\n\t\tthis.establishing.set(false);\n\t\tthis.established.set(false);\n\t\tthis.keyPair = null;\n\t\tthis.exportedPublicKey = null;\n\t\tthis.sessionKey = null;\n\t\tMeteor.call('deleteOldOTRMessages', this.roomId);\n\t}\n\n\tgenerateKeyPair() {\n\t\tif (this.userOnlineComputation) {\n\t\t\tthis.userOnlineComputation.stop();\n\t\t}\n\n\t\tthis.userOnlineComputation = Tracker.autorun(() => {\n\t\t\tconst $room = $(`#chat-window-${ this.roomId }`);\n\t\t\tconst $title = $('.fixed-title h2', $room);\n\t\t\tif (this.established.get()) {\n\t\t\t\tif ($room.length && $title.length && !$('.otr-icon', $title).length) {\n\t\t\t\t\t$title.prepend('<i class=\\'otr-icon icon-key\\'></i>');\n\t\t\t\t\t$('.input-message-container').addClass('otr');\n\t\t\t\t\t$('.inner-right-toolbar').prepend('<i class=\\'otr-icon icon-key\\'></i>');\n\t\t\t\t}\n\t\t\t} else if ($title.length) {\n\t\t\t\t$('.otr-icon', $title).remove();\n\t\t\t\t$('.input-message-container').removeClass('otr');\n\t\t\t\t$('.inner-right-toolbar .otr-icon').remove();\n\t\t\t}\n\t\t});\n\n\t\t// Generate an ephemeral key pair.\n\t\treturn RocketChat.OTR.crypto.generateKey({\n\t\t\tname: 'ECDH',\n\t\t\tnamedCurve: 'P-256'\n\t\t}, false, ['deriveKey', 'deriveBits'])\n\t\t\t.then((keyPair) => {\n\t\t\t\tthis.keyPair = keyPair;\n\t\t\t\treturn RocketChat.OTR.crypto.exportKey('jwk', keyPair.publicKey);\n\t\t\t})\n\t\t\t.then((exportedPublicKey) => {\n\t\t\t\tthis.exportedPublicKey = exportedPublicKey;\n\n\t\t\t\t// Once we have generated new keys, it's safe to delete old messages\n\t\t\t\tMeteor.call('deleteOldOTRMessages', this.roomId);\n\t\t\t})\n\t\t\t.catch((e) => {\n\t\t\t\ttoastr.error(e);\n\t\t\t});\n\t}\n\n\timportPublicKey(publicKey) {\n\t\treturn RocketChat.OTR.crypto.importKey('jwk', EJSON.parse(publicKey), {\n\t\t\tname: 'ECDH',\n\t\t\tnamedCurve: 'P-256'\n\t\t}, false, []).then((peerPublicKey) => {\n\t\t\treturn RocketChat.OTR.crypto.deriveBits({\n\t\t\t\tname: 'ECDH',\n\t\t\t\tnamedCurve: 'P-256',\n\t\t\t\tpublic: peerPublicKey\n\t\t\t}, this.keyPair.privateKey, 256);\n\t\t}).then((bits) => {\n\t\t\treturn RocketChat.OTR.crypto.digest({\n\t\t\t\tname: 'SHA-256'\n\t\t\t}, bits);\n\t\t}).then((hashedBits) => {\n\t\t\t// We truncate the hash to 128 bits.\n\t\t\tconst sessionKeyData = new Uint8Array(hashedBits).slice(0, 16);\n\t\t\treturn RocketChat.OTR.crypto.importKey('raw', sessionKeyData, {\n\t\t\t\tname: 'AES-GCM'\n\t\t\t}, false, ['encrypt', 'decrypt']);\n\t\t}).then((sessionKey) => {\n\t\t\t// Session key available.\n\t\t\tthis.sessionKey = sessionKey;\n\t\t});\n\t}\n\n\tencryptText(data) {\n\t\tif (!_.isObject(data)) {\n\t\t\tdata = new TextEncoder('UTF-8').encode(EJSON.stringify({ text: data, ack: Random.id((Random.fraction()+1)*20) }));\n\t\t}\n\t\tconst iv = crypto.getRandomValues(new Uint8Array(12));\n\n\t\treturn RocketChat.OTR.crypto.encrypt({\n\t\t\tname: 'AES-GCM',\n\t\t\tiv\n\t\t}, this.sessionKey, data).then((cipherText) => {\n\t\t\tcipherText = new Uint8Array(cipherText);\n\t\t\tconst output = new Uint8Array(iv.length + cipherText.length);\n\t\t\toutput.set(iv, 0);\n\t\t\toutput.set(cipherText, iv.length);\n\t\t\treturn EJSON.stringify(output);\n\t\t}).catch(() => {\n\t\t\tthrow new Meteor.Error('encryption-error', 'Encryption error.');\n\t\t});\n\t}\n\n\tencrypt(message) {\n\t\tlet ts;\n\t\tif (isNaN(TimeSync.serverOffset())) {\n\t\t\tts = new Date();\n\t\t} else {\n\t\t\tts = new Date(Date.now() + TimeSync.serverOffset());\n\t\t}\n\n\t\tconst data = new TextEncoder('UTF-8').encode(EJSON.stringify({\n\t\t\t_id: message._id,\n\t\t\ttext: message.msg,\n\t\t\tuserId: this.userId,\n\t\t\tack: Random.id((Random.fraction()+1)*20),\n\t\t\tts\n\t\t}));\n\t\tconst enc = this.encryptText(data);\n\t\treturn enc;\n\t}\n\n\tdecrypt(message) {\n\t\tlet cipherText = EJSON.parse(message);\n\t\tconst iv = cipherText.slice(0, 12);\n\t\tcipherText = cipherText.slice(12);\n\n\t\treturn RocketChat.OTR.crypto.decrypt({\n\t\t\tname: 'AES-GCM',\n\t\t\tiv\n\t\t}, this.sessionKey, cipherText)\n\t\t\t.then((data) => {\n\t\t\t\tdata = EJSON.parse(new TextDecoder('UTF-8').decode(new Uint8Array(data)));\n\t\t\t\treturn data;\n\t\t\t})\n\t\t\t.catch((e) => {\n\t\t\t\ttoastr.error(e);\n\t\t\t\treturn message;\n\t\t\t});\n\t}\n\n\tonUserStream(type, data) {\n\t\tconst user = Meteor.users.findOne(data.userId);\n\t\tswitch (type) {\n\t\t\tcase 'handshake':\n\t\t\t\tlet timeout = null;\n\n\t\t\t\tconst establishConnection = () => {\n\t\t\t\t\tthis.establishing.set(true);\n\t\t\t\t\tMeteor.clearTimeout(timeout);\n\t\t\t\t\tthis.generateKeyPair().then(() => {\n\t\t\t\t\t\tthis.importPublicKey(data.publicKey).then(() => {\n\t\t\t\t\t\t\tthis.firstPeer = false;\n\t\t\t\t\t\t\tFlowRouter.goToRoomById(data.roomId);\n\t\t\t\t\t\t\tMeteor.defer(() => {\n\t\t\t\t\t\t\t\tthis.established.set(true);\n\t\t\t\t\t\t\t\tthis.acknowledge();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\tif (data.refresh && this.established.get()) {\n\t\t\t\t\tthis.reset();\n\t\t\t\t\testablishConnection();\n\t\t\t\t} else {\n\t\t\t\t\tif (this.established.get()) {\n\t\t\t\t\t\tthis.reset();\n\t\t\t\t\t}\n\n\t\t\t\t\tswal({\n\t\t\t\t\t\ttitle: `<i class='icon-key alert-icon success-color'></i>${ TAPi18n.__('OTR') }`,\n\t\t\t\t\t\ttext: TAPi18n.__('Username_wants_to_start_otr_Do_you_want_to_accept', { username: user.username }),\n\t\t\t\t\t\thtml: true,\n\t\t\t\t\t\tshowCancelButton: true,\n\t\t\t\t\t\tallowOutsideClick: false,\n\t\t\t\t\t\tconfirmButtonText: TAPi18n.__('Yes'),\n\t\t\t\t\t\tcancelButtonText: TAPi18n.__('No')\n\t\t\t\t\t}, (isConfirm) => {\n\t\t\t\t\t\tif (isConfirm) {\n\t\t\t\t\t\t\testablishConnection();\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tMeteor.clearTimeout(timeout);\n\t\t\t\t\t\t\tthis.deny();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\ttimeout = Meteor.setTimeout(() => {\n\t\t\t\t\tthis.establishing.set(false);\n\t\t\t\t\tswal.close();\n\t\t\t\t}, 10000);\n\n\t\t\t\tbreak;\n\n\t\t\tcase 'acknowledge':\n\t\t\t\tthis.importPublicKey(data.publicKey).then(() => {\n\t\t\t\t\tthis.established.set(true);\n\t\t\t\t});\n\t\t\t\tbreak;\n\n\t\t\tcase 'deny':\n\t\t\t\tif (this.establishing.get()) {\n\t\t\t\t\tthis.reset();\n\t\t\t\t\tconst user = Meteor.users.findOne(this.peerId);\n\t\t\t\t\tswal({\n\t\t\t\t\t\ttitle: `<i class='icon-key alert-icon success-color'></i>${ TAPi18n.__('OTR') }`,\n\t\t\t\t\t\ttext: TAPi18n.__('Username_denied_the_OTR_session', { username: user.username }),\n\t\t\t\t\t\thtml: true\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'end':\n\t\t\t\tif (this.established.get()) {\n\t\t\t\t\tthis.reset();\n\t\t\t\t\tconst user = Meteor.users.findOne(this.peerId);\n\t\t\t\t\tswal({\n\t\t\t\t\t\ttitle: `<i class='icon-key alert-icon success-color'></i>${ TAPi18n.__('OTR') }`,\n\t\t\t\t\t\ttext: TAPi18n.__('Username_ended_the_OTR_session', { username: user.username }),\n\t\t\t\t\t\thtml: true\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t}\n};\n","Template.otrFlexTab.helpers({\n\totrAvailable() {\n\t\treturn RocketChat.OTR && RocketChat.OTR.isEnabled();\n\t},\n\tuserIsOnline() {\n\t\t// I have to appear online for the other user\n\t\tif (Meteor.user().status === 'offline') {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.rid) {\n\t\t\tconst peerId = this.rid.replace(Meteor.userId(), '');\n\t\t\tif (peerId) {\n\t\t\t\tconst user = Meteor.users.findOne(peerId);\n\t\t\t\tconst online = user && user.status !== 'offline';\n\t\t\t\treturn online;\n\t\t\t}\n\t\t}\n\t},\n\testablished() {\n\t\tconst otr = RocketChat.OTR.getInstanceByRoomId(this.rid);\n\t\treturn otr && otr.established.get();\n\t},\n\testablishing() {\n\t\tconst otr = RocketChat.OTR.getInstanceByRoomId(this.rid);\n\t\treturn otr && otr.establishing.get();\n\t}\n});\n\nTemplate.otrFlexTab.events({\n\t'click button.start'(e, t) {\n\t\te.preventDefault();\n\t\tconst otr = RocketChat.OTR.getInstanceByRoomId(this.rid);\n\t\tif (otr) {\n\t\t\totr.handshake();\n\t\t\tt.timeout = Meteor.setTimeout(() => {\n\t\t\t\tswal('Timeout', '', 'error');\n\t\t\t\totr.establishing.set(false);\n\t\t\t}, 10000);\n\t\t}\n\t},\n\t'click button.refresh'(e, t) {\n\t\te.preventDefault();\n\t\tconst otr = RocketChat.OTR.getInstanceByRoomId(this.rid);\n\t\tif (otr) {\n\t\t\totr.reset();\n\t\t\totr.handshake(true);\n\t\t\tt.timeout = Meteor.setTimeout(() => {\n\t\t\t\tswal('Timeout', '', 'error');\n\t\t\t\totr.establishing.set(false);\n\t\t\t}, 10000);\n\t\t}\n\t},\n\t'click button.end'(e/*, t*/) {\n\t\te.preventDefault();\n\t\tconst otr = RocketChat.OTR.getInstanceByRoomId(this.rid);\n\t\tif (otr) {\n\t\t\totr.end();\n\t\t}\n\t}\n});\n\nTemplate.otrFlexTab.onCreated(function() {\n\tthis.timeout = null;\n\tthis.autorun(() => {\n\t\tconst otr = RocketChat.OTR.getInstanceByRoomId(this.data.rid);\n\t\tif (otr && otr.established.get()) {\n\t\t\tMeteor.clearTimeout(this.timeout);\n\t\t}\n\t});\n});\n","Meteor.startup(function() {\n\tTracker.autorun(function() {\n\t\tif (RocketChat.settings.get('OTR_Enable') && window.crypto) {\n\t\t\tRocketChat.OTR.crypto = window.crypto.subtle || window.crypto.webkitSubtle;\n\t\t\tRocketChat.OTR.enabled.set(true);\n\t\t\tRocketChat.TabBar.addButton({\n\t\t\t\tgroups: ['direct'],\n\t\t\t\tid: 'otr',\n\t\t\t\ti18nTitle: 'OTR',\n\t\t\t\ticon: 'icon-key',\n\t\t\t\ttemplate: 'otrFlexTab',\n\t\t\t\torder: 11\n\t\t\t});\n\t\t} else {\n\t\t\tRocketChat.OTR.enabled.set(false);\n\t\t\tRocketChat.TabBar.removeButton('otr');\n\t\t}\n\t});\n});\n"]}