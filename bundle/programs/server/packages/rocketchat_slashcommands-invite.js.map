{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:slashcommands-invite/server.js"],"names":["module","export","Invite","command","params","item","Match","test","String","usernames","replace","split","filter","a","length","users","Meteor","find","username","$in","currentUser","findOne","userId","count","RocketChat","Notifications","notifyUser","_id","Random","id","rid","ts","Date","msg","TAPi18n","__","postProcess","sprintf","join","language","models","Rooms","findOneByIdContainingUsername","forEach","user","call","error","slashCommands","add"],"mappings":"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","file":"/packages/rocketchat_slashcommands-invite.js","sourcesContent":["\n/*\n* Invite is a named function that will replace /invite commands\n* @param {Object} message - The message object\n*/\n\n\nfunction Invite(command, params, item) {\n\n\tif (command !== 'invite' || !Match.test(params, String)) {\n\t\treturn;\n\t}\n\tlet usernames = params.replace(/@/g, '').split(/[\\s,]/).filter((a) => a !== '');\n\tif (usernames.length === 0) {\n\t\treturn;\n\t}\n\tconst users = Meteor.users.find({\n\t\tusername: {\n\t\t\t$in: usernames\n\t\t}\n\t});\n\tconst currentUser = Meteor.users.findOne(Meteor.userId());\n\tif (users.count() === 0) {\n\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t_id: Random.id(),\n\t\t\trid: item.rid,\n\t\t\tts: new Date,\n\t\t\tmsg: TAPi18n.__('User_doesnt_exist', {\n\t\t\t\tpostProcess: 'sprintf',\n\t\t\t\tsprintf: [usernames.join(' @')]\n\t\t\t}, currentUser.language)\n\t\t});\n\t\treturn;\n\t}\n\tusernames = usernames.filter(function(username) {\n\t\tif (RocketChat.models.Rooms.findOneByIdContainingUsername(item.rid, username) == null) {\n\t\t\treturn true;\n\t\t}\n\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t_id: Random.id(),\n\t\t\trid: item.rid,\n\t\t\tts: new Date,\n\t\t\tmsg: TAPi18n.__('Username_is_already_in_here', {\n\t\t\t\tpostProcess: 'sprintf',\n\t\t\t\tsprintf: [username]\n\t\t\t}, currentUser.language)\n\t\t});\n\t\treturn false;\n\t});\n\tif (usernames.length === 0) {\n\t\treturn;\n\t}\n\tusers.forEach(function(user) {\n\n\t\ttry {\n\t\t\treturn Meteor.call('addUserToRoom', {\n\t\t\t\trid: item.rid,\n\t\t\t\tusername: user.username\n\t\t\t});\n\t\t} catch ({error}) {\n\t\t\tif (error === 'cant-invite-for-direct-room') {\n\t\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid: item.rid,\n\t\t\t\t\tts: new Date,\n\t\t\t\t\tmsg: TAPi18n.__('Cannot_invite_users_to_direct_rooms', null, currentUser.language)\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid: item.rid,\n\t\t\t\t\tts: new Date,\n\t\t\t\t\tmsg: TAPi18n.__(error, null, currentUser.language)\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t});\n}\n\nRocketChat.slashCommands.add('invite', Invite);\n\nexport {Invite};\n"]}