{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:2fa/client/accountSecurity.js","meteor://ðŸ’»app/packages/rocketchat:2fa/client/TOTPPassword.js"],"names":["toastr","module","watch","require","v","qrcode","window","Template","accountSecurity","helpers","showImage","instance","get","imageData","isEnabled","user","Meteor","services","totp","enabled","isRegistering","state","codesRemaining","t","number","events","event","call","error","result","set","url","size","defer","find","focus","swal","title","text","type","inputType","showCancelButton","closeOnConfirm","confirmButtonText","cancelButtonText","code","success","preventDefault","value","showBackupCodes","codes","onCreated","ReactiveVar","userCodes","backupCodes","map","index","join","html","autorun","remaining","reportError","callback","loginWithPasswordAndTOTP","selector","password","indexOf","username","email","Accounts","callLoginMethod","methodArguments","login","_hashPassword","userCallback","loginWithPassword","cb"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,eAAJ;AAAWC,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAAA,sBAASC,CAAT,EAAW;AAACJ,WAAOI,CAAP;AAAS;AAArB,CAA/B,EAAsD,CAAtD;AAAyD,IAAIC,eAAJ;AAAWJ,OAAOC,KAAP,CAAaC,QAAQ,UAAR,CAAb,EAAiC;AAAA,sBAASC,CAAT,EAAW;AAACC,WAAOD,CAAP;AAAS;AAArB,CAAjC,EAAwD,CAAxD;AAG/EE,OAAOD,MAAP,GAAgBA,MAAhB;AAEAE,SAASC,eAAT,CAAyBC,OAAzB,CAAiC;AAChCC,UADgC,cACpB;AACX,SAAOH,SAASI,QAAT,GAAoBD,SAApB,CAA8BE,GAA9B,EAAP;AACA,EAH+B;AAIhCC,UAJgC,cAIpB;AACX,SAAON,SAASI,QAAT,GAAoBE,SAApB,CAA8BD,GAA9B,EAAP;AACA,EAN+B;AAOhCE,UAPgC,cAOpB;AACX,MAAMC,OAAOC,OAAOD,IAAP,EAAb;AACA,SAAOA,QAAQA,KAAKE,QAAb,IAAyBF,KAAKE,QAAL,CAAcC,IAAvC,IAA+CH,KAAKE,QAAL,CAAcC,IAAd,CAAmBC,OAAzE;AACA,EAV+B;AAWhCC,cAXgC,cAWhB;AACf,SAAOb,SAASI,QAAT,GAAoBU,KAApB,CAA0BT,GAA1B,OAAoC,aAA3C;AACA,EAb+B;AAchCU,eAdgC,cAcf;AAChB,MAAIf,SAASI,QAAT,GAAoBW,cAApB,CAAmCV,GAAnC,EAAJ,EAA8C;AAC7C,UAAOW,EAAE,4BAAF,EAAgC;AAAEC,YAAQjB,SAASI,QAAT,GAAoBW,cAApB,CAAmCV,GAAnC;AAAV,IAAhC,CAAP;AACA;AACD;AAlB+B,CAAjC;AAqBAL,SAASC,eAAT,CAAyBiB,MAAzB,CAAgC;AAC/B,oBAD+B,YACXC,KADW,EACJf,QADI,EACM;AACpCK,SAAOW,IAAP,CAAY,YAAZ,EAA0B,UAACC,KAAD,EAAQC,MAAR,EAAmB;AAC5ClB,YAASE,SAAT,CAAmBiB,GAAnB,CAAuBzB,OAAOwB,OAAOE,GAAd,EAAmB;AAAEC,UAAM;AAAR,IAAnB,CAAvB;AAEArB,YAASU,KAAT,CAAeS,GAAf,CAAmB,aAAnB;AAEAd,UAAOiB,KAAP,CAAa,YAAM;AAClBtB,aAASuB,IAAT,CAAc,WAAd,EAA2BC,KAA3B;AACA,IAFD;AAGA,GARD;AASA,EAX8B;AAa/B,qBAb+B,cAaR;AACtBC,OAAK;AACJC,UAAOd,EAAE,2BAAF,CADH;AAEJe,SAAMf,EAAE,iDAAF,CAFF;AAGJgB,SAAM,OAHF;AAIJC,cAAW,MAJP;AAKJC,qBAAkB,IALd;AAMJC,mBAAgB,IANZ;AAOJC,sBAAmBpB,EAAE,QAAF,CAPf;AAQJqB,qBAAkBrB,EAAE,QAAF;AARd,GAAL,EASG,UAACsB,IAAD,EAAU;AACZ,OAAIA,SAAS,KAAb,EAAoB;AACnB;AACA;;AAED7B,UAAOW,IAAP,CAAY,aAAZ,EAA2BkB,IAA3B,EAAiC,UAACjB,KAAD,EAAQC,MAAR,EAAmB;AACnD,QAAID,KAAJ,EAAW;AACV,YAAO5B,OAAO4B,KAAP,CAAaL,EAAEK,MAAMA,KAAR,CAAb,CAAP;AACA;;AAED,QAAIC,MAAJ,EAAY;AACX7B,YAAO8C,OAAP,CAAevB,EAAE,oCAAF,CAAf;AACA,KAFD,MAEO;AACN,YAAOvB,OAAO4B,KAAP,CAAaL,EAAE,yBAAF,CAAb,CAAP;AACA;AACD,IAVD;AAWA,GAzBD;AA0BA,EAxC8B;AA0C/B,sBA1C+B,YA0CTG,KA1CS,EA0CFf,QA1CE,EA0CQ;AACtCe,QAAMqB,cAAN;AAEA/B,SAAOW,IAAP,CAAY,uBAAZ,EAAqChB,SAASuB,IAAT,CAAc,WAAd,EAA2Bc,KAAhE,EAAuE,UAACpB,KAAD,EAAQC,MAAR,EAAmB;AACzF,OAAIA,MAAJ,EAAY;AACXlB,aAASsC,eAAT,CAAyBpB,OAAOqB,KAAhC;AAEAvC,aAASuB,IAAT,CAAc,WAAd,EAA2Bc,KAA3B,GAAmC,EAAnC;AACArC,aAASU,KAAT,CAAeS,GAAf;AACA9B,WAAO8C,OAAP,CAAevB,EAAE,mCAAF,CAAf;AACA,IAND,MAMO;AACNvB,WAAO4B,KAAP,CAAaL,EAAE,yBAAF,CAAb;AACA;AACD,GAVD;AAWA,EAxD8B;AA0D/B,0BA1D+B,YA0DLG,KA1DK,EA0DEf,QA1DF,EA0DY;AAC1CyB,OAAK;AACJC,UAAOd,EAAE,2BAAF,CADH;AAEJe,SAAMf,EAAE,iDAAF,CAFF;AAGJgB,SAAM,OAHF;AAIJC,cAAW,MAJP;AAKJC,qBAAkB,IALd;AAMJC,mBAAgB,KANZ;AAOJC,sBAAmBpB,EAAE,QAAF,CAPf;AAQJqB,qBAAkBrB,EAAE,QAAF;AARd,GAAL,EASG,UAACsB,IAAD,EAAU;AACZ,OAAIA,SAAS,KAAb,EAAoB;AACnB;AACA;;AAED7B,UAAOW,IAAP,CAAY,qBAAZ,EAAmCkB,IAAnC,EAAyC,UAACjB,KAAD,EAAQC,MAAR,EAAmB;AAC3D,QAAID,KAAJ,EAAW;AACV,YAAO5B,OAAO4B,KAAP,CAAaL,EAAEK,MAAMA,KAAR,CAAb,CAAP;AACA;;AAED,QAAIC,MAAJ,EAAY;AACXlB,cAASsC,eAAT,CAAyBpB,OAAOqB,KAAhC;AACA,KAFD,MAEO;AACN,YAAOlD,OAAO4B,KAAP,CAAaL,EAAE,yBAAF,CAAb,CAAP;AACA;AACD,IAVD;AAWA,GAzBD;AA0BA;AArF8B,CAAhC;AAwFAhB,SAASC,eAAT,CAAyB2C,SAAzB,CAAmC,YAAW;AAAA;;AAC7C,MAAKzC,SAAL,GAAiB,IAAI0C,WAAJ,CAAgB,KAAhB,CAAjB;AACA,MAAKvC,SAAL,GAAiB,IAAIuC,WAAJ,EAAjB;AAEA,MAAK/B,KAAL,GAAa,IAAI+B,WAAJ,EAAb;AAEA,MAAK9B,cAAL,GAAsB,IAAI8B,WAAJ,EAAtB;;AAEA,MAAKH,eAAL,GAAuB,UAACI,SAAD,EAAe;AACrC,MAAMC,cAAcD,UAAUE,GAAV,CAAc,UAACP,KAAD,EAAQQ,KAAR,EAAkB;AACnD,UAAO,CAACA,QAAQ,CAAT,IAAc,CAAd,KAAoB,CAApB,IAAyBA,QAAQ,EAAjC,GAA0CR,KAA1C,UAA2DA,KAA3D,MAAP;AACA,GAFmB,EAEjBS,IAFiB,CAEZ,EAFY,CAApB;AAGA,MAAMP,8DAA2DI,WAA3D,YAAN;AACAlB,OAAK;AACJC,UAAOd,EAAE,cAAF,CADH;AAEJe,cAAUf,EAAE,yCAAF,EAA6C;AAAE2B;AAAF,IAA7C,CAFN;AAGJQ,SAAM;AAHF,GAAL;AAKA,EAVD;;AAYA,MAAKC,OAAL,CAAa,YAAM;AAClB,MAAM5C,OAAOC,OAAOD,IAAP,EAAb;;AACA,MAAIA,QAAQA,KAAKE,QAAb,IAAyBF,KAAKE,QAAL,CAAcC,IAAvC,IAA+CH,KAAKE,QAAL,CAAcC,IAAd,CAAmBC,OAAtE,EAA+E;AAC9EH,UAAOW,IAAP,CAAY,yBAAZ,EAAuC,UAACC,KAAD,EAAQC,MAAR,EAAmB;AACzD,QAAIA,MAAJ,EAAY;AACX,WAAKP,cAAL,CAAoBQ,GAApB,CAAwBD,OAAO+B,SAA/B;AACA;AACD,IAJD;AAKA;AACD,EATD;AAUA,CA9BD,sH;;;;;;;;;;;AClHA,IAAI5D,eAAJ;AAAWC,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAAA,sBAASC,CAAT,EAAW;AAACJ,WAAOI,CAAP;AAAS;AAArB,CAA/B,EAAsD,CAAtD;;AAEX,SAASyD,WAAT,CAAqBjC,KAArB,EAA4BkC,QAA5B,EAAsC;AACrC,KAAIA,QAAJ,EAAc;AACbA,WAASlC,KAAT;AACA,EAFD,MAEO;AACN,QAAMA,KAAN;AACA;AACD;;AAEDZ,OAAO+C,wBAAP,GAAkC,UAASC,QAAT,EAAmBC,QAAnB,EAA6BpB,IAA7B,EAAmCiB,QAAnC,EAA6C;AAC9E,KAAI,OAAOE,QAAP,KAAoB,QAAxB,EAAkC;AACjC,MAAIA,SAASE,OAAT,CAAiB,GAAjB,MAA0B,CAAC,CAA/B,EAAkC;AACjCF,cAAW;AAACG,cAAUH;AAAX,IAAX;AACA,GAFD,MAEO;AACNA,cAAW;AAACI,WAAOJ;AAAR,IAAX;AACA;AACD;;AAEDK,UAASC,eAAT,CAAyB;AACxBC,mBAAiB,CAAC;AACjBrD,SAAM;AACLsD,WAAO;AACNzD,WAAMiD,QADA;AAENC,eAAUI,SAASI,aAAT,CAAuBR,QAAvB;AAFJ,KADF;AAKLpB;AALK;AADW,GAAD,CADO;AAUxB6B,cAVwB,YAUX9C,KAVW,EAUJ;AACnB,OAAIA,KAAJ,EAAW;AACViC,gBAAYjC,KAAZ,EAAmBkC,QAAnB;AACA,IAFD,MAEO;AACNA,gBAAYA,UAAZ;AACA;AACD;AAhBuB,EAAzB;AAkBA,CA3BD;;AA6BA,IAAMa,oBAAoB3D,OAAO2D,iBAAjC;;AAEA3D,OAAO2D,iBAAP,GAA2B,UAASP,KAAT,EAAgBH,QAAhB,EAA0BW,EAA1B,EAA8B;AACxDD,mBAAkBP,KAAlB,EAAyBH,QAAzB,EAAmC,UAACrC,KAAD,EAAW;AAC7C,MAAI,CAACA,KAAD,IAAUA,MAAMA,KAAN,KAAgB,eAA9B,EAA+C;AAC9C,UAAOgD,GAAGhD,KAAH,CAAP;AACA;;AAEDQ,OAAK;AACJC,UAAOd,EAAE,2BAAF,CADH;AAEJe,SAAMf,EAAE,iDAAF,CAFF;AAGJgB,SAAM,OAHF;AAIJC,cAAW,MAJP;AAKJC,qBAAkB,IALd;AAMJC,mBAAgB,IANZ;AAOJC,sBAAmBpB,EAAE,QAAF,CAPf;AAQJqB,qBAAkBrB,EAAE,QAAF;AARd,GAAL,EASG,UAACsB,IAAD,EAAU;AACZ,OAAIA,SAAS,KAAb,EAAoB;AACnB,WAAO+B,IAAP;AACA;;AAED5D,UAAO+C,wBAAP,CAAgCK,KAAhC,EAAuCH,QAAvC,EAAiDpB,IAAjD,EAAuD,UAACjB,KAAD,EAAW;AACjE,QAAIA,SAASA,MAAMA,KAAN,KAAgB,cAA7B,EAA6C;AAC5C5B,YAAO4B,KAAP,CAAaL,EAAE,yBAAF,CAAb;AACAqD;AACA,KAHD,MAGO;AACNA,QAAGhD,KAAH;AACA;AACD,IAPD;AAQA,GAtBD;AAuBA,EA5BD;AA6BA,CA9BD,qH","file":"/packages/rocketchat_2fa.js","sourcesContent":["import toastr from 'toastr';\nimport qrcode from 'yaqrcode';\n\nwindow.qrcode = qrcode;\n\nTemplate.accountSecurity.helpers({\n\tshowImage() {\n\t\treturn Template.instance().showImage.get();\n\t},\n\timageData() {\n\t\treturn Template.instance().imageData.get();\n\t},\n\tisEnabled() {\n\t\tconst user = Meteor.user();\n\t\treturn user && user.services && user.services.totp && user.services.totp.enabled;\n\t},\n\tisRegistering() {\n\t\treturn Template.instance().state.get() === 'registering';\n\t},\n\tcodesRemaining() {\n\t\tif (Template.instance().codesRemaining.get()) {\n\t\t\treturn t('You_have_n_codes_remaining', { number: Template.instance().codesRemaining.get() });\n\t\t}\n\t}\n});\n\nTemplate.accountSecurity.events({\n\t'click .enable-2fa'(event, instance) {\n\t\tMeteor.call('2fa:enable', (error, result) => {\n\t\t\tinstance.imageData.set(qrcode(result.url, { size: 200 }));\n\n\t\t\tinstance.state.set('registering');\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tinstance.find('#testCode').focus();\n\t\t\t});\n\t\t});\n\t},\n\n\t'click .disable-2fa'() {\n\t\tswal({\n\t\t\ttitle: t('Two-factor_authentication'),\n\t\t\ttext: t('Open_your_authentication_app_and_enter_the_code'),\n\t\t\ttype: 'input',\n\t\t\tinputType: 'text',\n\t\t\tshowCancelButton: true,\n\t\t\tcloseOnConfirm: true,\n\t\t\tconfirmButtonText: t('Verify'),\n\t\t\tcancelButtonText: t('Cancel')\n\t\t}, (code) => {\n\t\t\tif (code === false) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tMeteor.call('2fa:disable', code, (error, result) => {\n\t\t\t\tif (error) {\n\t\t\t\t\treturn toastr.error(t(error.error));\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\ttoastr.success(t('Two-factor_authentication_disabled'));\n\t\t\t\t} else {\n\t\t\t\t\treturn toastr.error(t('Invalid_two_factor_code'));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\t'submit .verify-code'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tMeteor.call('2fa:validateTempToken', instance.find('#testCode').value, (error, result) => {\n\t\t\tif (result) {\n\t\t\t\tinstance.showBackupCodes(result.codes);\n\n\t\t\t\tinstance.find('#testCode').value = '';\n\t\t\t\tinstance.state.set();\n\t\t\t\ttoastr.success(t('Two-factor_authentication_enabled'));\n\t\t\t} else {\n\t\t\t\ttoastr.error(t('Invalid_two_factor_code'));\n\t\t\t}\n\t\t});\n\t},\n\n\t'click .regenerate-codes'(event, instance) {\n\t\tswal({\n\t\t\ttitle: t('Two-factor_authentication'),\n\t\t\ttext: t('Open_your_authentication_app_and_enter_the_code'),\n\t\t\ttype: 'input',\n\t\t\tinputType: 'text',\n\t\t\tshowCancelButton: true,\n\t\t\tcloseOnConfirm: false,\n\t\t\tconfirmButtonText: t('Verify'),\n\t\t\tcancelButtonText: t('Cancel')\n\t\t}, (code) => {\n\t\t\tif (code === false) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tMeteor.call('2fa:regenerateCodes', code, (error, result) => {\n\t\t\t\tif (error) {\n\t\t\t\t\treturn toastr.error(t(error.error));\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\tinstance.showBackupCodes(result.codes);\n\t\t\t\t} else {\n\t\t\t\t\treturn toastr.error(t('Invalid_two_factor_code'));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nTemplate.accountSecurity.onCreated(function() {\n\tthis.showImage = new ReactiveVar(false);\n\tthis.imageData = new ReactiveVar();\n\n\tthis.state = new ReactiveVar();\n\n\tthis.codesRemaining = new ReactiveVar();\n\n\tthis.showBackupCodes = (userCodes) => {\n\t\tconst backupCodes = userCodes.map((value, index) => {\n\t\t\treturn (index + 1) % 4 === 0 && index < 11 ? `${ value }\\n` : `${ value } `;\n\t\t}).join('');\n\t\tconst codes = `<code class=\"text-center allow-text-selection\">${ backupCodes }</code>`;\n\t\tswal({\n\t\t\ttitle: t('Backup_codes'),\n\t\t\ttext: `${ t('Make_sure_you_have_a_copy_of_your_codes', { codes }) }`,\n\t\t\thtml: true\n\t\t});\n\t};\n\n\tthis.autorun(() => {\n\t\tconst user = Meteor.user();\n\t\tif (user && user.services && user.services.totp && user.services.totp.enabled) {\n\t\t\tMeteor.call('2fa:checkCodesRemaining', (error, result) => {\n\t\t\t\tif (result) {\n\t\t\t\t\tthis.codesRemaining.set(result.remaining);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n});\n","import toastr from 'toastr';\n\nfunction reportError(error, callback) {\n\tif (callback) {\n\t\tcallback(error);\n\t} else {\n\t\tthrow error;\n\t}\n}\n\nMeteor.loginWithPasswordAndTOTP = function(selector, password, code, callback) {\n\tif (typeof selector === 'string') {\n\t\tif (selector.indexOf('@') === -1) {\n\t\t\tselector = {username: selector};\n\t\t} else {\n\t\t\tselector = {email: selector};\n\t\t}\n\t}\n\n\tAccounts.callLoginMethod({\n\t\tmethodArguments: [{\n\t\t\ttotp: {\n\t\t\t\tlogin: {\n\t\t\t\t\tuser: selector,\n\t\t\t\t\tpassword: Accounts._hashPassword(password)\n\t\t\t\t},\n\t\t\t\tcode\n\t\t\t}\n\t\t}],\n\t\tuserCallback(error) {\n\t\t\tif (error) {\n\t\t\t\treportError(error, callback);\n\t\t\t} else {\n\t\t\t\tcallback && callback();\n\t\t\t}\n\t\t}\n\t});\n};\n\nconst loginWithPassword = Meteor.loginWithPassword;\n\nMeteor.loginWithPassword = function(email, password, cb) {\n\tloginWithPassword(email, password, (error) => {\n\t\tif (!error || error.error !== 'totp-required') {\n\t\t\treturn cb(error);\n\t\t}\n\n\t\tswal({\n\t\t\ttitle: t('Two-factor_authentication'),\n\t\t\ttext: t('Open_your_authentication_app_and_enter_the_code'),\n\t\t\ttype: 'input',\n\t\t\tinputType: 'text',\n\t\t\tshowCancelButton: true,\n\t\t\tcloseOnConfirm: true,\n\t\t\tconfirmButtonText: t('Verify'),\n\t\t\tcancelButtonText: t('Cancel')\n\t\t}, (code) => {\n\t\t\tif (code === false) {\n\t\t\t\treturn cb();\n\t\t\t}\n\n\t\t\tMeteor.loginWithPasswordAndTOTP(email, password, code, (error) => {\n\t\t\t\tif (error && error.error === 'totp-invalid') {\n\t\t\t\t\ttoastr.error(t('Invalid_two_factor_code'));\n\t\t\t\t\tcb();\n\t\t\t\t} else {\n\t\t\t\t\tcb(error);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t});\n};\n"]}