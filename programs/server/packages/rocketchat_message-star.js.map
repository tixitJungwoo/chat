{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:message-star/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:message-star/server/starMessage.js","meteor://ðŸ’»app/packages/rocketchat:message-star/server/publications/starredMessages.js","meteor://ðŸ’»app/packages/rocketchat:message-star/server/startup/indexes.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","methods","starMessage","message","userId","Error","method","get","action","room","models","Rooms","findOneById","rid","Array","isArray","usernames","indexOf","user","username","Messages","updateUserStarById","_id","starred","publish","limit","ready","publication","Users","cursorHandle","findStarredByUserAtRoom","sort","ts","observeChanges","added","record","changed","removed","onStop","stop","defer","tryEnsureIndex","sparse"],"mappings":"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","file":"/packages/rocketchat_message-star.js","sourcesContent":["Meteor.startup(function() {\n\treturn RocketChat.settings.add('Message_AllowStarring', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Message',\n\t\t'public': true\n\t});\n});\n","Meteor.methods({\n\tstarMessage(message) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'starMessage'\n\t\t\t});\n\t\t}\n\t\tif (!RocketChat.settings.get('Message_AllowStarring')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Message starring not allowed', {\n\t\t\t\tmethod: 'pinMessage',\n\t\t\t\taction: 'Message_starring'\n\t\t\t});\n\t\t}\n\t\tconst room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tif (Array.isArray(room.usernames) && room.usernames.indexOf(Meteor.user().username) === -1) {\n\t\t\treturn false;\n\t\t}\n\t\treturn RocketChat.models.Messages.updateUserStarById(message._id, Meteor.userId(), message.starred);\n\t}\n});\n\n","Meteor.publish('starredMessages', function(rid, limit = 50) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\tconst publication = this;\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\tif (!user) {\n\t\treturn this.ready();\n\t}\n\tconst cursorHandle = RocketChat.models.Messages.findStarredByUserAtRoom(this.userId, rid, {\n\t\tsort: {\n\t\t\tts: -1\n\t\t},\n\t\tlimit\n\t}).observeChanges({\n\t\tadded(_id, record) {\n\t\t\treturn publication.added('rocketchat_starred_message', _id, record);\n\t\t},\n\t\tchanged(_id, record) {\n\t\t\treturn publication.changed('rocketchat_starred_message', _id, record);\n\t\t},\n\t\tremoved(_id) {\n\t\t\treturn publication.removed('rocketchat_starred_message', _id);\n\t\t}\n\t});\n\tthis.ready();\n\treturn this.onStop(function() {\n\t\treturn cursorHandle.stop();\n\t});\n});\n","Meteor.startup(function() {\n\treturn Meteor.defer(function() {\n\t\treturn RocketChat.models.Messages.tryEnsureIndex({\n\t\t\t'starred._id': 1\n\t\t}, {\n\t\t\tsparse: 1\n\t\t});\n\t});\n});\n"]}