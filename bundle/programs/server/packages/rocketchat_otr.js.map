{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:otr/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/methods/deleteOldOTRMessages.js","meteor://ðŸ’»app/packages/rocketchat:otr/server/methods/updateOTRAck.js"],"names":["RocketChat","settings","addGroup","add","type","i18nLabel","models","Messages","deleteOldOTRMessages","roomId","ts","query","rid","t","$lte","remove","updateOTRAck","_id","otrAck","update","$set","Meteor","methods","userId","Error","method","now","Date","subscription","Subscriptions","findOneByRoomIdAndUserId","ack"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,WAAWC,QAAX,CAAoBC,QAApB,CAA6B,KAA7B,EAAoC,YAAW;AAC9C,MAAKC,GAAL,CAAS,YAAT,EAAuB,IAAvB,EAA6B;AAC5BC,QAAM,SADsB;AAE5BC,aAAW,SAFiB;AAG5B,YAAQ;AAHoB,EAA7B;AAKA,CAND,2G;;;;;;;;;;;ACAAL,WAAWM,MAAX,CAAkBC,QAAlB,CAA2BC,oBAA3B,GAAkD,UAASC,MAAT,EAAiBC,EAAjB,EAAqB;AACtE,KAAMC,QAAQ;AAAEC,OAAKH,MAAP;AAAeI,KAAG,KAAlB;AAAyBH,MAAI;AAAEI,SAAMJ;AAAR;AAA7B,EAAd;AACA,QAAO,KAAKK,MAAL,CAAYJ,KAAZ,CAAP;AACA,CAHD;;AAKAX,WAAWM,MAAX,CAAkBC,QAAlB,CAA2BS,YAA3B,GAA0C,UAASC,GAAT,EAAcC,MAAd,EAAsB;AAC/D,KAAMP,QAAQ;AAAEM;AAAF,EAAd;AACA,KAAME,SAAS;AAAEC,QAAM;AAAEF;AAAF;AAAR,EAAf;AACA,QAAO,KAAKC,MAAL,CAAYR,KAAZ,EAAmBQ,MAAnB,CAAP;AACA,CAJD,4G;;;;;;;;;;;ACLAE,OAAOC,OAAP,CAAe;AACdd,qBADc,YACOC,MADP,EACe;AAC5B,MAAI,CAACY,OAAOE,MAAP,EAAL,EAAsB;AACrB,SAAM,IAAIF,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,YAAQ;AAAV,IAAvD,CAAN;AACA;;AAED,MAAMC,MAAM,IAAIC,IAAJ,EAAZ;AACA,MAAMC,eAAe5B,WAAWM,MAAX,CAAkBuB,aAAlB,CAAgCC,wBAAhC,CAAyDrB,MAAzD,EAAiEY,OAAOE,MAAP,EAAjE,CAArB;;AACA,MAAIK,gBAAgBA,aAAaf,CAAb,KAAmB,GAAvC,EAA4C;AAC3Cb,cAAWM,MAAX,CAAkBC,QAAlB,CAA2BC,oBAA3B,CAAgDC,MAAhD,EAAwDiB,GAAxD;AACA,GAFD,MAEO;AACN,SAAM,IAAIL,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,YAAQ;AAAV,IAAvD,CAAN;AACA;AACD;AAba,CAAf,2G;;;;;;;;;;;ACAAJ,OAAOC,OAAP,CAAe;AACdN,aADc,YACDC,GADC,EACIc,GADJ,EACS;AACtB,MAAI,CAACV,OAAOE,MAAP,EAAL,EAAsB;AACrB,SAAM,IAAIF,OAAOG,KAAX,CAAiB,oBAAjB,EAAuC,cAAvC,EAAuD;AAAEC,YAAQ;AAAV,IAAvD,CAAN;AACA;;AACDzB,aAAWM,MAAX,CAAkBC,QAAlB,CAA2BS,YAA3B,CAAwCC,GAAxC,EAA6Cc,GAA7C;AACA;AANa,CAAf,2G","file":"/packages/rocketchat_otr.js","sourcesContent":["RocketChat.settings.addGroup('OTR', function() {\n\tthis.add('OTR_Enable', true, {\n\t\ttype: 'boolean',\n\t\ti18nLabel: 'Enabled',\n\t\tpublic: true\n\t});\n});\n","RocketChat.models.Messages.deleteOldOTRMessages = function(roomId, ts) {\n\tconst query = { rid: roomId, t: 'otr', ts: { $lte: ts } };\n\treturn this.remove(query);\n};\n\nRocketChat.models.Messages.updateOTRAck = function(_id, otrAck) {\n\tconst query = { _id };\n\tconst update = { $set: { otrAck } };\n\treturn this.update(query, update);\n};\n","Meteor.methods({\n\tdeleteOldOTRMessages(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'deleteOldOTRMessages' });\n\t\t}\n\n\t\tconst now = new Date();\n\t\tconst subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, Meteor.userId());\n\t\tif (subscription && subscription.t === 'd') {\n\t\t\tRocketChat.models.Messages.deleteOldOTRMessages(roomId, now);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'deleteOldOTRMessages' });\n\t\t}\n\t}\n});\n","Meteor.methods({\n\tupdateOTRAck(_id, ack) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'updateOTRAck' });\n\t\t}\n\t\tRocketChat.models.Messages.updateOTRAck(_id, ack);\n\t}\n});\n"]}