{"version":3,"sources":["meteor://ðŸ’»app/packages/steffo:meteor-accounts-saml/saml_client.js"],"names":["Accounts","saml","MeteorLogout","Meteor","logout","samlService","ServiceConfiguration","configurations","findOne","service","provider","clientConfig","idpSLORedirectURL","logoutWithSaml","apply","arguments","openCenteredPopup","url","width","height","newwindow","cordova","InAppBrowser","open","closed","intervalId","setInterval","executeScript","data","length","close","addEventListener","clearInterval","screenX","window","screenLeft","screenY","screenTop","outerWidth","document","body","clientWidth","outerHeight","clientHeight","left","top","features","focus","initiateLogin","options","callback","dimensions","popup","absoluteUrl","credentialToken","checkPopupOpen","popupClosed","undefined","e","loginWithSaml","Random","id","callLoginMethod","methodArguments","userCallback","call","err","result","location","replace","encodeURIComponent"],"mappings":"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","file":"/packages/steffo_meteor-accounts-saml.js","sourcesContent":["/* globals cordova */\n\nif (!Accounts.saml) {\n\tAccounts.saml = {};\n}\n\n// Override the standard logout behaviour.\n//\n// If we find a samlProvider, and we are using single\n// logout we will initiate logout from rocketchat via saml.\n// If not using single logout, we just do the standard logout.\n//\n// TODO: This may need some work as it is not clear if we are really\n// logging out of the idp when doing the standard logout.\n\nconst MeteorLogout = Meteor.logout;\n\nMeteor.logout = function() {\n\tconst samlService = ServiceConfiguration.configurations.findOne({service: 'saml'});\n\tif (samlService) {\n\t\tconst provider = samlService.clientConfig && samlService.clientConfig.provider;\n\t\tif (provider) {\n\t\t\tif (samlService.idpSLORedirectURL) {\n\t\t\t\treturn Meteor.logoutWithSaml({ provider });\n\t\t\t}\n\t\t}\n\t}\n\treturn MeteorLogout.apply(Meteor, arguments);\n};\n\nconst openCenteredPopup = function(url, width, height) {\n\tlet newwindow;\n\n\tif (typeof cordova !== 'undefined' && typeof cordova.InAppBrowser !== 'undefined') {\n\t\tnewwindow = cordova.InAppBrowser.open(url, '_blank');\n\t\tnewwindow.closed = false;\n\n\t\tconst intervalId = setInterval(function() {\n\t\t\tnewwindow.executeScript({\n\t\t\t\t'code': 'document.getElementsByTagName(\"script\")[0].textContent'\n\t\t\t}, function(data) {\n\t\t\t\tif (data && data.length > 0 && data[0] === 'window.close()') {\n\t\t\t\t\tnewwindow.close();\n\t\t\t\t\tnewwindow.closed = true;\n\t\t\t\t}\n\t\t\t});\n\t\t}, 100);\n\n\t\tnewwindow.addEventListener('exit', function() {\n\t\t\tclearInterval(intervalId);\n\t\t});\n\t} else {\n\t\tconst screenX = typeof window.screenX !== 'undefined' ? window.screenX : window.screenLeft;\n\t\tconst screenY = typeof window.screenY !== 'undefined' ? window.screenY : window.screenTop;\n\t\tconst outerWidth = typeof window.outerWidth !== 'undefined' ? window.outerWidth : document.body.clientWidth;\n\t\tconst outerHeight = typeof window.outerHeight !== 'undefined' ? window.outerHeight : (document.body.clientHeight - 22);\n\t\t// XXX what is the 22?\n\n\t\t// Use `outerWidth - width` and `outerHeight - height` for help in\n\t\t// positioning the popup centered relative to the current window\n\t\tconst left = screenX + (outerWidth - width) / 2;\n\t\tconst top = screenY + (outerHeight - height) / 2;\n\t\tconst features = (`width=${ width },height=${ height\n\t\t\t},left=${ left },top=${ top },scrollbars=yes`);\n\n\t\tnewwindow = window.open(url, 'Login', features);\n\t\tif (newwindow.focus) {\n\t\t\tnewwindow.focus();\n\t\t}\n\t}\n\treturn newwindow;\n};\n\nAccounts.saml.initiateLogin = function(options, callback, dimensions) {\n\t// default dimensions that worked well for facebook and google\n\tconst popup = openCenteredPopup(\n\t\tMeteor.absoluteUrl(`_saml/authorize/${ options.provider }/${ options.credentialToken }`), (dimensions && dimensions.width) || 650, (dimensions && dimensions.height) || 500);\n\n\tconst checkPopupOpen = setInterval(function() {\n\t\tlet popupClosed;\n\t\ttry {\n\t\t\t// Fix for #328 - added a second test criteria (popup.closed === undefined)\n\t\t\t// to humour this Android quirk:\n\t\t\t// http://code.google.com/p/android/issues/detail?id=21061\n\t\t\tpopupClosed = popup.closed || popup.closed === undefined;\n\t\t} catch (e) {\n\t\t\t// For some unknown reason, IE9 (and others?) sometimes (when\n\t\t\t// the popup closes too quickly?) throws 'SCRIPT16386: No such\n\t\t\t// interface supported' when trying to read 'popup.closed'. Try\n\t\t\t// again in 100ms.\n\t\t\treturn;\n\t\t}\n\n\t\tif (popupClosed) {\n\t\t\tclearInterval(checkPopupOpen);\n\t\t\tcallback(options.credentialToken);\n\t\t}\n\t}, 100);\n};\n\n\nMeteor.loginWithSaml = function(options, callback) {\n\toptions = options || {};\n\tconst credentialToken = Random.id();\n\toptions.credentialToken = credentialToken;\n\n\tAccounts.saml.initiateLogin(options, function(/*error, result*/) {\n\t\tAccounts.callLoginMethod({\n\t\t\tmethodArguments: [{\n\t\t\t\tsaml: true,\n\t\t\t\tcredentialToken\n\t\t\t}],\n\t\t\tuserCallback: callback\n\t\t});\n\t});\n};\n\nMeteor.logoutWithSaml = function(options/*, callback*/) {\n\t//Accounts.saml.idpInitiatedSLO(options, callback);\n\tMeteor.call('samlLogout', options.provider, function(err, result) {\n\t\tif (err || !result) {\n\t\t\tMeteorLogout.apply(Meteor);\n\t\t\treturn;\n\t\t}\n\t\t// A nasty bounce: 'result' has the SAML LogoutRequest but we need a proper 302 to redirected from the server.\n\t\t//window.location.replace(Meteor.absoluteUrl('_saml/sloRedirect/' + options.provider + '/?redirect='+result));\n\t\twindow.location.replace(Meteor.absoluteUrl(`_saml/sloRedirect/${ options.provider }/?redirect=${ encodeURIComponent(result) }`));\n\t});\n};\n"]}