{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file/file.server.js"],"names":["Grid","module","watch","require","v","stream","fs","path","mkdirp","gm","exec","prototype","tryParseObjectId","RocketChatFile","enabled","undefined","enable","RocketChat","settings","updateOptionsById","alert","disable","detectGM","Meteor","bindEnvironment","error","stdout","indexOf","Info","GraphicsMagick","version","subClass","imageMagick","ImageMagick","methods","bufferToStream","buffer","bufferStream","PassThrough","end","dataURIParse","dataURI","imageData","split","image","contentType","replace","addPassThrough","st","fn","pass","GridFS","config","name","transformWrite","mongo","Package","MongoInternals","NpmModule","db","defaultRemoteCollectionDriver","store","findOneSync","wrapAsync","collection","findOne","bind","removeSync","remove","getFileSync","getFile","fileName","_id","root","createWriteStream","self","ws","filename","mode","content_type","rs","file","on","emit","createReadStream","getFileWithReadStream","readStream","length","uploadDate","cb","data","chunk","push","Buffer","concat","deleteFile","FileSystem","absolutePath","sep","homepath","process","env","HOME","HOMEPATH","USERPROFILE","Error","resolve","sync","statSync","stat","unlinkSync","unlink","join","size","error1"],"mappings":"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","file":"/packages/rocketchat_file.js","sourcesContent":["import Grid from 'gridfs-stream';\nimport stream from 'stream';\nimport fs from 'fs';\nimport path from 'path';\nimport mkdirp from 'mkdirp';\nimport gm from 'gm';\nimport {exec} from 'child_process';\n\n// Fix problem with usernames being converted to object id\nGrid.prototype.tryParseObjectId = function() {\n\treturn false;\n};\n//TODO: REMOVE RocketChatFile from globals\nRocketChatFile = {\n\tgm,\n\tenabled: undefined,\n\tenable() {\n\t\tRocketChatFile.enabled = true;\n\t\treturn RocketChat.settings.updateOptionsById('Accounts_AvatarResize', {\n\t\t\talert: undefined\n\t\t});\n\t},\n\tdisable() {\n\t\tRocketChatFile.enabled = false;\n\t\treturn RocketChat.settings.updateOptionsById('Accounts_AvatarResize', {\n\t\t\talert: 'The_image_resize_will_not_work_because_we_can_not_detect_ImageMagick_or_GraphicsMagick_installed_in_your_server'\n\t\t});\n\t}\n};\n\nconst detectGM = function() {\n\treturn exec('gm version', Meteor.bindEnvironment(function(error, stdout) {\n\t\tif ((error == null) && stdout.indexOf('GraphicsMagick') > -1) {\n\t\t\tRocketChatFile.enable();\n\t\t\tRocketChat.Info.GraphicsMagick = {\n\t\t\t\tenabled: true,\n\t\t\t\tversion: stdout\n\t\t\t};\n\t\t} else {\n\t\t\tRocketChat.Info.GraphicsMagick = {\n\t\t\t\tenabled: false\n\t\t\t};\n\t\t}\n\t\treturn exec('convert -version', Meteor.bindEnvironment(function(error, stdout) {\n\t\t\tif ((error == null) && stdout.indexOf('ImageMagick') > -1) {\n\t\t\t\tif (RocketChatFile.enabled !== true) {\n\t\t\t\t\t// Enable GM to work with ImageMagick if no GraphicsMagick\n\t\t\t\t\tRocketChatFile.gm = RocketChatFile.gm.subClass({\n\t\t\t\t\t\timageMagick: true\n\t\t\t\t\t});\n\t\t\t\t\tRocketChatFile.enable();\n\t\t\t\t}\n\t\t\t\treturn RocketChat.Info.ImageMagick = {\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tversion: stdout\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tif (RocketChatFile.enabled !== true) {\n\t\t\t\t\tRocketChatFile.disable();\n\t\t\t\t}\n\t\t\t\treturn RocketChat.Info.ImageMagick = {\n\t\t\t\t\tenabled: false\n\t\t\t\t};\n\t\t\t}\n\t\t}));\n\t}));\n};\n\ndetectGM();\n\nMeteor.methods({\n\t'detectGM'() {\n\t\tdetectGM();\n\t}\n});\n\nRocketChatFile.bufferToStream = function(buffer) {\n\tconst bufferStream = new stream.PassThrough();\n\tbufferStream.end(buffer);\n\treturn bufferStream;\n};\n\nRocketChatFile.dataURIParse = function(dataURI) {\n\tconst imageData = dataURI.split(';base64,');\n\treturn {\n\t\timage: imageData[1],\n\t\tcontentType: imageData[0].replace('data:', '')\n\t};\n};\n\nRocketChatFile.addPassThrough = function(st, fn) {\n\tconst pass = new stream.PassThrough();\n\tfn(pass, st);\n\treturn pass;\n};\n\nRocketChatFile.GridFS = class {\n\tconstructor(config = {}) {\n\t\tconst {name = 'file', transformWrite} = config;\n\n\t\tthis.name = name;\n\t\tthis.transformWrite = transformWrite;\n\t\tconst mongo = Package.mongo.MongoInternals.NpmModule;\n\t\tconst db = Package.mongo.MongoInternals.defaultRemoteCollectionDriver().mongo.db;\n\t\tthis.store = new Grid(db, mongo);\n\t\tthis.findOneSync = Meteor.wrapAsync(this.store.collection(this.name).findOne.bind(this.store.collection(this.name)));\n\t\tthis.removeSync = Meteor.wrapAsync(this.store.remove.bind(this.store));\n\t\tthis.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n\t}\n\n\tfindOne(fileName) {\n\t\treturn this.findOneSync({\n\t\t\t_id: fileName\n\t\t});\n\t}\n\n\tremove(fileName) {\n\t\treturn this.removeSync({\n\t\t\t_id: fileName,\n\t\t\troot: this.name\n\t\t});\n\t}\n\n\tcreateWriteStream(fileName, contentType) {\n\t\tconst self = this;\n\t\tlet ws = this.store.createWriteStream({\n\t\t\t_id: fileName,\n\t\t\tfilename: fileName,\n\t\t\tmode: 'w',\n\t\t\troot: this.name,\n\t\t\tcontent_type: contentType\n\t\t});\n\t\tif (self.transformWrite != null) {\n\t\t\tws = RocketChatFile.addPassThrough(ws, function(rs, ws) {\n\t\t\t\tconst file = {\n\t\t\t\t\tname: self.name,\n\t\t\t\t\tfileName,\n\t\t\t\t\tcontentType\n\t\t\t\t};\n\t\t\t\treturn self.transformWrite(file, rs, ws);\n\t\t\t});\n\t\t}\n\t\tws.on('close', function() {\n\t\t\treturn ws.emit('end');\n\t\t});\n\t\treturn ws;\n\t}\n\n\tcreateReadStream(fileName) {\n\t\treturn this.store.createReadStream({\n\t\t\t_id: fileName,\n\t\t\troot: this.name\n\t\t});\n\t}\n\n\tgetFileWithReadStream(fileName) {\n\t\tconst file = this.findOne(fileName);\n\t\tif (file == null) {\n\t\t\treturn null;\n\t\t}\n\t\tconst rs = this.createReadStream(fileName);\n\t\treturn {\n\t\t\treadStream: rs,\n\t\t\tcontentType: file.contentType,\n\t\t\tlength: file.length,\n\t\t\tuploadDate: file.uploadDate\n\t\t};\n\t}\n\n\tgetFile(fileName, cb) {\n\t\tconst file = this.getFileWithReadStream(fileName);\n\t\tif (!file) {\n\t\t\treturn cb();\n\t\t}\n\t\tconst data = [];\n\t\tfile.readStream.on('data', Meteor.bindEnvironment(function(chunk) {\n\t\t\treturn data.push(chunk);\n\t\t}));\n\t\treturn file.readStream.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn cb(null, {\n\t\t\t\tbuffer: Buffer.concat(data),\n\t\t\t\tcontentType: file.contentType,\n\t\t\t\tlength: file.length,\n\t\t\t\tuploadDate: file.uploadDate\n\t\t\t});\n\t\t}));\n\t}\n\n\tdeleteFile(fileName) {\n\t\tconst file = this.findOne(fileName);\n\t\tif (file == null) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.remove(fileName);\n\t}\n\n\n};\n\nRocketChatFile.FileSystem = class {\n\tconstructor(config = {}) {\n\t\tlet {absolutePath = '~/uploads'} = config;\n\t\tconst {transformWrite} = config;\n\n\t\tthis.transformWrite = transformWrite;\n\t\tif (absolutePath.split(path.sep)[0] === '~') {\n\t\t\tconst homepath = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;\n\t\t\tif (homepath != null) {\n\t\t\t\tabsolutePath = absolutePath.replace('~', homepath);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Unable to resolve \"~\" in path');\n\t\t\t}\n\t\t}\n\t\tthis.absolutePath = path.resolve(absolutePath);\n\t\tmkdirp.sync(this.absolutePath);\n\t\tthis.statSync = Meteor.wrapAsync(fs.stat.bind(fs));\n\t\tthis.unlinkSync = Meteor.wrapAsync(fs.unlink.bind(fs));\n\t\tthis.getFileSync = Meteor.wrapAsync(this.getFile.bind(this));\n\t}\n\n\tcreateWriteStream(fileName, contentType) {\n\t\tconst self = this;\n\t\tlet ws = fs.createWriteStream(path.join(this.absolutePath, fileName));\n\t\tif (self.transformWrite != null) {\n\t\t\tws = RocketChatFile.addPassThrough(ws, function(rs, ws) {\n\t\t\t\tconst file = {\n\t\t\t\t\tfileName,\n\t\t\t\t\tcontentType\n\t\t\t\t};\n\t\t\t\treturn self.transformWrite(file, rs, ws);\n\t\t\t});\n\t\t}\n\t\tws.on('close', function() {\n\t\t\treturn ws.emit('end');\n\t\t});\n\t\treturn ws;\n\t}\n\n\tcreateReadStream(fileName) {\n\t\treturn fs.createReadStream(path.join(this.absolutePath, fileName));\n\t}\n\n\tstat(fileName) {\n\t\treturn this.statSync(path.join(this.absolutePath, fileName));\n\t}\n\n\tremove(fileName) {\n\t\treturn this.unlinkSync(path.join(this.absolutePath, fileName));\n\t}\n\n\tgetFileWithReadStream(fileName) {\n\t\ttry {\n\t\t\tconst stat = this.stat(fileName);\n\t\t\tconst rs = this.createReadStream(fileName);\n\t\t\treturn {\n\t\t\t\treadStream: rs,\n\t\t\t\t// contentType: file.contentType\n\t\t\t\tlength: stat.size\n\t\t\t};\n\t\t} catch (error1) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetFile(fileName, cb) {\n\t\tconst file = this.getFileWithReadStream(fileName);\n\t\tif (!file) {\n\t\t\treturn cb();\n\t\t}\n\t\tconst data = [];\n\t\tfile.readStream.on('data', Meteor.bindEnvironment(function(chunk) {\n\t\t\treturn data.push(chunk);\n\t\t}));\n\t\treturn file.readStream.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn {\n\t\t\t\tbuffer: Buffer.concat(data)({\n\t\t\t\t\tcontentType: file.contentType,\n\t\t\t\t\tlength: file.length,\n\t\t\t\t\tuploadDate: file.uploadDate\n\t\t\t\t})\n\t\t\t};\n\t\t}));\n\t}\n\n\tdeleteFile(fileName) {\n\t\ttry {\n\t\t\treturn this.remove(fileName);\n\t\t} catch (error1) {\n\t\t\treturn null;\n\t\t}\n\t}\n};\n"]}