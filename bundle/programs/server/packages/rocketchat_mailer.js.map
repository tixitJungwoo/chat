{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mailer/lib/Mailer.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/functions/sendMail.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/functions/unsubscribe.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/methods/sendMail.js","meteor://ðŸ’»app/packages/rocketchat:mailer/server/methods/unsubscribe.js"],"names":["Mailer","Meteor","startup","RocketChat","models","Permissions","upsert","$setOnInsert","_id","roles","Users","rocketMailUnsubscribe","createdAt","query","Date","parseInt","update","$set","affectedRows","console","log","sendMail","from","subject","body","dryrun","rfcMailPatternWithName","test","Error","indexOf","header","placeholders","replace","settings","get","footer","userQuery","$exists","$and","EJSON","parse","users","find","forEach","user","email","undefined","emails","address","html","unsubscribe","absoluteUrl","FlowRouter","path","getTime","name","defer","Email","send","to","methods","userId","method","authz","hasRole","DDPRateLimiter","addRule","type","connectionId"],"mappings":"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","file":"/packages/rocketchat_mailer.js","sourcesContent":["Mailer = {};//eslint-disable-line\n","Meteor.startup(function() {\n\treturn RocketChat.models.Permissions.upsert('access-mailer', {\n\t\t$setOnInsert: {\n\t\t\t_id: 'access-mailer',\n\t\t\troles: ['admin']\n\t\t}\n\t});\n});\n","RocketChat.models.Users.rocketMailUnsubscribe = function(_id, createdAt) {\n\tconst query = {\n\t\t_id,\n\t\tcreatedAt: new Date(parseInt(createdAt))\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\t'mailer.unsubscribed': true\n\t\t}\n\t};\n\tconst affectedRows = this.update(query, update);\n\tconsole.log('[Mailer:Unsubscribe]', _id, createdAt, new Date(parseInt(createdAt)), affectedRows);\n\treturn affectedRows;\n};\n","/*globals Mailer */\nMailer.sendMail = function(from, subject, body, dryrun, query) {\n\n\tconst rfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;\n\tif (!rfcMailPatternWithName.test(from)) {\n\t\tthrow new Meteor.Error('error-invalid-from-address', 'Invalid from address', {\n\t\t\t'function': 'Mailer.sendMail'\n\t\t});\n\t}\n\tif (body.indexOf('[unsubscribe]') === -1) {\n\t\tthrow new Meteor.Error('error-missing-unsubscribe-link', 'You must provide the [unsubscribe] link.', {\n\t\t\t'function': 'Mailer.sendMail'\n\t\t});\n\t}\n\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\tlet userQuery = { 'mailer.unsubscribed': { $exists: 0 } };\n\tif (query) {\n\t\tuserQuery = { $and: [ userQuery, EJSON.parse(query) ] };\n\t}\n\n\tif (dryrun) {\n\t\treturn Meteor.users.find({\n\t\t\t'emails.address': from\n\t\t}).forEach((user) => {\n\t\t\tlet email = undefined;\n\t\t\tif (user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\temail = user.emails[0].address;\n\t\t\t}\n\t\t\tconst html = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tcreatedAt: user.createdAt.getTime()\n\t\t\t\t})),\n\t\t\t\tname: user.name,\n\t\t\t\temail\n\t\t\t});\n\t\t\temail = `${ user.name } <${ email }>`;\n\t\t\tif (rfcMailPatternWithName.test(email)) {\n\t\t\t\tMeteor.defer(function() {\n\t\t\t\t\treturn Email.send({\n\t\t\t\t\t\tto: email,\n\t\t\t\t\t\tfrom,\n\t\t\t\t\t\tsubject,\n\t\t\t\t\t\thtml: header + html + footer\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\treturn console.log(`Sending email to ${ email }`);\n\t\t\t}\n\t\t});\n\t} else {\n\t\treturn Meteor.users.find(userQuery).forEach(function(user) {\n\t\t\tlet email = undefined;\n\t\t\tif (user.emails && user.emails[0] && user.emails[0].address) {\n\t\t\t\temail = user.emails[0].address;\n\t\t\t}\n\t\t\tconst html = RocketChat.placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tcreatedAt: user.createdAt.getTime()\n\t\t\t\t})),\n\t\t\t\tname: user.name,\n\t\t\t\temail\n\t\t\t});\n\t\t\temail = `${ user.name } <${ email }>`;\n\t\t\tif (rfcMailPatternWithName.test(email)) {\n\t\t\t\tMeteor.defer(function() {\n\t\t\t\t\treturn Email.send({\n\t\t\t\t\t\tto: email,\n\t\t\t\t\t\tfrom,\n\t\t\t\t\t\tsubject,\n\t\t\t\t\t\thtml: header + html + footer\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\treturn console.log(`Sending email to ${ email }`);\n\t\t\t}\n\t\t});\n\t}\n};\n","/* globals Mailer */\nMailer.unsubscribe = function(_id, createdAt) {\n\tif (_id && createdAt) {\n\t\treturn RocketChat.models.Users.rocketMailUnsubscribe(_id, createdAt) === 1;\n\t}\n\treturn false;\n};\n","/*globals Mailer */\nMeteor.methods({\n\t'Mailer.sendMail'(from, subject, body, dryrun, query) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'Mailer.sendMail'\n\t\t\t});\n\t\t}\n\t\tif (RocketChat.authz.hasRole(userId, 'admin') !== true) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'Mailer.sendMail'\n\t\t\t});\n\t\t}\n\t\treturn Mailer.sendMail(from, subject, body, dryrun, query);\n\t}\n});\n\n\n//Limit setting username once per minute\n//DDPRateLimiter.addRule\n//\ttype: 'method'\n//\tname: 'Mailer.sendMail'\n//\tconnectionId: -> return true\n//\t, 1, 60000\n","/*globals Mailer */\nMeteor.methods({\n\t'Mailer:unsubscribe'(_id, createdAt) {\n\t\treturn Mailer.unsubscribe(_id, createdAt);\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'Mailer:unsubscribe',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 60000);\n"]}