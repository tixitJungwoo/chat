{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:spotify/lib/spotify.js"],"names":["process","message","source","callback","_","trim","msgParts","split","index","length","part","undefined","codeMatch","match","Spotify","transform","urls","Array","isArray","concat","changed","msg","re","exec","data","filter","slice","value","path","map","escape","join","url","push","render","html","from","item","quotedSource","replace","RegExp","RocketChat","callbacks","add","priority","LOW","MEDIUM"],"mappings":"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","file":"/packages/rocketchat_spotify.js","sourcesContent":["/*\n * Spotify a named function that will process Spotify links or syntaxes (ex: spotify:track:1q6IK1l4qpYykOaWaLJkWG)\n * @param {Object} message - The message object\n */\n\nconst process = function(message, source, callback) {\n\tif (_.trim(source)) {\n\t\t// Separate text in code blocks and non code blocks\n\t\tconst msgParts = source.split(/(```\\w*[\\n ]?[\\s\\S]*?```+?)|(`(?:[^`]+)`)/);\n\n\t\tfor (let index = 0; index < msgParts.length; index++) {\n\t\t\t// Verify if this part is code\n\t\t\tconst part = msgParts[index];\n\n\t\t\tif (((part != null ? part.length > 0 : undefined) != null)) {\n\t\t\t\tconst codeMatch = part.match(/(?:```(\\w*)[\\n ]?([\\s\\S]*?)```+?)|(?:`(?:[^`]+)`)/);\n\t\t\t\tif (codeMatch == null) {\n\t\t\t\t\tcallback(message, msgParts, index, part);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n};\nclass Spotify {\n\tstatic transform(message) {\n\t\tlet urls = [];\n\t\tif (Array.isArray(message.urls)) {\n\t\t\turls = urls.concat(message.urls);\n\t\t}\n\n\t\tlet changed = false;\n\n\t\tprocess(message, message.msg, function(message, msgParts, index, part) {\n\t\t\tconst re = /(?:^|\\s)spotify:([^:\\s]+):([^:\\s]+)(?::([^:\\s]+))?(?::(\\S+))?(?:\\s|$)/g;\n\n\t\t\tlet match;\n\t\t\twhile ((match = re.exec(part))) {\n\t\t\t\tconst data = _.filter(match.slice(1), value => value != null);\n\t\t\t\tconst path = _.map(data, value => _.escape(value)).join('/');\n\t\t\t\tconst url = `https://open.spotify.com/${ path }`;\n\t\t\t\turls.push({url, 'source': `spotify:${ data.join(':') }`});\n\t\t\t\tchanged = true;\n\t\t\t}\n\n\t\t});\n\n\t\t// Re-mount message\n\t\tif (changed) {\n\t\t\tmessage.urls = urls;\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tstatic render(message) {\n\t\tprocess(message, message.html, function(message, msgParts, index, part) {\n\t\t\tif (Array.isArray(message.urls)) {\n\t\t\t\tfor (const item of Array.from(message.urls)) {\n\t\t\t\t\tif (item.source) {\n\t\t\t\t\t\tconst quotedSource = item.source.replace(/[\\\\^$.*+?()[\\]{}|]/g, '\\\\$&');\n\t\t\t\t\t\tconst re = new RegExp(`(^|\\\\s)${ quotedSource }(\\\\s|$)`, 'g');\n\t\t\t\t\t\tmsgParts[index] = part.replace(re, `$1<a href=\"${ item.url }\" target=\"_blank\">${ item.source }</a>$2`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn message.html = msgParts.join('');\n\t\t\t}\n\t\t});\n\n\t\treturn message;\n\t}\n}\n\nRocketChat.callbacks.add('beforeSaveMessage', Spotify.transform, RocketChat.callbacks.priority.LOW, 'spotify-save');\nRocketChat.callbacks.add('renderMessage', Spotify.render, RocketChat.callbacks.priority.MEDIUM, 'spotify-render');\nRocketChat.Spotify = Spotify;\n"]}