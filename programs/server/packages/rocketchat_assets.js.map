{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:assets/server/assets.js"],"names":["sizeOf","module","watch","require","v","mime","crypto","extensions","RocketChatAssetsInstance","RocketChatFile","GridFS","name","assets","logo","label","defaultUrl","constraints","type","width","undefined","height","favicon_ico","favicon","favicon_16","favicon_32","favicon_192","favicon_512","touchicon_180","touchicon_180_pre","tile_144","tile_150","tile_310_square","tile_310_wide","safari_pinned","RocketChat","Assets","setAsset","binaryContent","contentType","asset","Meteor","Error","extension","includes","errorTitle","file","Buffer","dimensions","rs","bufferToStream","deleteFile","ws","createWriteStream","on","bindEnvironment","setTimeout","key","value","url","settings","updateById","processAsset","pipe","unsetAsset","refreshClients","process","emit","refresh","settingKey","settingValue","indexOf","assetKey","replace","assetValue","cache","getFileSync","hash","createHash","update","buffer","digest","split","pop","path","cacheable","sourceMapUrl","where","content","size","length","uploadDate","addGroup","add","group","i18nLabel","addAssetToSetting","fileConstraints","Object","keys","models","Settings","find","observe","added","record","_id","changed","removed","startup","calculateClientHash","WebAppHashing","manifest","includeFilter","runtimeConfigOverride","WebAppInternals","staticFiles","manifestItem","_","findWhere","index","push","call","methods","userId","method","hasPermission","authz","action","WebApp","connectHandlers","use","req","res","next","params","decodeURIComponent","staticFilesMiddleware","writeHead","end","reqModifiedHeader","headers","toUTCString","setHeader","Date"],"mappings":"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","file":"/packages/rocketchat_assets.js","sourcesContent":["/* global WebAppHashing, WebAppInternals */\n\nimport sizeOf from 'image-size';\nimport mime from 'mime-type/with-db';\nimport crypto from 'crypto';\n\nmime.extensions['image/vnd.microsoft.icon'] = ['ico'];\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets'\n});\n\nthis.RocketChatAssetsInstance = RocketChatAssetsInstance;\n\nconst assets = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16\n\t\t}\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32\n\t\t}\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192\n\t\t}\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512\n\t\t}\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180\n\t\t}\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180\n\t\t}\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144\n\t\t}\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150\n\t\t}\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310\n\t\t}\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150\n\t\t}\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t\twidth: undefined,\n\t\t\theight: undefined\n\t\t}\n\t}\n};\n\nRocketChat.Assets = new (class {\n\tget mime() {\n\t\treturn mime;\n\t}\n\n\tget assets() {\n\t\treturn assets;\n\t}\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst extension = mime.extension(contentType);\n\t\tif (assets[asset].constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error(contentType, `Invalid file type: ${ contentType }`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t\terrorTitle: 'error-invalid-file-type'\n\t\t\t});\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\t\tif (assets[asset].constraints.width || assets[asset].constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assets[asset].constraints.width && assets[asset].constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width'\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assets[asset].constraints.height && assets[asset].constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(function() {\n\t\t\treturn Meteor.setTimeout(function() {\n\t\t\t\tconst key = `Assets_${ asset }`;\n\t\t\t\tconst value = {\n\t\t\t\t\turl: `assets/${ asset }.${ extension }`,\n\t\t\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t\t\t};\n\n\t\t\t\tRocketChat.settings.updateById(key, value);\n\t\t\t\treturn RocketChat.Assets.processAsset(key, value);\n\t\t\t}, 200);\n\t\t}));\n\n\t\trs.pipe(ws);\n\t}\n\n\tunsetAsset(asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset'\n\t\t\t});\n\t\t}\n\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${ asset }`;\n\t\tconst value = {\n\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t};\n\n\t\tRocketChat.settings.updateById(key, value);\n\t\tRocketChat.Assets.processAsset(key, value);\n\t}\n\n\trefreshClients() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client'\n\t\t});\n\t}\n\n\tprocessAsset(settingKey, settingValue) {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = assets[assetKey];\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue || !settingValue.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatAssetsInstance.getFileSync(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\treturn assetValue.cache = {\n\t\t\tpath: `assets/${ assetKey }.${ extension }`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${ assetKey }.${ extension }?${ hash }`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash\n\t\t};\n\t}\n});\n\nRocketChat.settings.addGroup('Assets');\n\nRocketChat.settings.add('Assets_SvgFavicon_Enable', true, {\n\ttype: 'boolean',\n\tgroup: 'Assets',\n\ti18nLabel: 'Enable_Svg_Favicon'\n});\n\nfunction addAssetToSetting(key, value) {\n\treturn RocketChat.settings.add(`Assets_${ key }`, {\n\t\tdefaultUrl: value.defaultUrl\n\t}, {\n\t\ttype: 'asset',\n\t\tgroup: 'Assets',\n\t\tfileConstraints: value.constraints,\n\t\ti18nLabel: value.label,\n\t\tasset: key,\n\t\tpublic: true\n\t});\n}\n\nfor (const key of Object.keys(assets)) {\n\tconst value = assets[key];\n\taddAssetToSetting(key, value);\n}\n\nRocketChat.models.Settings.find().observe({\n\tadded(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tchanged(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, record.value);\n\t},\n\n\tremoved(record) {\n\t\treturn RocketChat.Assets.processAsset(record._id, undefined);\n\t}\n});\n\nMeteor.startup(function() {\n\treturn Meteor.setTimeout(function() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client'\n\t\t});\n\t}, 200);\n});\n\nconst calculateClientHash = WebAppHashing.calculateClientHash;\n\nWebAppHashing.calculateClientHash = function(manifest, includeFilter, runtimeConfigOverride) {\n\tfor (const key of Object.keys(assets)) {\n\t\tconst value = assets[key];\n\t\tif (!value.cache && !value.defaultUrl) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet cache = {};\n\t\tif (value.cache) {\n\t\t\tcache = {\n\t\t\t\tpath: value.cache.path,\n\t\t\t\tcacheable: value.cache.cacheable,\n\t\t\t\tsourceMapUrl: value.cache.sourceMapUrl,\n\t\t\t\twhere: value.cache.where,\n\t\t\t\ttype: value.cache.type,\n\t\t\t\turl: value.cache.url,\n\t\t\t\tsize: value.cache.size,\n\t\t\t\thash: value.cache.hash\n\t\t\t};\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = value.cache;\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ value.cache.extension }`] = value.cache;\n\t\t} else {\n\t\t\tconst extension = value.defaultUrl.split('.').pop();\n\t\t\tcache = {\n\t\t\t\tpath: `assets/${ key }.${ extension }`,\n\t\t\t\tcacheable: false,\n\t\t\t\tsourceMapUrl: undefined,\n\t\t\t\twhere: 'client',\n\t\t\t\ttype: 'asset',\n\t\t\t\turl: `/assets/${ key }.${ extension }?v3`,\n\t\t\t\thash: 'v3'\n\t\t\t};\n\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t\tWebAppInternals.staticFiles[`/__cordova/assets/${ key }.${ extension }`] = WebAppInternals.staticFiles[`/__cordova/${ value.defaultUrl }`];\n\t\t}\n\n\t\tconst manifestItem = _.findWhere(manifest, {\n\t\t\tpath: key\n\t\t});\n\n\t\tif (manifestItem) {\n\t\t\tconst index = manifest.indexOf(manifestItem);\n\t\t\tmanifest[index] = cache;\n\t\t} else {\n\t\t\tmanifest.push(cache);\n\t\t}\n\t}\n\n\treturn calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nMeteor.methods({\n\trefreshClients() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'refreshClients'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.refreshClients();\n\t},\n\n\tunsetAsset(asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'unsetAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChat.Assets.unsetAsset(asset);\n\t},\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'setAsset'\n\t\t\t});\n\t\t}\n\n\t\tconst hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-now-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t\taction: 'Managing_assets'\n\t\t\t});\n\t\t}\n\n\t\tRocketChat.Assets.setAsset(binaryContent, contentType, asset);\n\t}\n});\n\nWebApp.connectHandlers.use('/assets/', Meteor.bindEnvironment(function(req, res, next) {\n\tconst params = {\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, '')\n\t};\n\n\tconst file = assets[params.asset] && assets[params.asset].cache;\n\n\tif (!file) {\n\t\tif (assets[params.asset] && assets[params.asset].defaultUrl) {\n\t\t\treq.url = `/${ assets[params.asset].defaultUrl }`;\n\t\t\tWebAppInternals.staticFilesMiddleware(WebAppInternals.staticFiles, req, res, next);\n\t\t} else {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t}\n\n\t\treturn;\n\t}\n\n\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\tif (reqModifiedHeader) {\n\t\tif (reqModifiedHeader === (file.uploadDate && file.uploadDate.toUTCString())) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tres.setHeader('Cache-Control', 'public, max-age=0');\n\tres.setHeader('Expires', '-1');\n\tres.setHeader('Last-Modified', (file.uploadDate && file.uploadDate.toUTCString()) || new Date().toUTCString());\n\tres.setHeader('Content-Type', file.contentType);\n\tres.setHeader('Content-Length', file.size);\n\tres.writeHead(200);\n\tres.end(file.content);\n}));\n"]}