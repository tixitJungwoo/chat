{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:integrations/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/logger.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/validation.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/triggerHandler.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/Integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/IntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/addIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/updateIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/deleteIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/addOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/updateOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/replayOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/deleteOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/clearIntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/api/api.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/triggers.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/processWebhookMessage.js"],"names":["RocketChat","integrations","outgoingEvents","sendMessage","label","value","use","channel","triggerWords","targetRoom","fileUploaded","roomArchived","roomCreated","roomJoined","roomLeft","userCreated","logger","Logger","sections","incoming","outgoing","scopedChannels","validChannelChars","_verifyRequiredFields","integration","event","Match","test","String","trim","Meteor","Error","username","urls","entries","index","url","_","without","undefined","length","_verifyUserHasPermissionForChannels","userId","channels","includes","authz","hasPermission","record","channelType","substr","models","Rooms","findOne","$or","_id","name","Users","usernames","user","_verifyRetryInformation","retryFailedCalls","retryCount","parseInt","retryDelay","toLowerCase","validateOutgoing","_validateOutgoing","map","split","s","triggerWord","scriptEnabled","script","babelOptions","Object","assign","Babel","getDefaultOptions","runtime","compact","minified","comments","scriptCompiled","compile","code","scriptError","e","pick","runOnEdits","type","moment","module","watch","require","v","triggerHandler","vm","Npm","successResults","compiledScripts","triggers","Integrations","find","observe","added","addIntegration","changed","removeIntegration","removed","debug","isEmpty","concat","values","trigger","isTriggerEnabled","trig","enabled","updateHistory","historyId","step","data","ranPrepareScript","prepareSentMessage","processSentMessage","resultMessage","finished","httpCallData","httpError","httpResult","error","errorStack","history","omit","room","IntegrationHistory","update","$set","_createdAt","Date","insert","Random","id","nameOrId","message","impersonateUser","findOneByUsername","user_name","tmpRoom","getRoomByNameOrIdWithOptionToJoin","currentUserId","errorOnEmpty","warn","t","bot","i","defaultValues","alias","avatar","emoji","processWebhookMessage","buildSandbox","store","sandbox","console","Store","set","key","val","get","HTTP","method","options","result","call","keys","filter","k","startsWith","forEach","getIntegrationScript","compiledScript","_updatedAt","vmScript","info","createScript","runInNewContext","Script","replace","stack","hasScriptAndMethod","executeScript","params","timeout","eventNameArgumentsToObject","argObject","arguments","arghhh","owner","mapEventArgsToData","channel_id","channel_name","message_id","timestamp","ts","user_id","u","text","msg","editedAt","isEdited","createdAt","executeTriggers","triggersToExecute","push","all_direct_messages","all_public_channels","all_private_groups","__any","triggerToExecute","executeTrigger","executeTriggerUrl","theHistoryId","tries","word","triggerWordAnywhere","indexOf","token","trigger_word","opts","auth","npmRequestOptions","rejectUnauthorized","settings","strictSSL","headers","request","prepareMessage","statusCode","response","status_code","content","content_raw","scriptResult","waitTime","Math","pow","er","setTimeout","attachments","resultMsg","replay","Messages","findOneById","findByType","disableByUserId","multi","_Base","findByIntegrationId","findByIntegrationIdAndCreatedBy","creatorId","findOneByIntegrationIdAndHistoryId","integrationId","findByEventName","findFailed","removeByIntegrationId","remove","publish","_integrationPublication","ready","_integrationHistoryPublication","limit","sort","methods","addIncomingIntegration","isString","extend","_createdBy","fields","Roles","addUserRoles","updateIncomingIntegration","currentIntegration","_updatedBy","deleteIncomingIntegration","addOutgoingIntegration","updateOutgoingIntegration","replayOutgoingIntegration","deleteOutgoingIntegration","clearIntegrationHistory","Livechat","API","v1","failure","Api","Restivus","enableCors","apiPath","payloadKeys","bodyParams","payloadIsWrapped","payload","JSON","parse","body","success","decodeURIComponent","createIntegration","runAsUser","target_url","trigger_words","integrationToRemove","executeIntegrationRest","urlParams","hash","_parsedUrl","search","query","queryParams","pathname","path","url_raw","url_params","_readableState","buffer","toString","scriptResponse","addIntegrationRest","removeIntegrationRest","integrationSampleRest","integrationInfoRest","addRoute","authRequired","post","callbackHandler","_callbackHandler","eventType","_wrapperFunction","callbacks","add","priority","LOW","messageObj","sentData","roomId","channelValue","joinChannel","tryDirectByUserIdOnly","isArray","log","red","parseUrls","groupable","icon_url","icon_emoji","attachment","messageReturn"],"mappings":"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","file":"/packages/rocketchat_integrations.js","sourcesContent":["RocketChat.integrations = {\n\toutgoingEvents: {\n\t\tsendMessage: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_SendMessage',\n\t\t\tvalue: 'sendMessage',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: true,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tfileUploaded: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_FileUploaded',\n\t\t\tvalue: 'fileUploaded',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomArchived: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomArchived',\n\t\t\tvalue: 'roomArchived',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomCreated',\n\t\t\tvalue: 'roomCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomJoined: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomJoined',\n\t\t\tvalue: 'roomJoined',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomLeft: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomLeft',\n\t\t\tvalue: 'roomLeft',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tuserCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_UserCreated',\n\t\t\tvalue: 'userCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: true\n\t\t\t}\n\t\t}\n\t}\n};\n","/* globals logger:true */\n/* exported logger */\n\nlogger = new Logger('Integrations', {\n\tsections: {\n\t\tincoming: 'Incoming WebHook',\n\t\toutgoing: 'Outgoing WebHook'\n\t}\n});\n","/* global Babel */\nconst scopedChannels = ['all_public_channels', 'all_private_groups', 'all_direct_messages'];\nconst validChannelChars = ['@', '#'];\n\nfunction _verifyRequiredFields(integration) {\n\tif (!integration.event || !Match.test(integration.event, String) || integration.event.trim() === '' || !RocketChat.integrations.outgoingEvents[integration.event]) {\n\t\tthrow new Meteor.Error('error-invalid-event-type', 'Invalid event type', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!integration.username || !Match.test(integration.username, String) || integration.username.trim() === '') {\n\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.targetRoom && !integration.targetRoom) {\n\t\tthrow new Meteor.Error('error-invalid-targetRoom', 'Invalid Target Room', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!Match.test(integration.urls, [String])) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tfor (const [index, url] of integration.urls.entries()) {\n\t\tif (url.trim() === '') {\n\t\t\tdelete integration.urls[index];\n\t\t}\n\t}\n\n\tintegration.urls = _.without(integration.urls, [undefined]);\n\n\tif (integration.urls.length === 0) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n}\n\nfunction _verifyUserHasPermissionForChannels(integration, userId, channels) {\n\tfor (let channel of channels) {\n\t\tif (scopedChannels.includes(channel)) {\n\t\t\tif (channel === 'all_public_channels') {\n\t\t\t\t// No special permissions needed to add integration to public channels\n\t\t\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t} else {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(userId, 'manage-integrations') && RocketChat.authz.hasPermission(userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction _verifyRetryInformation(integration) {\n\tif (!integration.retryFailedCalls) {\n\t\treturn;\n\t}\n\n\t// Don't allow negative retry counts\n\tintegration.retryCount = integration.retryCount && parseInt(integration.retryCount) > 0 ? parseInt(integration.retryCount) : 4;\n\tintegration.retryDelay = !integration.retryDelay || !integration.retryDelay.trim() ? 'powers-of-ten' : integration.retryDelay.toLowerCase();\n}\n\nRocketChat.integrations.validateOutgoing = function _validateOutgoing(integration, userId) {\n\tif (integration.channel && Match.test(integration.channel, String) && integration.channel.trim() === '') {\n\t\tdelete integration.channel;\n\t}\n\n\t//Moved to it's own function to statisfy the complexity rule\n\t_verifyRequiredFields(integration);\n\n\tlet channels = [];\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.channel) {\n\t\tif (!Match.test(integration.channel, String)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing' });\n\t\t} else {\n\t\t\tchannels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\t\tfor (const channel of channels) {\n\t\t\t\tif (!validChannelChars.includes(channel[0]) && !scopedChannels.includes(channel.toLowerCase())) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { function: 'validateOutgoing' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\tthrow new Meteor.Error('error-invalid-permissions', 'Invalid permission for required Integration creation.', { function: 'validateOutgoing' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.triggerWords && integration.triggerWords) {\n\t\tif (!Match.test(integration.triggerWords, [String])) {\n\t\t\tthrow new Meteor.Error('error-invalid-triggerWords', 'Invalid triggerWords', { function: 'validateOutgoing' });\n\t\t}\n\n\t\tfor (const [index, triggerWord] of integration.triggerWords) {\n\t\t\tif (triggerWord.trim() === '') {\n\t\t\t\tdelete integration.triggerWords[index];\n\t\t\t}\n\t\t}\n\n\t\tintegration.triggerWords = _.without(integration.triggerWords, [undefined]);\n\t} else {\n\t\tdelete integration.triggerWords;\n\t}\n\n\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\ttry {\n\t\t\tconst babelOptions = Object.assign(Babel.getDefaultOptions({ runtime: false }), { compact: true, minified: true, comments: false });\n\n\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\tintegration.scriptError = undefined;\n\t\t} catch (e) {\n\t\t\tintegration.scriptCompiled = undefined;\n\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t}\n\t}\n\n\tif (typeof integration.runOnEdits !== 'undefined') {\n\t\t// Verify this value is only true/false\n\t\tintegration.runOnEdits = integration.runOnEdits === true;\n\t}\n\n\t_verifyUserHasPermissionForChannels(integration, userId, channels);\n\t_verifyRetryInformation(integration);\n\n\tconst user = RocketChat.models.Users.findOne({ username: integration.username });\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { function: 'validateOutgoing' });\n\t}\n\n\tintegration.type = 'webhook-outgoing';\n\tintegration.userId = user._id;\n\tintegration.channel = channels;\n\n\treturn integration;\n};\n","/* global logger, processWebhookMessage */\nimport moment from 'moment';\n\nRocketChat.integrations.triggerHandler = new class RocketChatIntegrationHandler {\n\tconstructor() {\n\t\tthis.vm = Npm.require('vm');\n\t\tthis.successResults = [200, 201, 202];\n\t\tthis.compiledScripts = {};\n\t\tthis.triggers = {};\n\n\t\tRocketChat.models.Integrations.find({type: 'webhook-outgoing'}).observe({\n\t\t\tadded: (record) => {\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tchanged: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tremoved: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t}\n\t\t});\n\t}\n\n\taddIntegration(record) {\n\t\tlogger.outgoing.debug(`Adding the integration ${ record.name } of the event ${ record.event }!`);\n\t\tlet channels;\n\t\tif (record.event && !RocketChat.integrations.outgoingEvents[record.event].use.channel) {\n\t\t\tlogger.outgoing.debug('The integration doesnt rely on channels.');\n\t\t\t//We don't use any channels, so it's special ;)\n\t\t\tchannels = ['__any'];\n\t\t} else if (_.isEmpty(record.channel)) {\n\t\t\tlogger.outgoing.debug('The integration had an empty channel property, so it is going on all the public channels.');\n\t\t\tchannels = ['all_public_channels'];\n\t\t} else {\n\t\t\tlogger.outgoing.debug('The integration is going on these channels:', record.channel);\n\t\t\tchannels = [].concat(record.channel);\n\t\t}\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!this.triggers[channel]) {\n\t\t\t\tthis.triggers[channel] = {};\n\t\t\t}\n\n\t\t\tthis.triggers[channel][record._id] = record;\n\t\t}\n\t}\n\n\tremoveIntegration(record) {\n\t\tfor (const trigger of Object.values(this.triggers)) {\n\t\t\tdelete trigger[record._id];\n\t\t}\n\t}\n\n\tisTriggerEnabled(trigger) {\n\t\tfor (const trig of Object.values(this.triggers)) {\n\t\t\tif (trig[trigger._id]) {\n\t\t\t\treturn trig[trigger._id].enabled;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tupdateHistory({ historyId, step, integration, event, data, triggerWord, ranPrepareScript, prepareSentMessage, processSentMessage, resultMessage, finished, url, httpCallData, httpError, httpResult, error, errorStack }) {\n\t\tconst history = {\n\t\t\ttype: 'outgoing-webhook',\n\t\t\tstep\n\t\t};\n\n\t\t// Usually is only added on initial insert\n\t\tif (integration) {\n\t\t\thistory.integration = integration;\n\t\t}\n\n\t\t// Usually is only added on initial insert\n\t\tif (event) {\n\t\t\thistory.event = event;\n\t\t}\n\n\t\tif (data) {\n\t\t\thistory.data = data;\n\n\t\t\tif (data.user) {\n\t\t\t\thistory.data.user = _.omit(data.user, ['meta', '$loki', 'services']);\n\t\t\t}\n\n\t\t\tif (data.room) {\n\t\t\t\thistory.data.room = _.omit(data.room, ['meta', '$loki', 'usernames']);\n\t\t\t\thistory.data.room.usernames = ['this_will_be_filled_in_with_usernames_when_replayed'];\n\t\t\t}\n\t\t}\n\n\t\tif (triggerWord) {\n\t\t\thistory.triggerWord = triggerWord;\n\t\t}\n\n\t\tif (typeof ranPrepareScript !== 'undefined') {\n\t\t\thistory.ranPrepareScript = ranPrepareScript;\n\t\t}\n\n\t\tif (prepareSentMessage) {\n\t\t\thistory.prepareSentMessage = prepareSentMessage;\n\t\t}\n\n\t\tif (processSentMessage) {\n\t\t\thistory.processSentMessage = processSentMessage;\n\t\t}\n\n\t\tif (resultMessage) {\n\t\t\thistory.resultMessage = resultMessage;\n\t\t}\n\n\t\tif (typeof finished !== 'undefined') {\n\t\t\thistory.finished = finished;\n\t\t}\n\n\t\tif (url) {\n\t\t\thistory.url = url;\n\t\t}\n\n\t\tif (typeof httpCallData !== 'undefined') {\n\t\t\thistory.httpCallData = httpCallData;\n\t\t}\n\n\t\tif (httpError) {\n\t\t\thistory.httpError = httpError;\n\t\t}\n\n\t\tif (typeof httpResult !== 'undefined') {\n\t\t\thistory.httpResult = httpResult;\n\t\t}\n\n\t\tif (typeof error !== 'undefined') {\n\t\t\thistory.error = error;\n\t\t}\n\n\t\tif (typeof errorStack !== 'undefined') {\n\t\t\thistory.errorStack = errorStack;\n\t\t}\n\n\t\tif (historyId) {\n\t\t\tRocketChat.models.IntegrationHistory.update({ _id: historyId }, { $set: history });\n\t\t\treturn historyId;\n\t\t} else {\n\t\t\thistory._createdAt = new Date();\n\t\t\treturn RocketChat.models.IntegrationHistory.insert(Object.assign({ _id: Random.id() }, history));\n\t\t}\n\t}\n\n\t//Trigger is the trigger, nameOrId is a string which is used to try and find a room, room is a room, message is a message, and data contains \"user_name\" if trigger.impersonateUser is truthful.\n\tsendMessage({ trigger, nameOrId = '', room, message, data }) {\n\t\tlet user;\n\t\t//Try to find the user who we are impersonating\n\t\tif (trigger.impersonateUser) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(data.user_name);\n\t\t}\n\n\t\t//If they don't exist (aka the trigger didn't contain a user) then we set the user based upon the\n\t\t//configured username for the integration since this is required at all times.\n\t\tif (!user) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(trigger.username);\n\t\t}\n\n\t\tlet tmpRoom;\n\t\tif (nameOrId || trigger.targetRoom) {\n\t\t\ttmpRoom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: nameOrId || trigger.targetRoom, errorOnEmpty: false }) || room;\n\t\t} else {\n\t\t\ttmpRoom = room;\n\t\t}\n\n\t\t//If no room could be found, we won't be sending any messages but we'll warn in the logs\n\t\tif (!tmpRoom) {\n\t\t\tlogger.outgoing.warn(`The Integration \"${ trigger.name }\" doesn't have a room configured nor did it provide a room to send the message to.`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found a room for ${ trigger.name } which is: ${ tmpRoom.name } with a type of ${ tmpRoom.t }`);\n\n\t\tmessage.bot = { i: trigger._id };\n\n\t\tconst defaultValues = {\n\t\t\talias: trigger.alias,\n\t\t\tavatar: trigger.avatar,\n\t\t\temoji: trigger.emoji\n\t\t};\n\n\t\tif (tmpRoom.t === 'd') {\n\t\t\tmessage.channel = `@${ tmpRoom._id }`;\n\t\t} else {\n\t\t\tmessage.channel = `#${ tmpRoom._id }`;\n\t\t}\n\n\t\tmessage = processWebhookMessage(message, user, defaultValues);\n\t\treturn message;\n\t}\n\n\tbuildSandbox(store = {}) {\n\t\tconst sandbox = {\n\t\t\t_, s, console, moment,\n\t\t\tStore: {\n\t\t\t\tset: (key, val) => store[key] = val,\n\t\t\t\tget: (key) => store[key]\n\t\t\t},\n\t\t\tHTTP: (method, url, options) => {\n\t\t\t\ttry {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t\t};\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn { error };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tObject.keys(RocketChat.models).filter(k => !k.startsWith('_')).forEach(k => {\n\t\t\tsandbox[k] = RocketChat.models[k];\n\t\t});\n\n\t\treturn { store, sandbox };\n\t}\n\n\tgetIntegrationScript(integration) {\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\tconst { store, sandbox } = this.buildSandbox();\n\n\t\tlet vmScript;\n\t\ttry {\n\t\t\tlogger.outgoing.info('Will evaluate script of Trigger', integration.name);\n\t\t\tlogger.outgoing.debug(script);\n\n\t\t\tvmScript = this.vm.createScript(script, 'script.js');\n\n\t\t\tvmScript.runInNewContext(sandbox);\n\n\t\t\tif (sandbox.Script) {\n\t\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\t\tstore,\n\t\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t\t};\n\n\t\t\t\treturn this.compiledScripts[integration._id].script;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlogger.outgoing.error(`Error evaluating Script in Trigger ${ integration.name }:`);\n\t\t\tlogger.outgoing.error(script.replace(/^/gm, '  '));\n\t\t\tlogger.outgoing.error('Stack Trace:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\tthrow new Meteor.Error('error-evaluating-script');\n\t\t}\n\n\t\tif (!sandbox.Script) {\n\t\t\tlogger.outgoing.error(`Class \"Script\" not in Trigger ${ integration.name }:`);\n\t\t\tthrow new Meteor.Error('class-script-not-found');\n\t\t}\n\t}\n\n\thasScriptAndMethod(integration, method) {\n\t\tif (integration.scriptEnabled !== true || !integration.scriptCompiled || integration.scriptCompiled.trim() === '') {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn typeof script[method] !== 'undefined';\n\t}\n\n\texecuteScript(integration, method, params, historyId) {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: 'execute-script-getting-script', error: true, errorStack: e });\n\t\t\treturn;\n\t\t}\n\n\t\tif (!script[method]) {\n\t\t\tlogger.outgoing.error(`Method \"${ method }\" no found in the Integration \"${ integration.name }\"`);\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-no-method-${ method }` });\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst { sandbox } = this.buildSandbox(this.compiledScripts[integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.method = method;\n\t\t\tsandbox.params = params;\n\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-before-running-${ method }` });\n\t\t\tconst result = this.vm.runInNewContext('script[method](params)', sandbox, { timeout: 3000 });\n\n\t\t\tlogger.outgoing.debug(`Script method \"${ method }\" result of the Integration \"${ integration.name }\" is:`);\n\t\t\tlogger.outgoing.debug(result);\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-error-running-${ method }`, error: true, errorStack: e.stack.replace(/^/gm, '  ') });\n\t\t\tlogger.outgoing.error(`Error running Script in the Integration ${ integration.name }:`);\n\t\t\tlogger.outgoing.debug(integration.scriptCompiled.replace(/^/gm, '  ')); // Only output the compiled script if debugging is enabled, so the logs don't get spammed.\n\t\t\tlogger.outgoing.error('Stack:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\treturn;\n\t\t}\n\t}\n\n\teventNameArgumentsToObject() {\n\t\tconst argObject = {\n\t\t\tevent: arguments[0]\n\t\t};\n\n\t\tswitch (argObject.event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.message = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\tconst arghhh = arguments[1];\n\t\t\t\t\targObject.user = arghhh.user;\n\t\t\t\t\targObject.room = arghhh.room;\n\t\t\t\t\targObject.message = arghhh.message;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.room = arguments[1];\n\t\t\t\t\targObject.user = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.owner = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.outgoing.warn(`An Unhandled Trigger Event was called: ${ argObject.event }`);\n\t\t\t\targObject.event = undefined;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Got the event arguments for the event: ${ argObject.event }`, argObject);\n\n\t\treturn argObject;\n\t}\n\n\tmapEventArgsToData(data, { event, message, room, owner, user }) {\n\t\tswitch (event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\n\t\t\t\tif (message.editedAt) {\n\t\t\t\t\tdata.isEdited = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\t\t\t\tdata.message = message;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.timestamp = room.ts;\n\t\t\t\tdata.user_id = owner._id;\n\t\t\t\tdata.user_name = owner.username;\n\t\t\t\tdata.owner = owner;\n\t\t\t\tdata.room = room;\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tdata.timestamp = new Date();\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tdata.timestamp = user.createdAt;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\texecuteTriggers() {\n\t\tlogger.outgoing.debug('Execute Trigger:', arguments[0]);\n\n\t\tconst argObject = this.eventNameArgumentsToObject(...arguments);\n\t\tconst { event, message, room } = argObject;\n\n\t\t//Each type of event should have an event and a room attached, otherwise we\n\t\t//wouldn't know how to handle the trigger nor would we have anywhere to send the\n\t\t//result of the integration\n\t\tif (!event) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst triggersToExecute = [];\n\n\t\tlogger.outgoing.debug('Starting search for triggers for the room:', room ? room._id : '__any');\n\t\tif (room) {\n\t\t\tswitch (room.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tconst id = room._id.replace(message.u._id, '');\n\t\t\t\t\tconst username = _.without(room.usernames, message.u.username)[0];\n\n\t\t\t\t\tif (this.triggers[`@${ id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers.all_direct_messages) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_direct_messages)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (id !== username && this.triggers[`@${ username }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ username }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'c':\n\t\t\t\t\tif (this.triggers.all_public_channels) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_public_channels)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tif (this.triggers.all_private_groups) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_private_groups)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (this.triggers.__any) {\n\t\t\t//For outgoing integration which don't rely on rooms.\n\t\t\tfor (const trigger of Object.values(this.triggers.__any)) {\n\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t}\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found ${ triggersToExecute.length } to iterate over and see if the match the event.`);\n\n\t\tfor (const triggerToExecute of triggersToExecute) {\n\t\t\tlogger.outgoing.debug(`Is \"${ triggerToExecute.name }\" enabled, ${ triggerToExecute.enabled }, and what is the event? ${ triggerToExecute.event }`);\n\t\t\tif (triggerToExecute.enabled === true && triggerToExecute.event === event) {\n\t\t\t\tthis.executeTrigger(triggerToExecute, argObject);\n\t\t\t}\n\t\t}\n\t}\n\n\texecuteTrigger(trigger, argObject) {\n\t\tfor (const url of trigger.urls) {\n\t\t\tthis.executeTriggerUrl(url, trigger, argObject, 0);\n\t\t}\n\t}\n\n\texecuteTriggerUrl(url, trigger, { event, message, room, owner, user }, theHistoryId, tries = 0) {\n\t\tif (!this.isTriggerEnabled(trigger)) {\n\t\t\tlogger.outgoing.warn(`The trigger \"${ trigger.name }\" is no longer enabled, stopping execution of it at try: ${ tries }`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Starting to execute trigger: ${ trigger.name } (${ trigger._id })`);\n\n\t\tlet word;\n\t\t//Not all triggers/events support triggerWords\n\t\tif (RocketChat.integrations.outgoingEvents[event].use.triggerWords) {\n\t\t\tif (trigger.triggerWords && trigger.triggerWords.length > 0) {\n\t\t\t\tfor (const triggerWord of trigger.triggerWords) {\n\t\t\t\t\tif (!trigger.triggerWordAnywhere && message.msg.indexOf(triggerWord) === 0) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (trigger.triggerWordAnywhere && message.msg.includes(triggerWord)) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Stop if there are triggerWords but none match\n\t\t\t\tif (!word) {\n\t\t\t\t\tlogger.outgoing.debug(`The trigger word which \"${ trigger.name }\" was expecting could not be found, not executing.`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (message && message.editedAt && !trigger.runOnEdits) {\n\t\t\tlogger.outgoing.debug(`The trigger \"${ trigger.name }\"'s run on edits is disabled and the message was edited.`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst historyId = this.updateHistory({ step: 'start-execute-trigger-url', integration: trigger, event });\n\n\t\tconst data = {\n\t\t\ttoken: trigger.token,\n\t\t\tbot: false\n\t\t};\n\n\t\tif (word) {\n\t\t\tdata.trigger_word = word;\n\t\t}\n\n\t\tthis.mapEventArgsToData(data, { trigger, event, message, room, owner, user });\n\t\tthis.updateHistory({ historyId, step: 'mapped-args-to-data', data, triggerWord: word });\n\n\t\tlogger.outgoing.info(`Will be executing the Integration \"${ trigger.name }\" to the url: ${ url }`);\n\t\tlogger.outgoing.debug(data);\n\n\t\tlet opts = {\n\t\t\tparams: {},\n\t\t\tmethod: 'POST',\n\t\t\turl,\n\t\t\tdata,\n\t\t\tauth: undefined,\n\t\t\tnpmRequestOptions: {\n\t\t\t\trejectUnauthorized: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\t\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs')\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\t'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36'\n\t\t\t}\n\t\t};\n\n\t\tif (this.hasScriptAndMethod(trigger, 'prepare_outgoing_request')) {\n\t\t\topts = this.executeScript(trigger, 'prepare_outgoing_request', { request: opts }, historyId);\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'after-maybe-ran-prepare', ranPrepareScript: true });\n\n\t\tif (!opts) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-opts', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tif (opts.message) {\n\t\t\tconst prepareMessage = this.sendMessage({ trigger, room, message: opts.message, data });\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-send-message', prepareSentMessage: prepareMessage });\n\t\t}\n\n\t\tif (!opts.url || !opts.method) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-url_or_method', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'pre-http-call', url: opts.url, httpCallData: opts.data });\n\t\tHTTP.call(opts.method, opts.url, opts, (error, result) => {\n\t\t\tif (!result) {\n\t\t\t\tlogger.outgoing.warn(`Result for the Integration ${ trigger.name } to ${ url } is empty`);\n\t\t\t} else {\n\t\t\t\tlogger.outgoing.info(`Status code for the Integration ${ trigger.name } to ${ url } is ${ result.statusCode }`);\n\t\t\t}\n\n\t\t\tthis.updateHistory({ historyId, step: 'after-http-call', httpError: error, httpResult: result });\n\n\t\t\tif (this.hasScriptAndMethod(trigger, 'process_outgoing_response')) {\n\t\t\t\tconst sandbox = {\n\t\t\t\t\trequest: opts,\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\terror,\n\t\t\t\t\t\tstatus_code: result ? result.statusCode : undefined, //These values will be undefined to close issues #4175, #5762, and #5896\n\t\t\t\t\t\tcontent: result ? result.data : undefined,\n\t\t\t\t\t\tcontent_raw: result ? result.content : undefined,\n\t\t\t\t\t\theaders: result ? result.headers : {}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst scriptResult = this.executeScript(trigger, 'process_outgoing_response', sandbox, historyId);\n\n\t\t\t\tif (scriptResult && scriptResult.content) {\n\t\t\t\t\tconst resultMessage = this.sendMessage({ trigger, room, message: scriptResult.content, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-send-message', processSentMessage: resultMessage, finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (scriptResult === false) {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-false-result', finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if the result contained nothing or wasn't a successful statusCode\n\t\t\tif (!result || !this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(error);\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(result);\n\n\t\t\t\t\tif (result.statusCode === 410) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-410', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Disabling the Integration \"${ trigger.name }\" because the status code was 401 (Gone).`);\n\t\t\t\t\t\tRocketChat.models.Integrations.update({ _id: trigger._id }, { $set: { enabled: false }});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.statusCode === 500) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-500', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Error \"500\" for the Integration \"${ trigger.name }\" to ${ url }.`);\n\t\t\t\t\t\tlogger.outgoing.error(result.content);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (trigger.retryFailedCalls) {\n\t\t\t\t\tif (tries < trigger.retryCount && trigger.retryDelay) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, error: true, step: `going-to-retry-${ tries + 1 }` });\n\n\t\t\t\t\t\tlet waitTime;\n\n\t\t\t\t\t\tswitch (trigger.retryDelay) {\n\t\t\t\t\t\t\tcase 'powers-of-ten':\n\t\t\t\t\t\t\t\t// Try again in 0.1s, 1s, 10s, 1m40s, 16m40s, 2h46m40s, 27h46m40s, etc\n\t\t\t\t\t\t\t\twaitTime = Math.pow(10, tries + 2);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'powers-of-two':\n\t\t\t\t\t\t\t\t// 2 seconds, 4 seconds, 8 seconds\n\t\t\t\t\t\t\t\twaitTime = Math.pow(2, tries + 1) * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'increments-of-two':\n\t\t\t\t\t\t\t\t// 2 second, 4 seconds, 6 seconds, etc\n\t\t\t\t\t\t\t\twaitTime = (tries + 1) * 2 * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tconst er = new Error('The integration\\'s retryDelay setting is invalid.');\n\t\t\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-retry-delay-is-invalid', error: true, errorStack: er.stack });\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlogger.outgoing.info(`Trying the Integration ${ trigger.name } to ${ url } again in ${ waitTime } milliseconds.`);\n\t\t\t\t\t\tMeteor.setTimeout(() => {\n\t\t\t\t\t\t\tthis.executeTriggerUrl(url, trigger, { event, message, room, owner, user }, historyId, tries + 1);\n\t\t\t\t\t\t}, waitTime);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'too-many-retries', error: true });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-not-configured-to-retry', error: true });\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//process outgoing webhook response as a new message\n\t\t\tif (result && this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (result && result.data && (result.data.text || result.data.attachments)) {\n\t\t\t\t\tconst resultMsg = this.sendMessage({ trigger, room, message: result.data, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'url-response-sent-message', resultMessage: resultMsg, finished: true });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\treplay(integration, history) {\n\t\tif (!integration || integration.type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('integration-type-must-be-outgoing', 'The integration type to replay must be an outgoing webhook.');\n\t\t}\n\n\t\tif (!history || !history.data) {\n\t\t\tthrow new Meteor.Error('history-data-must-be-defined', 'The history data must be defined to replay an integration.');\n\t\t}\n\n\t\tconst event = history.event;\n\t\tconst message = RocketChat.models.Messages.findOneById(history.data.message_id);\n\t\tconst room = RocketChat.models.Rooms.findOneById(history.data.channel_id);\n\t\tconst user = RocketChat.models.Users.findOneById(history.data.user_id);\n\t\tlet owner;\n\n\t\tif (history.data.owner && history.data.owner._id) {\n\t\t\towner = RocketChat.models.Users.findOneById(history.data.owner._id);\n\t\t}\n\n\t\tthis.executeTriggerUrl(history.url, integration, { event, message, room, owner, user });\n\t}\n};\n","RocketChat.models.Integrations = new class Integrations extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integrations');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'webhook-incoming' && type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('invalid-type-to-find');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tdisableByUserId(userId) {\n\t\treturn this.update({ userId }, { $set: { enabled: false }}, { multi: true });\n\t}\n};\n","RocketChat.models.IntegrationHistory = new class IntegrationHistory extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integration_history');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'outgoing-webhook' || type !== 'incoming-webhook') {\n\t\t\tthrow new Meteor.Error('invalid-integration-type');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tfindByIntegrationId(id, options) {\n\t\treturn this.find({ 'integration._id': id }, options);\n\t}\n\n\tfindByIntegrationIdAndCreatedBy(id, creatorId, options) {\n\t\treturn this.find({ 'integration._id': id, 'integration._createdBy._id': creatorId }, options);\n\t}\n\n\tfindOneByIntegrationIdAndHistoryId(integrationId, historyId) {\n\t\treturn this.findOne({ 'integration._id': integrationId, _id: historyId });\n\t}\n\n\tfindByEventName(event, options) {\n\t\treturn this.find({ event }, options);\n\t}\n\n\tfindFailed(options) {\n\t\treturn this.find({ error: true }, options);\n\t}\n\n\tremoveByIntegrationId(integrationId) {\n\t\treturn this.remove({ 'integration._id': integrationId });\n\t}\n};\n","Meteor.publish('integrations', function _integrationPublication() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.Integrations.find();\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.Integrations.find({ '_createdBy._id': this.userId });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","Meteor.publish('integrationHistory', function _integrationHistoryPublication(integrationId, limit = 25) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationId(integrationId, { sort: { _updatedAt: -1 }, limit });\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationIdAndCreatedBy(integrationId, this.userId, { sort: { _updatedAt: -1 }, limit });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","/* global Babel */\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\taddIncomingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (!_.isString(integration.channel)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tif (!_.isString(integration.username) || integration.username.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'addIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'addIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({username: integration.username});\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst token = Random.id(48);\n\n\t\tintegration.type = 'webhook-incoming';\n\t\tintegration.token = token;\n\t\tintegration.channel = channels;\n\t\tintegration.userId = user._id;\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","/* global Babel */\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\tupdateIncomingIntegration(integrationId, integration) {\n\t\tif (!_.isString(integration.channel) || integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\t\t\tlet record;\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({ username: currentIntegration.username });\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: channels,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\tdeleteIncomingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields : { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\taddOutgoingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","Meteor.methods({\n\tupdateOutgoingIntegration(integrationId, integration) {\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tevent: integration.event,\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: integration.channel,\n\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\tusername: integration.username,\n\t\t\t\tuserId: integration.userId,\n\t\t\t\turls: integration.urls,\n\t\t\t\ttoken: integration.token,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\treplayOutgoingIntegration({ integrationId, historyId }) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tconst history = RocketChat.models.IntegrationHistory.findOneByIntegrationIdAndHistoryId(integration._id, historyId);\n\n\t\tif (!history) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration-history', 'Invalid Integration History', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.integrations.triggerHandler.replay(integration, history);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tdeleteOutgoingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tclearIntegrationHistory(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","/* globals Api Meteor Restivus logger processWebhookMessage*/\n// TODO: remove globals\nimport vm from 'vm';\nimport moment from 'moment';\n\nconst compiledScripts = {};\nfunction buildSandbox(store = {}) {\n\tconst sandbox = {\n\t\t_,\n\t\ts,\n\t\tconsole,\n\t\tmoment,\n\t\tLivechat: RocketChat.Livechat,\n\t\tStore: {\n\t\t\tset(key, val) {\n\t\t\t\treturn store[key] = val;\n\t\t\t},\n\t\t\tget(key) {\n\t\t\t\treturn store[key];\n\t\t\t}\n\t\t},\n\t\tHTTP(method, url, options) {\n\t\t\ttry {\n\t\t\t\treturn {\n\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\treturn {\n\t\t\t\t\terror\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t};\n\n\tObject.keys(RocketChat.models).filter((k) => !k.startsWith('_')).forEach((k) => sandbox[k] = RocketChat.models[k]);\n\treturn { store, sandbox\t};\n}\n\nfunction getIntegrationScript(integration) {\n\tconst compiledScript = compiledScripts[integration._id];\n\tif ((compiledScript != null) && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\treturn compiledScript.script;\n\t}\n\tconst script = integration.scriptCompiled;\n\tconst {sandbox, store} = buildSandbox();\n\ttry {\n\t\tlogger.incoming.info('Will evaluate script of Trigger', integration.name);\n\t\tlogger.incoming.debug(script);\n\t\tconst vmScript = vm.createScript(script, 'script.js');\n\t\tvmScript.runInNewContext(sandbox);\n\t\tif (sandbox.Script != null) {\n\t\t\tcompiledScripts[integration._id] = {\n\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\tstore,\n\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t};\n\t\t\treturn compiledScripts[integration._id].script;\n\t\t}\n\t} catch ({stack}) {\n\t\tlogger.incoming.error('[Error evaluating Script in Trigger', integration.name, ':]');\n\t\tlogger.incoming.error(script.replace(/^/gm, '  '));\n\t\tlogger.incoming.error('[Stack:]');\n\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\tthrow RocketChat.API.v1.failure('error-evaluating-script');\n\t}\n\tif (sandbox.Script == null) {\n\t\tlogger.incoming.error('[Class \"Script\" not in Trigger', integration.name, ']');\n\t\tthrow RocketChat.API.v1.failure('class-script-not-found');\n\t}\n}\n\nApi = new Restivus({\n\tenableCors: true,\n\tapiPath: 'hooks/',\n\tauth: {\n\t\tuser() {\n\t\t\tconst payloadKeys = Object.keys(this.bodyParams);\n\t\t\tconst payloadIsWrapped = (this.bodyParams && this.bodyParams.payload) && payloadKeys.length === 1;\n\t\t\tif (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n\t\t\t\ttry {\n\t\t\t\t\tthis.bodyParams = JSON.parse(this.bodyParams.payload);\n\t\t\t\t} catch ({message}) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tstatusCode: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\terror: message\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.integration = RocketChat.models.Integrations.findOne({\n\t\t\t\t_id: this.request.params.integrationId,\n\t\t\t\ttoken: decodeURIComponent(this.request.params.token)\n\t\t\t});\n\t\t\tif (this.integration == null) {\n\t\t\t\tlogger.incoming.info('Invalid integration id', this.request.params.integrationId, 'or token', this.request.params.token);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst user = RocketChat.models.Users.findOne({\n\t\t\t\t_id: this.integration.userId\n\t\t\t});\n\t\t\treturn {user};\n\t\t}\n\t}\n});\n\nfunction createIntegration(options, user) {\n\tlogger.incoming.info('Add integration', options.name);\n\tlogger.incoming.debug(options);\n\tMeteor.runAsUser(user._id, function() {\n\t\tswitch (options['event']) {\n\t\t\tcase 'newMessageOnChannel':\n\t\t\t\tif (options.data == null) {\n\t\t\t\t\toptions.data = {};\n\t\t\t\t}\n\t\t\t\tif ((options.data.channel_name != null) && options.data.channel_name.indexOf('#') === -1) {\n\t\t\t\t\toptions.data.channel_name = `#${ options.data.channel_name }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.channel_name,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t\tcase 'newMessageToUser':\n\t\t\t\tif (options.data.username.indexOf('@') === -1) {\n\t\t\t\t\toptions.data.username = `@${ options.data.username }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.username,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t}\n\t});\n\treturn RocketChat.API.v1.success();\n}\n\nfunction removeIntegration(options, user) {\n\tlogger.incoming.info('Remove integration');\n\tlogger.incoming.debug(options);\n\tconst integrationToRemove = RocketChat.models.Integrations.findOne({\n\t\turls: options.target_url\n\t});\n\tMeteor.runAsUser(user._id, () => {\n\t\treturn Meteor.call('deleteOutgoingIntegration', integrationToRemove._id);\n\t});\n\treturn RocketChat.API.v1.success();\n}\n\nfunction executeIntegrationRest() {\n\tlogger.incoming.info('Post integration:', this.integration.name);\n\tlogger.incoming.debug('@urlParams:', this.urlParams);\n\tlogger.incoming.debug('@bodyParams:', this.bodyParams);\n\tif (this.integration.enabled !== true) {\n\t\treturn {\n\t\t\tstatusCode: 503,\n\t\t\tbody: 'Service Unavailable'\n\t\t};\n\t}\n\tconst defaultValues = {\n\t\tchannel: this.integration.channel,\n\t\talias: this.integration.alias,\n\t\tavatar: this.integration.avatar,\n\t\temoji: this.integration.emoji\n\t};\n\tif (this.integration.scriptEnabled === true && this.integration.scriptCompiled && this.integration.scriptCompiled.trim() !== '') {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = getIntegrationScript(this.integration);\n\t\t} catch (e) {\n\t\t\tlogger.incoming.warn(e);\n\t\t\treturn RocketChat.API.v1.failure(e.message);\n\t\t}\n\t\tconst request = {\n\t\t\turl: {\n\t\t\t\thash: this.request._parsedUrl.hash,\n\t\t\t\tsearch: this.request._parsedUrl.search,\n\t\t\t\tquery: this.queryParams,\n\t\t\t\tpathname: this.request._parsedUrl.pathname,\n\t\t\t\tpath: this.request._parsedUrl.path\n\t\t\t},\n\t\t\turl_raw: this.request.url,\n\t\t\turl_params: this.urlParams,\n\t\t\tcontent: this.bodyParams,\n\t\t\tcontent_raw: this.request._readableState && this.request._readableState.buffer && this.request._readableState.buffer.toString(),\n\t\t\theaders: this.request.headers,\n\t\t\tuser: {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name,\n\t\t\t\tusername: this.user.username\n\t\t\t}\n\t\t};\n\t\ttry {\n\t\t\tconst {sandbox} = buildSandbox(compiledScripts[this.integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.request = request;\n\t\t\tconst result = vm.runInNewContext('script.process_incoming_request({ request: request })', sandbox, {\n\t\t\t\ttimeout: 3000\n\t\t\t});\n\t\t\tif (result && result.error) {\n\t\t\t\treturn RocketChat.API.v1.failure(result.error);\n\t\t\t}\n\t\t\tthis.bodyParams = result && result.content;\n\t\t\tif (typeof result !== 'undefined') {\n\t\t\t\tthis.scriptResponse = result.response;\n\t\t\t\tif (result.user) {\n\t\t\t\t\tthis.user = result.user;\n\t\t\t\t}\n\t\t\t}\n\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.debug('result', this.bodyParams);\n\t\t} catch ({stack}) {\n\t\t\tlogger.incoming.error('[Error running Script in Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.error(this.integration.scriptCompiled.replace(/^/gm, '  '));\n\t\t\tlogger.incoming.error('[Stack:]');\n\t\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\t\treturn RocketChat.API.v1.failure('error-running-script');\n\t\t}\n\t}\n\tif (this.bodyParams == null) {\n\t\treturn RocketChat.API.v1.failure('body-empty');\n\t}\n\tthis.bodyParams.bot = {\n\t\ti: this.integration._id\n\t};\n\ttry {\n\t\tconst message = processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\t\tif (_.isEmpty(message)) {\n\t\t\treturn RocketChat.API.v1.failure('unknown-error');\n\t\t}\n\t\tif (this.scriptResponse) {\n\t\t\tlogger.incoming.debug('response', this.scriptResponse);\n\t\t}\n\t\treturn RocketChat.API.v1.success(this.scriptResponse);\n\t} catch ({error}) {\n\t\treturn RocketChat.API.v1.failure(error);\n\t}\n}\n\nfunction addIntegrationRest() {\n\treturn createIntegration(this.bodyParams, this.user);\n}\n\nfunction removeIntegrationRest() {\n\treturn removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n\tlogger.incoming.info('Sample Integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: [\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 1',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 2',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 3',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}\n\t\t]\n\t};\n}\n\nfunction integrationInfoRest() {\n\tlogger.incoming.info('Info integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: {\n\t\t\tsuccess: true\n\t\t}\n\t};\n}\n\nApi.addRoute(':integrationId/:userId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute(':integrationId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute('sample/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('sample/:integrationId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('info/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('info/:integrationId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('add/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('add/:integrationId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n","const callbackHandler = function _callbackHandler(eventType) {\n\treturn function _wrapperFunction() {\n\t\treturn RocketChat.integrations.triggerHandler.executeTriggers(eventType, ...arguments);\n\t};\n};\n\nRocketChat.callbacks.add('afterSaveMessage', callbackHandler('sendMessage'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateChannel', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreatePrivateGroup', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateUser', callbackHandler('userCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterJoinRoom', callbackHandler('roomJoined'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterLeaveRoom', callbackHandler('roomLeft'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterRoomArchived', callbackHandler('roomArchived'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterFileUpload', callbackHandler('fileUploaded'), RocketChat.callbacks.priority.LOW);\n","this.processWebhookMessage = function(messageObj, user, defaultValues = { channel: '', alias: '', avatar: '', emoji: '' }) {\n\tconst sentData = [];\n\tconst channels = [].concat(messageObj.channel || messageObj.roomId || defaultValues.channel);\n\n\tfor (const channel of channels) {\n\t\tconst channelType = channel[0];\n\n\t\tlet channelValue = channel.substr(1);\n\t\tlet room;\n\n\t\tswitch (channelType) {\n\t\t\tcase '#':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true });\n\t\t\t\tbreak;\n\t\t\tcase '@':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd' });\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tchannelValue = channelType + channelValue;\n\n\t\t\t\t//Try to find the room by id or name if they didn't include the prefix.\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true, errorOnEmpty: false });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//We didn't get a room, let's try finding direct messages\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd', tryDirectByUserIdOnly: true });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//No room, so throw an error\n\t\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\n\t\tif (messageObj.attachments && !_.isArray(messageObj.attachments)) {\n\t\t\tconsole.log('Attachments should be Array, ignoring value'.red, messageObj.attachments);\n\t\t\tmessageObj.attachments = undefined;\n\t\t}\n\n\t\tconst message = {\n\t\t\talias: messageObj.username || messageObj.alias || defaultValues.alias,\n\t\t\tmsg: _.trim(messageObj.text || messageObj.msg || ''),\n\t\t\tattachments: messageObj.attachments,\n\t\t\tparseUrls: messageObj.parseUrls !== undefined ? messageObj.parseUrls : !messageObj.attachments,\n\t\t\tbot: messageObj.bot,\n\t\t\tgroupable: (messageObj.groupable !== undefined) ? messageObj.groupable : false\n\t\t};\n\n\t\tif (!_.isEmpty(messageObj.icon_url) || !_.isEmpty(messageObj.avatar)) {\n\t\t\tmessage.avatar = messageObj.icon_url || messageObj.avatar;\n\t\t} else if (!_.isEmpty(messageObj.icon_emoji) || !_.isEmpty(messageObj.emoji)) {\n\t\t\tmessage.emoji = messageObj.icon_emoji || messageObj.emoji;\n\t\t} else if (!_.isEmpty(defaultValues.avatar)) {\n\t\t\tmessage.avatar = defaultValues.avatar;\n\t\t} else if (!_.isEmpty(defaultValues.emoji)) {\n\t\t\tmessage.emoji = defaultValues.emoji;\n\t\t}\n\n\t\tif (_.isArray(message.attachments)) {\n\t\t\tfor (let i = 0; i < message.attachments.length; i++) {\n\t\t\t\tconst attachment = message.attachments[i];\n\t\t\t\tif (attachment.msg) {\n\t\t\t\t\tattachment.text = _.trim(attachment.msg);\n\t\t\t\t\tdelete attachment.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst messageReturn = RocketChat.sendMessage(user, message, room);\n\t\tsentData.push({ channel, message: messageReturn });\n\t}\n\n\treturn sentData;\n};\n"]}