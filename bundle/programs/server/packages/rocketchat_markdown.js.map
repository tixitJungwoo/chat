{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:markdown/settings.js","meteor://ðŸ’»app/packages/rocketchat:markdown/markdown.js","meteor://ðŸ’»app/packages/rocketchat:markdown/markdowncode.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","i18nDescription","MarkdownClass","parse","text","parseNotEscaped","_","escapeHTML","msg","schemes","get","split","join","replace","RegExp","match","title","url","target","indexOf","absoluteUrl","window","rocketDebug","undefined","console","log","Markdown","MarkdownMessage","message","trim","html","callbacks","priority","HIGH","isClient","Blaze","registerHelper","hljs","module","watch","require","v","MarkdownCode","s","tokens","handle_codeblocks","handle_inlinecode","p1","p2","p3","token","Random","id","push","noHtml","count","length","msgParts","index","part","codeMatch","code","lang","result","singleLine","unescapeHTML","Array","from","listLanguages","includes","highlightAuto","highlight","language","value","stripTags","MarkdownCodeCB"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,OAAP,CAAe,YAAM;AACpBC,YAAWC,QAAX,CAAoBC,GAApB,CAAwB,kBAAxB,EAA4C,KAA5C,EAAmD;AAClDC,QAAM,SAD4C;AAElDC,SAAO,SAF2C;AAGlDC,WAAS,UAHyC;AAIlD,YAAQ;AAJ0C,EAAnD;AAOA,QAAOL,WAAWC,QAAX,CAAoBC,GAApB,CAAwB,gCAAxB,EAA0D,YAA1D,EAAwE;AAC9EC,QAAM,QADwE;AAE9EC,SAAO,SAFuE;AAG9EC,WAAS,UAHqE;AAI9E,YAAQ,IAJsE;AAK9EC,mBAAiB;AAL6D,EAAxE,CAAP;AAOA,CAfD,2H;;;;;;;;;;;;;;;;;ACAA;;;OAKMC,a;;;;;yBACLC,K;iBAAMC,I,EAAM;AACX,UAAO,KAAKC,eAAL,CAAqBC,EAAEC,UAAF,CAAaH,IAAb,CAArB,CAAP;AACA;;;;;yBAEDC,e;2BAAgBG,G,EAAK;AACpB,OAAMC,UAAUd,WAAWC,QAAX,CAAoBc,GAApB,CAAwB,gCAAxB,EAA0DC,KAA1D,CAAgE,GAAhE,EAAqEC,IAArE,CAA0E,GAA1E,CAAhB,CADoB,CAGpB;;AACAJ,SAAMA,IAAIK,OAAJ,CAAY,IAAIC,MAAJ,6BAAsCL,OAAtC,0BAAqE,IAArE,CAAZ,EAAwF,UAASM,KAAT,EAAgBC,KAAhB,EAAuBC,GAAvB,EAA4B;AACzH,QAAMC,SAASD,IAAIE,OAAJ,CAAY1B,OAAO2B,WAAP,EAAZ,MAAsC,CAAtC,GAA0C,EAA1C,GAA+C,QAA9D;AACA,0BAAoBd,EAAEC,UAAF,CAAaU,GAAb,CAApB,mBAAmDX,EAAEC,UAAF,CAAaS,KAAb,CAAnD,oBAAqFV,EAAEC,UAAF,CAAaW,MAAb,CAArF,qEAAuKZ,EAAEC,UAAF,CAAaU,GAAb,CAAvK;AACA,IAHK,CAAN,CAJoB,CASpB;;AACAT,SAAMA,IAAIK,OAAJ,CAAY,IAAIC,MAAJ,4BAAqCL,OAArC,0BAAoE,IAApE,CAAZ,EAAuF,UAASM,KAAT,EAAgBC,KAAhB,EAAuBC,GAAvB,EAA4B;AACxH,QAAMC,SAASD,IAAIE,OAAJ,CAAY1B,OAAO2B,WAAP,EAAZ,MAAsC,CAAtC,GAA0C,EAA1C,GAA+C,QAA9D;AACA,0BAAoBd,EAAEC,UAAF,CAAaU,GAAb,CAApB,oBAAoDX,EAAEC,UAAF,CAAaW,MAAb,CAApD,WAA+EZ,EAAEC,UAAF,CAAaS,KAAb,CAA/E;AACA,IAHK,CAAN,CAVoB,CAepB;;AACAR,SAAMA,IAAIK,OAAJ,CAAY,IAAIC,MAAJ,oBAA6BL,OAA7B,mDAAqF,IAArF,CAAZ,EAAwG,UAACM,KAAD,EAAQE,GAAR,EAAaD,KAAb,EAAuB;AACpI,QAAME,SAASD,IAAIE,OAAJ,CAAY1B,OAAO2B,WAAP,EAAZ,MAAsC,CAAtC,GAA0C,EAA1C,GAA+C,QAA9D;AACA,0BAAoBd,EAAEC,UAAF,CAAaU,GAAb,CAApB,oBAAoDX,EAAEC,UAAF,CAAaW,MAAb,CAApD,WAA+EZ,EAAEC,UAAF,CAAaS,KAAb,CAA/E;AACA,IAHK,CAAN;;AAKA,OAAIrB,WAAWC,QAAX,CAAoBc,GAApB,CAAwB,kBAAxB,CAAJ,EAAiD;AAChD;AACAF,UAAMA,IAAIK,OAAJ,CAAY,sGAAZ,EAAoH,aAApH,CAAN,CAFgD,CAIhD;;AACAL,UAAMA,IAAIK,OAAJ,CAAY,uGAAZ,EAAqH,aAArH,CAAN,CALgD,CAOhD;;AACAL,UAAMA,IAAIK,OAAJ,CAAY,wGAAZ,EAAsH,aAAtH,CAAN,CARgD,CAUhD;;AACAL,UAAMA,IAAIK,OAAJ,CAAY,yGAAZ,EAAuH,aAAvH,CAAN;AACA,IAjCmB,CAmCpB;;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,8DAAZ,EAA4E,uFAA5E,CAAN,CApCoB,CAsCpB;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,oDAAZ,EAAkE,+EAAlE,CAAN,CAvCoB,CAyCpB;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,6DAAZ,EAA2E,uFAA3E,CAAN,CA1CoB,CA4CpB;AACA;AACA;AACA;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,yCAAZ,EAAuD,8JAAvD,CAAN,CAhDoB,CAkDpB;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,cAAZ,EAA4B,4GAA5B,CAAN,CAnDoB,CAqDpB;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,gEAAZ,EAA8E,2DAA9E,CAAN;AACAL,SAAMA,IAAIK,OAAJ,CAAY,qBAAZ,EAAmC,eAAnC,CAAN,CAvDoB,CAyDpB;;AACAL,SAAMA,IAAIK,OAAJ,CAAY,+BAAZ,EAA6C,0BAA7C,CAAN;;AAEA,OAAI,OAAOQ,MAAP,KAAkB,WAAlB,IAAiCA,WAAW,IAA5C,GAAmDA,OAAOC,WAA1D,GAAwEC,SAA5E,EAAuF;AAAEC,YAAQC,GAAR,CAAY,UAAZ,EAAwBjB,GAAxB;AAA+B;;AAExH,UAAOA,GAAP;AACA;;;;;;;;AAGF,IAAMkB,WAAW,IAAIxB,aAAJ,EAAjB;AACAP,WAAW+B,QAAX,GAAsBA,QAAtB,C,CAEA;;AACA,IAAMC,kBAAkB,UAACC,OAAD,EAAa;AACpC,KAAItB,EAAEuB,IAAF,CAAOD,WAAW,IAAX,GAAkBA,QAAQE,IAA1B,GAAiCP,SAAxC,CAAJ,EAAwD;AACvDK,UAAQE,IAAR,GAAeJ,SAASrB,eAAT,CAAyBuB,QAAQE,IAAjC,CAAf;AACA;;AAED,QAAOF,OAAP;AACA,CAND;;AAQAjC,WAAWoC,SAAX,CAAqBlC,GAArB,CAAyB,eAAzB,EAA0C8B,eAA1C,EAA2DhC,WAAWoC,SAAX,CAAqBC,QAArB,CAA8BC,IAAzF,EAA+F,UAA/F;;AAEA,IAAIxC,OAAOyC,QAAX,EAAqB;AACpBC,OAAMC,cAAN,CAAqB,oBAArB,EAA2C;AAAA,SAAQV,SAASvB,KAAT,CAAeC,IAAf,CAAR;AAAA,EAA3C;AACA,4H;;;;;;;;;;;;;;;;;AC5FD,IAAIiC,aAAJ;AAASC,OAAOC,KAAP,CAAaC,QAAQ,cAAR,CAAb,EAAqC;AAAA,sBAASC,CAAT,EAAW;AAACJ,SAAKI,CAAL;AAAO;AAAnB,CAArC,EAA0D,CAA1D;;IAMHC,Y;AACL,uBAAYd,OAAZ,EAAqB;AAAA;;AAEpB,MAAIe,EAAEd,IAAF,CAAOD,QAAQE,IAAf,CAAJ,EAA0B;AACzB,OAAIF,QAAQgB,MAAR,IAAkB,IAAtB,EAA4B;AAC3BhB,YAAQgB,MAAR,GAAiB,EAAjB;AACA;;AAEDF,gBAAaG,iBAAb,CAA+BjB,OAA/B;AACAc,gBAAaI,iBAAb,CAA+BlB,OAA/B;;AAEA,OAAIP,UAAUA,OAAOC,WAArB,EAAkC;AACjCE,YAAQC,GAAR,CAAY,UAAZ,EAAwBG,OAAxB;AACA;AACD;;AAED,SAAOA,OAAP;AACA;;cAEMkB,iB;6BAAkBlB,O,EAAS;AACjC;AACA,UAAOA,QAAQE,IAAR,GAAeF,QAAQE,IAAR,CAAajB,OAAb,CAAqB,mDAArB,EAA0E,UAACE,KAAD,EAAQgC,EAAR,EAAYC,EAAZ,EAAgBC,EAAhB,EAAuB;AACtH,QAAMC,gBAAeC,OAAOC,EAAP,EAAf,QAAN;AAEAxB,YAAQgB,MAAR,CAAeS,IAAf,CAAoB;AACnBH,iBADmB;AAEnB9C,WAAU2C,EAAV,kFAA4FC,EAA5F,uDAAmJC,EAFhI;AAGnBK,aAAQvC;AAHW,KAApB;AAMA,WAAOmC,KAAP;AACA,IAVqB,CAAtB;AAWA;;;;;cAEML,iB;6BAAkBjB,O,EAAS;AACjC;AACA,OAAM2B,QAAQ,CAAC3B,QAAQE,IAAR,CAAaf,KAAb,CAAmB,MAAnB,KAA8B,EAA/B,EAAmCyC,MAAjD;;AAEA,OAAID,KAAJ,EAAW;AAEV;AACA,QAAKA,QAAQ,CAAT,GAAc,CAAlB,EAAqB;AACpB3B,aAAQE,IAAR,GAAmBF,QAAQE,IAA3B;AACAF,aAAQpB,GAAR,GAAkBoB,QAAQpB,GAA1B;AACA,KANS,CAQV;;;AACA,QAAMiD,WAAW7B,QAAQE,IAAR,CAAanB,KAAb,CAAmB,qDAAnB,CAAjB;;AAEA,SAAK,IAAI+C,QAAQ,CAAjB,EAAoBA,QAAQD,SAASD,MAArC,EAA6CE,OAA7C,EAAsD;AACrD;AACA,SAAMC,OAAOF,SAASC,KAAT,CAAb;AACA,SAAME,YAAYD,KAAK5C,KAAL,CAAW,iCAAX,CAAlB;;AAEA,SAAI6C,aAAa,IAAjB,EAAuB;AACtB;AACA,UAAIC,aAAJ;AACA,UAAIC,aAAJ;AACA,UAAIC,eAAJ;AACA,UAAMC,aAAaJ,UAAU,CAAV,EAAazC,OAAb,CAAqB,IAArB,MAA+B,CAAC,CAAnD;;AAEA,UAAI6C,UAAJ,EAAgB;AACfF,cAAO,EAAP;AACAD,cAAOvD,EAAE2D,YAAF,CAAeL,UAAU,CAAV,IAAeA,UAAU,CAAV,CAA9B,CAAP;AACA,OAHD,MAGO;AACNE,cAAOF,UAAU,CAAV,CAAP;AACAC,cAAOvD,EAAE2D,YAAF,CAAeL,UAAU,CAAV,CAAf,CAAP;AACA;;AAED,UAAIjB,EAAEd,IAAF,CAAOiC,IAAP,MAAiB,EAArB,EAAyB;AACxBA,cAAO,EAAP;AACA;;AAED,UAAI,CAACI,MAAMC,IAAN,CAAW9B,KAAK+B,aAAL,EAAX,EAAiCC,QAAjC,CAA0C1B,EAAEd,IAAF,CAAOiC,IAAP,CAA1C,CAAL,EAA8D;AAC7DC,gBAAS1B,KAAKiC,aAAL,CAAoBR,OAAOD,IAA3B,CAAT;AACA,OAFD,MAEO;AACNE,gBAAS1B,KAAKkC,SAAL,CAAe5B,EAAEd,IAAF,CAAOiC,IAAP,CAAf,EAA6BD,IAA7B,CAAT;AACA;;AAED,UAAMX,gBAAeC,OAAOC,EAAP,EAAf,QAAN;AAEAxB,cAAQgB,MAAR,CAAeS,IAAf,CAAoB;AACnBkB,kBAAW,IADQ;AAEnBrB,mBAFmB;AAGnB9C,qDAA6C2D,OAAOS,QAApD,+CAA2GT,OAAOU,KAAlH,uDAHmB;AAInBnB,yBAAoBX,EAAE+B,SAAF,CAAYX,OAAOU,KAAnB,CAApB;AAJmB,OAApB;AAOAhB,eAASC,KAAT,IAAkBR,KAAlB;AACA,MAnCD,MAmCO;AACNO,eAASC,KAAT,IAAkBC,IAAlB;AACA;AACD,KAtDS,CAwDV;;;AACA,WAAO/B,QAAQE,IAAR,GAAe2B,SAAS7C,IAAT,CAAc,EAAd,CAAtB;AACA;AACD;;;;;;;;AAGFjB,WAAW+C,YAAX,GAA0BA,YAA1B;;AAEA,IAAMiC,iBAAiB,UAAC/C,OAAD;AAAA,QAAa,IAAIc,YAAJ,CAAiBd,OAAjB,CAAb;AAAA,CAAvB,C,CAEA;;;AACAjC,WAAWoC,SAAX,CAAqBlC,GAArB,CAAyB,eAAzB,EAA0C8E,cAA1C,EAA0DhF,WAAWoC,SAAX,CAAqBC,QAArB,CAA8BC,IAA9B,GAAqC,CAA/F,EAAkG,cAAlG,a","file":"/packages/rocketchat_markdown.js","sourcesContent":["Meteor.startup(() => {\n\tRocketChat.settings.add('Markdown_Headers', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Message',\n\t\tsection: 'Markdown',\n\t\tpublic: true\n\t});\n\n\treturn RocketChat.settings.add('Markdown_SupportSchemesForLink', 'http,https', {\n\t\ttype: 'string',\n\t\tgroup: 'Message',\n\t\tsection: 'Markdown',\n\t\tpublic: true,\n\t\ti18nDescription: 'Markdown_SupportSchemesForLink_Description'\n\t});\n});\n","/*\n * Markdown is a named function that will parse markdown syntax\n * @param {Object} message - The message object\n */\n\nclass MarkdownClass {\n\tparse(text) {\n\t\treturn this.parseNotEscaped(_.escapeHTML(text));\n\t}\n\n\tparseNotEscaped(msg) {\n\t\tconst schemes = RocketChat.settings.get('Markdown_SupportSchemesForLink').split(',').join('|');\n\n\t\t// Support ![alt text](http://image url)\n\t\tmsg = msg.replace(new RegExp(`!\\\\[([^\\\\]]+)\\\\]\\\\(((?:${ schemes }):\\\\/\\\\/[^\\\\)]+)\\\\)`, 'gm'), function(match, title, url) {\n\t\t\tconst target = url.indexOf(Meteor.absoluteUrl()) === 0 ? '' : '_blank';\n\t\t\treturn `<a href=\"${ _.escapeHTML(url) }\" title=\"${ _.escapeHTML(title) }\" target=\"${ _.escapeHTML(target) }\"><div class=\"inline-image\" style=\"background-image: url(${ _.escapeHTML(url) });\"></div></a>`;\n\t\t});\n\n\t\t// Support [Text](http://link)\n\t\tmsg = msg.replace(new RegExp(`\\\\[([^\\\\]]+)\\\\]\\\\(((?:${ schemes }):\\\\/\\\\/[^\\\\)]+)\\\\)`, 'gm'), function(match, title, url) {\n\t\t\tconst target = url.indexOf(Meteor.absoluteUrl()) === 0 ? '' : '_blank';\n\t\t\treturn `<a href=\"${ _.escapeHTML(url) }\" target=\"${ _.escapeHTML(target) }\">${ _.escapeHTML(title) }</a>`;\n\t\t});\n\n\t\t// Support <http://link|Text>\n\t\tmsg = msg.replace(new RegExp(`(?:<|&lt;)((?:${ schemes }):\\\\/\\\\/[^\\\\|]+)\\\\|(.+?)(?=>|&gt;)(?:>|&gt;)`, 'gm'), (match, url, title) => {\n\t\t\tconst target = url.indexOf(Meteor.absoluteUrl()) === 0 ? '' : '_blank';\n\t\t\treturn `<a href=\"${ _.escapeHTML(url) }\" target=\"${ _.escapeHTML(target) }\">${ _.escapeHTML(title) }</a>`;\n\t\t});\n\n\t\tif (RocketChat.settings.get('Markdown_Headers')) {\n\t\t\t// Support # Text for h1\n\t\t\tmsg = msg.replace(/^# (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h1>$1</h1>');\n\n\t\t\t// Support # Text for h2\n\t\t\tmsg = msg.replace(/^## (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h2>$1</h2>');\n\n\t\t\t// Support # Text for h3\n\t\t\tmsg = msg.replace(/^### (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h3>$1</h3>');\n\n\t\t\t// Support # Text for h4\n\t\t\tmsg = msg.replace(/^#### (([\\S\\w\\d-_\\/\\*\\.,\\\\][ \\u00a0\\u1680\\u180e\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000\\ufeff]?)+)/gm, '<h4>$1</h4>');\n\t\t}\n\n\t\t// Support *text* to make bold\n\t\tmsg = msg.replace(/(^|&gt;|[ >_~`])\\*{1,2}([^\\*\\r\\n]+)\\*{1,2}([<_~`]|\\B|\\b|$)/gm, '$1<span class=\"copyonly\">*</span><strong>$2</strong><span class=\"copyonly\">*</span>$3');\n\n\t\t// Support _text_ to make italics\n\t\tmsg = msg.replace(/(^|&gt;|[ >*~`])\\_([^\\_\\r\\n]+)\\_([<*~`]|\\B|\\b|$)/gm, '$1<span class=\"copyonly\">_</span><em>$2</em><span class=\"copyonly\">_</span>$3');\n\n\t\t// Support ~text~ to strike through text\n\t\tmsg = msg.replace(/(^|&gt;|[ >_*`])\\~{1,2}([^~\\r\\n]+)\\~{1,2}([<_*`]|\\B|\\b|$)/gm, '$1<span class=\"copyonly\">~</span><strike>$2</strike><span class=\"copyonly\">~</span>$3');\n\n\t\t// Support for block quote\n\t\t// >>>\n\t\t// Text\n\t\t// <<<\n\t\tmsg = msg.replace(/(?:&gt;){3}\\n+([\\s\\S]*?)\\n+(?:&lt;){3}/g, '<blockquote class=\"background-transparent-darker-before\"><span class=\"copyonly\">&gt;&gt;&gt;</span>$1<span class=\"copyonly\">&lt;&lt;&lt;</span></blockquote>');\n\n\t\t// Support >Text for quote\n\t\tmsg = msg.replace(/^&gt;(.*)$/gm, '<blockquote class=\"background-transparent-darker-before\"><span class=\"copyonly\">&gt;</span>$1</blockquote>');\n\n\t\t// Remove white-space around blockquote (prevent <br>). Because blockquote is block element.\n\t\tmsg = msg.replace(/\\s*<blockquote class=\"background-transparent-darker-before\">/gm, '<blockquote class=\"background-transparent-darker-before\">');\n\t\tmsg = msg.replace(/<\\/blockquote>\\s*/gm, '</blockquote>');\n\n\t\t// Remove new-line between blockquotes.\n\t\tmsg = msg.replace(/<\\/blockquote>\\n<blockquote/gm, '</blockquote><blockquote');\n\n\t\tif (typeof window !== 'undefined' && window !== null ? window.rocketDebug : undefined) { console.log('Markdown', msg); }\n\n\t\treturn msg;\n\t}\n}\n\nconst Markdown = new MarkdownClass;\nRocketChat.Markdown = Markdown;\n\n// renderMessage already did html escape\nconst MarkdownMessage = (message) => {\n\tif (_.trim(message != null ? message.html : undefined)) {\n\t\tmessage.html = Markdown.parseNotEscaped(message.html);\n\t}\n\n\treturn message;\n};\n\nRocketChat.callbacks.add('renderMessage', MarkdownMessage, RocketChat.callbacks.priority.HIGH, 'markdown');\n\nif (Meteor.isClient) {\n\tBlaze.registerHelper('RocketChatMarkdown', text => Markdown.parse(text));\n}\n","/*\n * MarkdownCode is a named function that will parse `inline code` and ```codeblock``` syntaxes\n * @param {Object} message - The message object\n */\nimport hljs from 'highlight.js';\n\nclass MarkdownCode {\n\tconstructor(message) {\n\n\t\tif (s.trim(message.html)) {\n\t\t\tif (message.tokens == null) {\n\t\t\t\tmessage.tokens = [];\n\t\t\t}\n\n\t\t\tMarkdownCode.handle_codeblocks(message);\n\t\t\tMarkdownCode.handle_inlinecode(message);\n\n\t\t\tif (window && window.rocketDebug) {\n\t\t\t\tconsole.log('Markdown', message);\n\t\t\t}\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tstatic handle_inlinecode(message) {\n\t\t// Support `text`\n\t\treturn message.html = message.html.replace(/(^|&gt;|[ >_*~])\\`([^`\\r\\n]+)\\`([<_*~]|\\B|\\b|$)/gm, (match, p1, p2, p3) => {\n\t\t\tconst token = `=!=${ Random.id() }=!=`;\n\n\t\t\tmessage.tokens.push({\n\t\t\t\ttoken,\n\t\t\t\ttext: `${ p1 }<span class=\\\"copyonly\\\">\\`</span><span><code class=\\\"code-colors inline\\\">${ p2 }</code></span><span class=\\\"copyonly\\\">\\`</span>${ p3 }`,\n\t\t\t\tnoHtml: match\n\t\t\t});\n\n\t\t\treturn token;\n\t\t});\n\t}\n\n\tstatic handle_codeblocks(message) {\n\t\t// Count occurencies of ```\n\t\tconst count = (message.html.match(/```/g) || []).length;\n\n\t\tif (count) {\n\n\t\t\t// Check if we need to add a final ```\n\t\t\tif ((count % 2) > 0) {\n\t\t\t\tmessage.html = `${ message.html }\\n\\`\\`\\``;\n\t\t\t\tmessage.msg = `${ message.msg }\\n\\`\\`\\``;\n\t\t\t}\n\n\t\t\t// Separate text in code blocks and non code blocks\n\t\t\tconst msgParts = message.html.split(/(^.*)(```(?:[a-zA-Z]+)?(?:(?:.|\\n)*?)```)(.*\\n?)$/gm);\n\n\t\t\tfor (let index = 0; index < msgParts.length; index++) {\n\t\t\t\t// Verify if this part is code\n\t\t\t\tconst part = msgParts[index];\n\t\t\t\tconst codeMatch = part.match(/^```(.*[\\n\\ ]?)([\\s\\S]*?)```+?$/);\n\n\t\t\t\tif (codeMatch != null) {\n\t\t\t\t\t// Process highlight if this part is code\n\t\t\t\t\tlet code;\n\t\t\t\t\tlet lang;\n\t\t\t\t\tlet result;\n\t\t\t\t\tconst singleLine = codeMatch[0].indexOf('\\n') === -1;\n\n\t\t\t\t\tif (singleLine) {\n\t\t\t\t\t\tlang = '';\n\t\t\t\t\t\tcode = _.unescapeHTML(codeMatch[1] + codeMatch[2]);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlang = codeMatch[1];\n\t\t\t\t\t\tcode = _.unescapeHTML(codeMatch[2]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (s.trim(lang) === '') {\n\t\t\t\t\t\tlang = '';\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!Array.from(hljs.listLanguages()).includes(s.trim(lang))) {\n\t\t\t\t\t\tresult = hljs.highlightAuto((lang + code));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult = hljs.highlight(s.trim(lang), code);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst token = `=!=${ Random.id() }=!=`;\n\n\t\t\t\t\tmessage.tokens.push({\n\t\t\t\t\t\thighlight: true,\n\t\t\t\t\t\ttoken,\n\t\t\t\t\t\ttext: `<pre><code class='code-colors hljs ${ result.language }'><span class='copyonly'>\\`\\`\\`<br></span>${ result.value }<span class='copyonly'><br>\\`\\`\\`</span></code></pre>`,\n\t\t\t\t\t\tnoHtml: `\\`\\`\\`\\n${ s.stripTags(result.value) }\\n\\`\\`\\``\n\t\t\t\t\t});\n\n\t\t\t\t\tmsgParts[index] = token;\n\t\t\t\t} else {\n\t\t\t\t\tmsgParts[index] = part;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Re-mount message\n\t\t\treturn message.html = msgParts.join('');\n\t\t}\n\t}\n}\n\nRocketChat.MarkdownCode = MarkdownCode;\n\nconst MarkdownCodeCB = (message) => new MarkdownCode(message);\n\n// MarkdownCode gets higher priority over Markdown so it's possible place a callback in between (katex for exmaple)\nRocketChat.callbacks.add('renderMessage', MarkdownCodeCB, RocketChat.callbacks.priority.HIGH - 2, 'markdowncode');\n"]}