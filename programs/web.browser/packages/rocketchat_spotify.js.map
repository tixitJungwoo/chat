{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:spotify/lib/client/widget.js","meteor://ðŸ’»app/packages/rocketchat:spotify/lib/spotify.js"],"names":["Template","registerHelper","source","find","replace","option","hash","regex","RegExp","test","oembedBaseWidget","onCreated","data","meta","ogType","parsedUrl","host","_overrideTemplate","process","message","callback","_","trim","msgParts","split","index","length","part","undefined","codeMatch","match","Spotify","transform","urls","Array","isArray","concat","changed","msg","re","exec","filter","slice","value","path","map","escape","join","url","push","render","html","from","item","quotedSource","RocketChat","callbacks","add","priority","LOW","MEDIUM"],"mappings":"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","file":"/packages/rocketchat_spotify.js","sourcesContent":["Template.registerHelper('replace', function(source, find, replace, option) {\n\tif (option.hash.regex === true) {\n\t\tfind = new RegExp(find);\n\t}\n\treturn source.replace(find, replace);\n});\n\nTemplate.registerHelper('match', (source, regex) => new RegExp(regex).test(source));\n\nTemplate.oembedBaseWidget.onCreated(function() {\n\tif (this.data && (this.data.meta && /^(music\\.song|music\\.album)$/.test(this.data.meta.ogType)) && this.data.parsedUrl && this.data.parsedUrl.host === 'open.spotify.com') {\n\t\treturn this.data._overrideTemplate = 'oembedSpotifyWidget';\n\t}\n});\n\n","/*\n * Spotify a named function that will process Spotify links or syntaxes (ex: spotify:track:1q6IK1l4qpYykOaWaLJkWG)\n * @param {Object} message - The message object\n */\n\nconst process = function(message, source, callback) {\n\tif (_.trim(source)) {\n\t\t// Separate text in code blocks and non code blocks\n\t\tconst msgParts = source.split(/(```\\w*[\\n ]?[\\s\\S]*?```+?)|(`(?:[^`]+)`)/);\n\n\t\tfor (let index = 0; index < msgParts.length; index++) {\n\t\t\t// Verify if this part is code\n\t\t\tconst part = msgParts[index];\n\n\t\t\tif (((part != null ? part.length > 0 : undefined) != null)) {\n\t\t\t\tconst codeMatch = part.match(/(?:```(\\w*)[\\n ]?([\\s\\S]*?)```+?)|(?:`(?:[^`]+)`)/);\n\t\t\t\tif (codeMatch == null) {\n\t\t\t\t\tcallback(message, msgParts, index, part);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n};\nclass Spotify {\n\tstatic transform(message) {\n\t\tlet urls = [];\n\t\tif (Array.isArray(message.urls)) {\n\t\t\turls = urls.concat(message.urls);\n\t\t}\n\n\t\tlet changed = false;\n\n\t\tprocess(message, message.msg, function(message, msgParts, index, part) {\n\t\t\tconst re = /(?:^|\\s)spotify:([^:\\s]+):([^:\\s]+)(?::([^:\\s]+))?(?::(\\S+))?(?:\\s|$)/g;\n\n\t\t\tlet match;\n\t\t\twhile ((match = re.exec(part))) {\n\t\t\t\tconst data = _.filter(match.slice(1), value => value != null);\n\t\t\t\tconst path = _.map(data, value => _.escape(value)).join('/');\n\t\t\t\tconst url = `https://open.spotify.com/${ path }`;\n\t\t\t\turls.push({url, 'source': `spotify:${ data.join(':') }`});\n\t\t\t\tchanged = true;\n\t\t\t}\n\n\t\t});\n\n\t\t// Re-mount message\n\t\tif (changed) {\n\t\t\tmessage.urls = urls;\n\t\t}\n\n\t\treturn message;\n\t}\n\n\tstatic render(message) {\n\t\tprocess(message, message.html, function(message, msgParts, index, part) {\n\t\t\tif (Array.isArray(message.urls)) {\n\t\t\t\tfor (const item of Array.from(message.urls)) {\n\t\t\t\t\tif (item.source) {\n\t\t\t\t\t\tconst quotedSource = item.source.replace(/[\\\\^$.*+?()[\\]{}|]/g, '\\\\$&');\n\t\t\t\t\t\tconst re = new RegExp(`(^|\\\\s)${ quotedSource }(\\\\s|$)`, 'g');\n\t\t\t\t\t\tmsgParts[index] = part.replace(re, `$1<a href=\"${ item.url }\" target=\"_blank\">${ item.source }</a>$2`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn message.html = msgParts.join('');\n\t\t\t}\n\t\t});\n\n\t\treturn message;\n\t}\n}\n\nRocketChat.callbacks.add('beforeSaveMessage', Spotify.transform, RocketChat.callbacks.priority.LOW, 'spotify-save');\nRocketChat.callbacks.add('renderMessage', Spotify.render, RocketChat.callbacks.priority.MEDIUM, 'spotify-render');\nRocketChat.Spotify = Spotify;\n"]}