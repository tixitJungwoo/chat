{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/custom-sounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/permissions.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/models/CustomSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/publications/customSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/deleteCustomSound.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/insertOrUpdateSound.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/listCustomSounds.js","meteor://ðŸ’»app/packages/rocketchat:custom-sounds/server/methods/uploadCustomSound.js"],"names":["Meteor","startup","storeType","RocketChat","settings","get","RocketChatStore","RocketChatFile","Error","console","log","green","path","trim","RocketChatFileCustomSoundsInstance","name","absolutePath","self","WebApp","connectHandlers","use","bindEnvironment","req","res","params","sound","decodeURIComponent","url","replace","_","isEmpty","writeHead","write","end","file","getFileWithReadStream","setHeader","fileUploadDate","undefined","uploadDate","toUTCString","reqModifiedHeader","headers","Date","length","readStream","pipe","models","Permissions","createOrUpdate","addGroup","add","type","values","key","i18nLabel","enableQuery","_id","value","CustomSounds","tryEnsureIndex","findOneByID","options","findOne","findByName","query","find","findByNameExceptID","except","$nin","setName","update","$set","create","data","insert","removeByID","remove","_Base","publish","filter","limit","userId","ready","fields","extension","s","sort","filterReg","RegExp","escapeRegExp","methods","deleteCustomSound","authz","hasPermission","method","deleteFile","Notifications","notifyAll","soundData","insertOrUpdateSound","field","nameValidation","test","input","matchingResults","fetch","createSound","newFile","previousExtension","previousName","listCustomSounds","uploadCustomSound","binaryContent","contentType","Buffer","rs","bufferToStream","ws","createWriteStream","on","setTimeout"],"mappings":"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","file":"/packages/rocketchat_custom-sounds.js","sourcesContent":["/* globals RocketChatFileCustomSoundsInstance */\nMeteor.startup(function() {\n\tlet storeType = 'GridFS';\n\n\tif (RocketChat.settings.get('CustomSounds_Storage_Type')) {\n\t\tstoreType = RocketChat.settings.get('CustomSounds_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${ storeType }]`);\n\t}\n\n\tconsole.log(`Using ${ storeType } for custom sounds storage`.green);\n\n\tlet path = '~/uploads';\n\tif (RocketChat.settings.get('CustomSounds_FileSystemPath') != null) {\n\t\tif (RocketChat.settings.get('CustomSounds_FileSystemPath').trim() !== '') {\n\t\t\tpath = RocketChat.settings.get('CustomSounds_FileSystemPath');\n\t\t}\n\t}\n\n\tthis.RocketChatFileCustomSoundsInstance = new RocketChatStore({\n\t\tname: 'custom_sounds',\n\t\tabsolutePath: path\n\t});\n\n\tself = this;\n\n\treturn WebApp.connectHandlers.use('/custom-sounds/', Meteor.bindEnvironment(function(req, res/*, next*/) {\n\t\tconst params =\n\t\t\t{ sound: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')) };\n\n\t\tif (_.isEmpty(params.sound)) {\n\t\t\tres.writeHead(403);\n\t\t\tres.write('Forbidden');\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatFileCustomSoundsInstance.getFileWithReadStream(params.sound);\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\tlet fileUploadDate = undefined;\n\t\tif (file.uploadDate != null) {\n\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader != null) {\n\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\t\tif (fileUploadDate != null) {\n\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t} else {\n\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t}\n\t\tres.setHeader('Content-Type', 'audio/mpeg');\n\t\tres.setHeader('Content-Length', file.length);\n\n\t\tfile.readStream.pipe(res);\n\t}));\n});\n","Meteor.startup(() => {\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('manage-sounds', ['admin']);\n\t}\n});\n","RocketChat.settings.addGroup('CustomSoundsFilesystem', function() {\n\tthis.add('CustomSounds_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\ti18nLabel: 'FileUpload_Storage_Type'\n\t});\n\n\tthis.add('CustomSounds_FileSystemPath', '', {\n\t\ttype: 'string',\n\t\tenableQuery: {\n\t\t\t_id: 'CustomSounds_Storage_Type',\n\t\t\tvalue: 'FileSystem'\n\t\t},\n\t\ti18nLabel: 'FileUpload_FileSystemPath'\n\t});\n});\n","class CustomSounds extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('custom_sounds');\n\n\t\tthis.tryEnsureIndex({ 'name': 1 });\n\t}\n\n\t//find one\n\tfindOneByID(_id, options) {\n\t\treturn this.findOne(_id, options);\n\t}\n\n\t//find\n\tfindByName(name, options) {\n\t\tconst query = {\n\t\t\tname\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\tfindByNameExceptID(name, except, options) {\n\t\tconst query = {\n\t\t\t_id: { $nin: [ except ] },\n\t\t\tname\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t//update\n\tsetName(_id, name) {\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tname\n\t\t\t}\n\t\t};\n\n\t\treturn this.update({_id}, update);\n\t}\n\n\t// INSERT\n\tcreate(data) {\n\t\treturn this.insert(data);\n\t}\n\n\n\t// REMOVE\n\tremoveByID(_id) {\n\t\treturn this.remove(_id);\n\t}\n}\n\nRocketChat.models.CustomSounds = new CustomSounds();\n","Meteor.publish('customSounds', function(filter, limit) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tconst fields = {\n\t\tname: 1,\n\t\textension: 1\n\t};\n\n\tfilter = s.trim(filter);\n\n\tconst options = {\n\t\tfields,\n\t\tlimit,\n\t\tsort: { name: 1 }\n\t};\n\n\tif (filter) {\n\t\tconst filterReg = new RegExp(s.escapeRegExp(filter), 'i');\n\t\treturn RocketChat.models.CustomSounds.findByName(filterReg, options);\n\t}\n\n\treturn RocketChat.models.CustomSounds.find({}, options);\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tdeleteCustomSound(_id) {\n\t\tlet sound = null;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tsound = RocketChat.models.CustomSounds.findOneByID(_id);\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (sound == null) {\n\t\t\tthrow new Meteor.Error('Custom_Sound_Error_Invalid_Sound', 'Invalid sound', { method: 'deleteCustomSound' });\n\t\t}\n\n\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ sound._id }.${ sound.extension }`);\n\t\tRocketChat.models.CustomSounds.removeByID(_id);\n\t\tRocketChat.Notifications.notifyAll('deleteCustomSound', {soundData: sound});\n\n\t\treturn true;\n\t}\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tinsertOrUpdateSound(soundData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tif (!s.trim(soundData.name)) {\n\t\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field Name is required', { method: 'insertOrUpdateSound', field: 'Name' });\n\t\t}\n\n\t\t//let nameValidation = new RegExp('^[0-9a-zA-Z-_+;.]+$');\n\n\t\t//allow all characters except colon, whitespace, comma, >, <, &, \", ', /, \\, (, )\n\t\t//more practical than allowing specific sets of characters; also allows foreign languages\n\t\tconst nameValidation = /[\\s,:><&\"'\\/\\\\\\(\\)]/;\n\n\t\t//silently strip colon; this allows for uploading :soundname: as soundname\n\t\tsoundData.name = soundData.name.replace(/:/g, '');\n\n\t\tif (nameValidation.test(soundData.name)) {\n\t\t\tthrow new Meteor.Error('error-input-is-not-a-valid-field', `${ soundData.name } is not a valid name`, { method: 'insertOrUpdateSound', input: soundData.name, field: 'Name' });\n\t\t}\n\n\t\tlet matchingResults = [];\n\n\t\tif (soundData._id) {\n\t\t\tmatchingResults = RocketChat.models.CustomSounds.findByNameExceptID(soundData.name, soundData._id).fetch();\n\t\t} else {\n\t\t\tmatchingResults = RocketChat.models.CustomSounds.findByName(soundData.name).fetch();\n\t\t}\n\n\t\tif (matchingResults.length > 0) {\n\t\t\tthrow new Meteor.Error('Custom_Sound_Error_Name_Already_In_Use', 'The custom sound name is already in use', { method: 'insertOrUpdateSound' });\n\t\t}\n\n\t\tif (!soundData._id) {\n\t\t\t//insert sound\n\t\t\tconst createSound = {\n\t\t\t\tname: soundData.name,\n\t\t\t\textension: soundData.extension\n\t\t\t};\n\n\t\t\tconst _id = RocketChat.models.CustomSounds.create(createSound);\n\t\t\tcreateSound._id = _id;\n\n\t\t\treturn _id;\n\t\t} else {\n\t\t\t//update sound\n\t\t\tif (soundData.newFile) {\n\t\t\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ soundData._id }.${ soundData.previousExtension }`);\n\t\t\t}\n\n\t\t\tif (soundData.name !== soundData.previousName) {\n\t\t\t\tRocketChat.models.CustomSounds.setName(soundData._id, soundData.name);\n\t\t\t\tRocketChat.Notifications.notifyAll('updateCustomSound', {soundData});\n\t\t\t}\n\n\t\t\treturn soundData._id;\n\t\t}\n\t}\n});\n","Meteor.methods({\n\tlistCustomSounds() {\n\t\treturn RocketChat.models.CustomSounds.find({}).fetch();\n\t}\n});\n","/* globals RocketChatFileCustomSoundsInstance */\nMeteor.methods({\n\tuploadCustomSound(binaryContent, contentType, soundData) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-sounds')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tconst file = new Buffer(binaryContent, 'binary');\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatFileCustomSoundsInstance.deleteFile(`${ soundData._id }.${ soundData.extension }`);\n\t\tconst ws = RocketChatFileCustomSoundsInstance.createWriteStream(`${ soundData._id }.${ soundData.extension }`, contentType);\n\t\tws.on('end', Meteor.bindEnvironment(() =>\n\t\t\tMeteor.setTimeout(() => RocketChat.Notifications.notifyAll('updateCustomSound', {soundData})\n\t\t\t, 500)\n\t\t));\n\n\t\trs.pipe(ws);\n\t}\n});\n"]}